# Model development {#sec:model-dev}

\epigraph{``Everything must be made as simple as possible. But not simpler.''}{Albert Einstein}



```{r Setup, include=FALSE, results="hide", warning=FALSE}
opts_chunk$set(fig.path = "figures/", dev=c("cairo_pdf"), fig.pos='htbp', fig.width=5, fig.height=3.5, dpi=700, fig.show='hold', fig.lp="fig:", cache=FALSE, par=TRUE, echo=FALSE, results="hide", message=FALSE, warning=FALSE)

library(extrafont)
font_import(pattern="LinBiolinum")
```

The systems of urban resource management can be conceptualised as a network of processes which operate to meet consumer demand for goods and services. Upstream and downstream of these networks are the aggregate flows of inputs and wastes into and out of a city. Understanding what drives these aggregate flows is a key component of UM research, but -- as Chapter 2 argued -- the field has not yet produced a formal representation of how the network of processes relates to the overall flows. Understanding this is of particular interest to this thesis because of the intersectoral interactions and synergies (as defined by Chapter [TODO: cross-ref]) which present opportunities for and challenges to efficient resource provision, yielding environmental and economic benefits. A model that seeks understanding at this level could be considered a *highly integrated urban energy, water, and waste systems* optimisation model. This chapter takes this model from a concept to a formalised mathematical model.

Since modelling is a simplification of the real-world [TODO: cross-reference] , there will be inevitably be compromises in the performance of the model. This chapter explores these through three formulations (introduced in Section [TODO:]). The formulations are then applied to a case study which is followed by discussion on their performance given the compromises. This study leads to the selection of one of the models to be carried forward to a case study in Chapter [TODO: cross-ref chapter 6]. Given the novelty of this work, the case study is proposed as a 'benchmark' problem, with the formulations and data being made publicly available, so others can develop the model.

## Model performance and formulation

When introducing modelling in the literature review, care was taken to not overstate the capabilities of a model (Section [TODO: cross-ref]). Rather, it was noted that modelling provides an honest, scientific tool to help decision makers explore the realms of possibility concerning a complicated problem. Recognising that simplifications are inevitable leads to the understanding that there will be compromises with respect to a model's performance features of the model. Four such features are *fidelity*, *generality*, *tractability*, and *usability*.

Fidelity and generality are both functions of a model's representation of the real-world. The former measures how well a model describes reality [@McIntosh2012], and the latter corresponds to to the number of real world systems a model can be applied to @[Matthewson2008]. In relation to modelling undertaken here, fidelity would be a measure of how accurately the behaviour of a resource management process -- for example, a water pipe -- is represented by the model's mathematics[^pipe-flow]. Generality would measure to what extent the model's equations can be applied to multiple process types, for example both a water pipe, and an electrical cable. Tractability and usability refer to how the model is applied in practice: the former quantifies the amenability of the model to optimization techniques; while the latter measures the ease of model formulation for a particular case [@McIntosh2012].

[^pipe-flow]: The example of pipe flow is developed in Section [TODO: cross-ref].

These four features usually trade off against one another, which is the source of a model's compromise. Models that are more general will be lower fidelity, because they are not tailored to the specific details of a real-world [@McIntosh2012]. Models of higher fidelity are both less tractable and less usable because they encode real-world system in more detail, using more equations (to capture the detail), with more advanced mathematics; these models are more difficult to formalise, use, and solve. 

Moving to consider an optimisation model's mathematics in greater depth, recall from Chapter 1 that the equations of optimisation models are comprised of parameters and variables, where the values of parameters are fixed, and the values of the variables are chosen during the optimisation procedure. There are different forms of equations, and these different forms require their own  methods to solve. There are two broad categories of formulation: *linear* and *nonlinear*.

Linear programmes (LP) include many of the energy systems models (such as [TODO: cite examples]. In these models, variables are never multiplied or divided by one-another. A specific class of linear programmes are those where some variables must adopt integer values (which might be necessary to specify the number of resource management processes, for example); these are mixed-integer linear programmes (MILP). A reason that linear models are often lower fidelity is that very often, they are formulated with the express purpose of simplifying nonlinear realities.

<!--
 The case study in this chapter will test three different formulations, and their performance will be assessed according to these four features (with the results in Section [TODO:]).
-->

*Nonlinear programmes* (NLP) have equations in which variables are multiplied by one another. Again, these models can also have integer variables and are known as *mixed-integer non-linear programmes* (MINLP). For this reason, NLP are often used to model water management problems, because hydraulic equations which include the product of two or more variables\footnote{To take one example (which is considered in more detail in Section [TODO:]), the potential energy of a mass of water due to its elevation is given by $\mbox{mass} \times \mbox{gravity} \times \mbox{elevation}$, where both mass and elevation might be variables.} [TODO: list examples from the spreadsheet]. Nonlinearity may also exist in water management problems in order to model water contamination levels[^contamination-model] [TODO: list examples from the spreadsheet]. These problems can be solved using the nonlinear programming methods [TODO: examples of NLP and MINLP], but these are computationally expensive, so heuristics are sometimes used to obtain near-optimal solutions with less effort. These heuristics often start with a possible set of variable values, and the imitate processes in nature to modify these solutions until a near-optimal solution is found. Examples include genetic algorithms which follow evolutionary procedures [TODO: example]; and particle swarm optimisation, which mimic the flocking of birds [TODO: example]. Such heuristic approaches are an attempt to get around issues of tractability, without sacrificing fidelity. However, usability may be hampered, for two reasons: first, the formulation is still detailed; and second, heuristic solutions usually require bespoke approaches.

[^contamination-model]: Consider two bodies of water, $x$ and $y$, with volumes $V_x$ and $V_y$ (L) respectively, and contamination levels of $c_x$ and $c_y$ (mg/L) respectively. If these two bodies mix, the new contaminant concentration is given by $(V_x c_x + V_y c_y)/(V_x + V_y)$. If both volume and contaminant concentration are variables, then this model is nonlinear.


<!--
These related considerations of performance features and formulations affect the extent of a model's application, the results returned, and the practicalities of its everyday use. Thus the rest of the chapter explores these, before proposing a formulation for a model new to the field of urban metabolism.
-->

## Benchmark problems

There are many different ways to model urban resource management systems, and the considerations of linearity and performance features raised above suggest that there might well be different outcomes to such models, each with their own set of advantages and disadvantages. Because of this, this chapter will propose three different formulations (two linear, and one nonlinear) which vary in their fidelity, generality, tractability and usability.

These three formulations will be applied to the same case study to provide a fair test by which to compare the different approaches. This case study will therefore provide a 'benchmark' study.  In computing, a benchmark is defined as "A program or set of programs used as a standard against which the performance of other programs (or computer systems running them) is compared or evaluated ... " [@OED-benchmark2016, Draft Additions October 2001]. Benchmarking assesses a model's quality by providing "a systematic mechanism for comparing computational tools" [@Farmani2003, p.250] through the use of a test case, on which all computational tools can be applied. 

<!--
In order to "assess the relative performance of an object" [@Gangl2016, p.19] (e.g. a numerical solver)

using test problems containing "features common to engineering optimization problems" [@Chase2016, p.14]

parameter estimation in biological systems found through optimisation [@Villaverde2015]

system compared piecewise linear approximations+MILP, search methods, and 'Transformation using ceiling function X DE';

Particularly common in optimisation problems. They should be: easy to use and complete (so users don't have to go elsewhere for data or instruction). For example, Exeter's online library of benchmark problems [@Farmani20013].
-->

Benchmark problems can be used to find the best algorithm to tackle problems belonging to a particular field, for example, standard problems of mechanics [@TechComm2016, @Schiehlen2015], finite element analysis [@Sze2004, @Agrawal2005], Maxwell's equations of electromagnetism [@Gangl2016], and fluid mechanics [@Vuik2004, @Bathe2007].

Benchmarking problems also exist in fields more closely related to this thesis. In the energy sector, there are benchmarking problems for energy storage [@Salas2013] problems, plant location problems [@Sabolev2013], and plant operation problems [@IEEJ2015]. This third example compared different ways to approximate using equations -- a task not too dissimilar that undertaken in this chapter. In the water sector, there are benchmark problems to test the different algorithms applied to the optimisation of distribution networks [@Wang2015, @Farmani2003, @Wu2001]) and the quality of managed water [@Piratla2015].
<!--
http://castlelab.princeton.edu/Papers/Jiang-ComparisonADPonBenchmarkEnergy-DoesAnythingWorkJune52014.pdf -- note conslusions: no methods suitable, so new theory/methodology is required].
-->

The benchmarking study in this chapter will be the first application of a model which considers the highly integrated management of energy, water and waste systems. This novelty warrants that the formulations and data can be made available to the wider research community, who can work do improve upon the models develope here.
<!--
- Benchmarking model of default probabilities of listed companies
  	- http://papers.ssrn.com/sol3/papers.cfm?abstract_id=982984
- Benchmarking default prediction models: pitfalls and remedies in model validation
	- http://www.rogermstein.com/wp-content/uploads/BenchmarkingDefaultPredictionModels_TR030124.pdf	
- Evolutionary computation benchmark problems
  	- http://www.cs.cmu.edu/afs/cs/project/jair/pub/volume24/ortizboyer05a-html/node6.html
- A generalized appraoch to construct benchmark problems for dynamic optimization:
  	- http://www.cs.le.ac.uk/people/sy11/Papers/SEAL08_3.pdf
- A benchmark study of optimization search algorithms
  	- http://www.redcedartech.com/pdfs/SHERPA_Benchmark_0110.pdf
- A library of problems:
  	- http://iftomm-multibody.org/benchmark/browse/ 
	- Example problems: flyball governor, uncontrolled bicycle, dynamic gait analysis, 
- PROBEN1 -- A set of neural network benchmark problems and benchmarking rules
- Popular benchmark problems for geometric nonlinear analysis of shells:
  	- http://www.sciencedirect.com/science/article/pii/S0168874X0300218X
- Some benchmark problems in electromagnetics
  	- http://www.numa.uni-linz.ac.at/Teaching/Bachelor/oberndorfer-bakk.pdf
	- "The purpose of a benchmark is to assess the relative performance of an object."
- Benchmark problems for incompressible fluid flows with structural interactions
  	- http://web.mit.edu/kjb/www/Principal_Publications/Benchmark_Problems_for_Incompressible_Fluid_Flows_with_Structural_Interactions.pdf
- BioPreDyn-bench: a suite of benchmark problems for dynamic modelling in systems biology
  	- http://www.ncbi.nlm.nih.gov/pubmed/25880925
- Robust control design for a benchmark problem
  	- http://deepblue.lib.umich.edu/bitstream/handle/2027.42/76996/aiaa-20949-475.pdf?sequence=1
- Benchmark problems from vehicle dynamics
  	- http://link.springer.com/article/10.1007/s12206-015-0504-4#page-1
- Discrete location problems: benchmark library
  	- http://www.math.nsc.ru/AP/benchmarks/english.html
	- E.g. simple plant location problem
- Benchmark structural control problem for seismically excited highway bridge
  	- http://www-ce.engr.ccny.cuny.edu/People/Agrawal/Highway%20Benchmark%20Problem.htm
- Two-objective design of benchmark problems of a water distribution system via MOEs: Towards the best-known approximation of the true pareto front
  	- http://ascelibrary.org/doi/abs/10.1061/(ASCE)WR.1943-5452.0000460
- Non-symmetric benchmark problem:
  	- http://ta.twi.tudelft.nl/nw/users/vuik/software/laplace/problem.pdf
  	- Navier-Stokes
- Energy storage benchmark problems
  	- http://castlelab.princeton.edu/Datasets/Time-dependent_storage/readme.pdf
- A comparison of approximate dynamic programming tecnhiques on benchmark energy: does anything work?
  	- http://castlelab.princeton.edu/Papers/Jiang-ComparisonADPonBenchmarkEnergy-DoesAnythingWorkJune52014.pdf
- Optimization benchmark problem for energy plant operational planning problem
  	- http://www.ssl.nd.chiba-u.jp/~okamoto/BP-IA/en/P1.html
- Waste collection vehicle routing problem with time windows:
  	- http://www.sciencedirect.com/science/article/pii/S0305054805001322
- Benchmark problems for repository siting models
  	- http://www.osti.gov/scitech/biblio/6614989
	- Nuclear waste storage
- An efficient variable neighborhood search heuristic for very large scale vehicle routing problems
  	- http://www.sciencedirect.com/science/article/pii/S0305054805003394
- A new evolutionary approach to cutting stock problems with and without contiguity
  	- http://www.sciencedirect.com/science/article/pii/S0305054801000399
- Nonnparametric input estimation in physiological systems: Problems, methods, and case studies
	- http://www.sciencedirect.com/science/article/pii/S0005109896002543
- A handbook of industrial ecology
  	- http://evirtual.uaslp.mx/Ambiental/PyGAmbiental/Biblioteca/Handbook_Industrial_Ecology_2002.pdf#page=135
	- 'Benzene production: a benchmark multi-objective example' (p.127)
- Industrial and ecological cumulative exergy consumption of the United States via the 1997 input-output benchmark model
- Competent genetic-evolutionary optimization of water distribution systems
  	- http://ascelibrary.org/doi/abs/10.1061/(ASCE)0887-3801(2001)15:2(89)
- A modified shuffled from-leaping optimization algorithm: applications to project management
  	- http://www.tandfonline.com/doi/full/10.1080/15732470500254535#abstract
	- well-known functions (the F8 and EF10 function, which have known global optima, testing a "modified shuffled frog-leaping optimization algorithm")
- Evolutionary multi-objective optimization of the design and operation of water distribution network: total cost vs. reliability vs. water quality
	- http://www.iwaponline.com/jh/008/jh0080165.htm
- Optimization of water distribution network design using differential evolution
- Benchmark problems for design and optimisation of water distribution systems
  	- https://books.google.com/books?hl=en&lr=&id=SCUT4QDVkJEC&oi=fnd&pg=PA249&dq=benchmark+problems+AND+water+management&ots=gGB3EhNLBD&sig=qV-J7mZdEturBGoZE9lJCVkrF2U#v=onepage&q=benchmark%20problems%20AND%20water%20management&f=false
	- Already referenced?
-->

## Tat Hamlet case study

The case study chosen for the benchmarking problem is that of Tat Hamlet, a village in Vietnam. Fieldwork conducted in 2001 led to reports on the village's material and energy flows and socioeconomic characteristics [@Schandl2006, @Heezen2004]. Following this fieldwork, researchers have explored features of Tat's metabolism, including analysis of the village's livestock development strategies [@ThanhLam2010], and the socioeconomic organization and origins of the material flows [@TerryRambo2001, @Hobbes2007], making Tat Hamlet a known case study within the UM literature. In this chapter, Tat will be used as a benchmarking study to test the three model formulations, using data from the material flow and energy flow studies.

Tat has 105 households of an average size of 4.4 people, covering 69 acres of farmland. The village does have small shops and education functions, but its main activity is agriculture, with rice cultivation (where paddy fields are irrigated by a small river), swidden cultivation, and biomass (timber, bamboo shoots, cassava roots) collection from a forest. Some agricultural products are sold to external traders, though most remain in the village. About 80 of the households own their own livestock (including chickens, dogs, buffalo, and cows), and most households have their own ponds for aquaculture, such that the village produces most of its own meat, dairy products, animal manure and green manure. Water can be piped to homes for drinking, household use, and for washing livestock. Aggregate metabolic flows into the village comprise rainfall, electricity from the grid, construction materials, fossil fuels (such as gasoline for motorbikes, and petroleum lighting), and a small amount of vegetable and meat imports. Metabolic flows out of the village include household and agricultural wastes, incineration products, fossil-fuel emissions, and biomass which is sold.

[TODO: Summary diagram]

The small size of Tat serves to make the benchmark problem user-friendly because the problem can conceptualised in a diagram on a single page of A4. The village's features described above will be used to define the village's demands for goods and services, and the network of resources and processes which will meet this demand. The models will compute how Tat can meet demands for goods and services at the lowest cost, using the village's resource management processes. Goods and services include food, water and energy, and resource management processes include everything from small domestic stoves to agricultural activities.

To construct the problem, data from the literature will be used to derive resource demands, and to select and define the behaviour of the resource management processes. However, to define a benchmark problem that is both user-friendly, and at the same complicated enough to test the different formulations, various adjustments are made, in the form of simplifications, assumptions, and additions (outlined in Appendix [TODO: cross-reference]; these are justified on the basis that this the end-goal of the benchmarking is to identify the best formulation, rather than to improve Tat's metabolism. The adjustments achieve a both simplicity in understanding the model, and yet retain enough complexity in order to suitably test the formulations. This benchmarking also demonstrates how one can formulate a problem from real world data.
<!--
The studies in the literature do not comprehensively all the necessary information to do this, therefore we have consulted studies of other similar contexts, so we an create a plausible network of resources and processes[^tat-context].
-->

### Conceptualising Tat Hamlet's resource management

The information from the literature and the adjustments provide a starting point to conceptualise Tat's means of resource management. This is partly visualised in Figure \ref{fig:tat-16}, which shows 27 resources managed by 16 conversion processes. The figure also indicates which resources are demands, and which resources can be imported into the village. (It is assumed any resource can be exported.) Not represented here are the four zones into which Tat is split (arbitrarily for the purposes of this chapter, in order to test how the formulations deal with spatial disaggregation), between which resource demands are equally split; The models will be free to locate processes in any of them, but there will be limits imposed as to which zones can import resources, thus to meet demand, there must be the transport of resources from one zone to another (via transport processes, also unrepresented on this diagram).

\begin{figure}
	\centering
%	\begin{spacing}{1.0}
%	\sffamily
%	\resizebox{\columnwidth}{!}{\input{05_model-development/tat-16.pdf_tex}}
	\includegraphics[width=\textwidth]{05_model-development/tat-network-full.pdf}
%	\end{spacing}
	\caption{Complete network of the resources and sixteen conversion processes in the Tat Hamlet case study. Resource demands are shown in \textbf{bold}, while resources which can be imported from outside of the system are indicated by a *. Details of transport processes are provided in Table [TODO:].}
	\label{fig:tat-16}
\end{figure}

[TODO: Check if there are limits on the numbers of certain processes, e.g. dam, and use another diagram to show zones and transport processes.]

<!--
and that if a resource can be imported, it can be imported to any zone, with the exception of water, which can only be imported into one zone (resources can be exported from any zone).
-->

The figure shows seven resource demands for goods and services: water, hot water, electrical appliance use, space heating, cooked meat, cooked fish and cooked vegetables. Demands for water depend upon treatment and pumping processes. Within a household, hot water space heating, and food demands are met by combustion and cooking processes, with food also depending on processes 'upstream' of a house, namely aquaculture, agriculture and livestock, which depend upon water treatment, irrigation, and machinery processes further upstream still. Electricity can only be imported from the grid. Exact demand quantitaties are given in Appendix [TODO: Table \ref{tab:tat-resources}].

<!--
#### Water

- 696 l/day for 20 houses
- = 696 x 1 kg/day for 20 houses
- = 696 x (105/20) kg/day for all 105 houses
- = 3654 kg/day for all 105 houses
- = 3654 / 1000 t/day for all 105 houses
- = 3.65 t/day for all 105 houses
- = 3.65 x 365 t/yr for all 105 houses
- = 1333.71 t/yr for all 105 houses
- Assume this is split equally between cooking, domestic hot water, and other (445 t/yr, each way)

#### Electricity

- Total electricity imports = 31.7 GJ/year
- Assume equally split between domestic appliances, agriculture, and water pumping (in reality, the amount required for pumping will depend on the amount of water pumped, and the distance it's pumped)
- Domestic electricity = 10.6 GJ/year. Work backwards, and assume 60% efficiency of domestic appliances, thus:
- DOMESTIC APPLIANCE DEMAND
- = 0.6 x 10.6
- = 6.34 GJ/year
- Agricultural electricity = 10.6 GJ/year. Work backwards, and assume 50% efficiency of agricultural machinery, thus:
- AGRICULTURAL APPLIANCE DEMAND
- = 0.5 x 10.6
- = 5.3 GJ/year
- PUMPING DEMAND: to be calculated by pumping needs, f(volume, distance)

#### Waste generation

- Total the waste from house = -(49 + 9.4 t/yr)
- Waste, as the remaining 'land products' from agriculture
- = - (430 - (18.6 + 346))
- = -65.4 t/yr
- TOTAL WASTE GENERATION = -79.7 t/yr

#### Food

- MEAT
- = livestock + imports
- = 2.6 + 7.2
- = 9.8 t/yr

- VEG
- = agriculture + aquaculture
- = bamboo + other + aquaculture
- = 60 + 408 + 4.9
- = 472.9 t/yr

- FISH
- = straight from aquaculture
- = 0.27 t/yr

#### Demands and process performance derived from firewood

- Starting with a total firewood demand of 530 t/yr (from bamboo and other agricultural products). We assume firewood usage is split equally between cooking, heating and domestic hot water (177 t/yr each way), and provides the 5375.6 GJ/year of heat split equally between cooking, space heating, and domestic hot water (1792 GJ/yr each way), thus:

- For water, we assume that water demand (1333.71 t/yr) is split equally between cooking, hot water and other water:
- = 444.6 t/yr

##### Cooking

- Derive from a ratio of wood:meat, where meat = 9.8 t/yr
- = 177 / 9.8
- = 18 tonnes per year
- firewood in = 177 t/yr
- heat out = 1792 gj/yr
- water in = 444.6 t/yr

##### Space heating

- firewood in = 177 t/yr
- heat out = 1792 gj/yr

##### Domestic hot water

- firewood in = 177 t/yr
- cold water in = 444.6 t/yr
- heat out = 1792 gj/yr
- hot water out = 444.6 t/yr

##### Other water demand

- 444.6 t/yr


With these assumptions and simplifications, we can now go on to define a set of processes which meet demands, using the available resources. We do this by disaggregating the four main sectors, so as to increase the number of processes in our model. This is largely an academic exercise, so we can investigate the effect of increasing the number of processes, on the performance of each model formulation, nevertheless, by using data which might reflect a real scenario (rather than idealised "spherical chickens in a vacuum").


#### Agriculture

We will model this as a single process.

- WATER INPUTS 
- = annual rainfall x paddy area x swidden area
- = 1840  mm/yr x 105 houses x [(59% + 26%) of 1160m2 + (59% + 5%) of 1770m2]
- = 1840  mm/yr x 105 houses x [0.85 x 1160m2 + 0.65 x 1770m2]
- = 1840  mm/yr x 105 houses x 1746.5m2
- = 1.840 m/yr x 105 houses x 1746.5m2
- = 3213.56 m3/yr
- = 3214 t/yr
- MANURE
- = 60 t/yr
- ELEC based on our assumption
- = total / 3
- = 31.7 GJ/yr / 3
- = 10.6 GJ/yr
- = 10.6e3 MJ/yr
- GREEN MANURE
- = 9.1 t/yr
- BIOMASS MEDIUM (assume half of the total)
- = 0.5 x (bamboo + other)
- = 0.5 x (95 + 435)
- = 265 t/yr
- BIOMASS WET (assume half of the total)
- = BIOMASS MEDIUM
- = 265 t/yr
- FISH FEED
- = 346 + 18.6
- = 364.6 t/yr
- VEG RAW
- = bamboo for food + veg
- = 60 + 408
- = 468 t/yr
- MAIN OUPUT = VEG

[TODO: add diagram]

#### Agricultural machinary

- We've already determined that it will one one-third of all electricity = 10.6 GJ/yr
- The amount of diesel to supply this electricity assuming:
  	- diesel density = 0.8 kg/L
  	- diesel energy density = 35 MJ/L (http://hypertextbook.com/facts/2006/TatyanaNektalova.shtml)
  	- Generator efficiency = 43% (http://www.slideshare.net/eecfncci/energy-efficiency-in-diesel)
- Mass = 
- = Efficiency x Mass x energy density = 10.6 GJ
- = 0.43 x (N kg x 0.822 kg/L) x 35 MJ/L = 10.5e3 MJ
- N = 848 kg
- N = 0.85 t
- MAIN OUTPUT = ELEC, thus RATE = 10500

#### Dam

- Assume WATER IN = WATER OUT
- Assume 10m drop in height across the dam
- Thus ELEC generated
- = mgh
- = 1000 kg x 9.81 m/s2 x 10 m
- = 98.1 MJ
- MAIN OUTPUT = ELEC

#### Domestic appliances

- We've already stated that 10.6 GJ/year will be used, with appliances of 60% efficiency, thus:
- ELEC = 10.6e3 MJ/yr
- APPUSE
- = 0.6 x10.6e3 MJ/yr
- = 6.34e3 MJ/yr
- MAIN OUTPUT = APPUSE, thus rate = 6341 MJ/yr

#### Aquaculture

We will model this as a single process.

- GREEN MANURE
- = 9.1 t/yr
- FISH FEED
- = 346 + 18.6
- = 364.6 t/yr
- MANURE
- = 210 t/yr
- VEG
- = 4.9 t/yr
- FISH
- = 0.27 t/yr
- MAIN OUTPUT = FISH, thus rate = 0.27 t/yr

[TODO: add diagram]

#### Livestock

We will model this as a single process, aggregating inputs and outputs of all livestock types into a single process.

- VEG sums to 428.4 t/yr
- WATER
	- Per day, 2 pigs require 60 l (cleaning) + 10 l (drinking) = 35 l per pig
- Total livestock
- = 107 buffalo + 138 cow + 2114 pig + 1600 chicken + 46 dog + 8 goat + 65 duck
- Assume buffalo, cow, pig and goat are equivalent to pigs (total = 2367)
- Assume chicken, goat and duck are equivalent to 20% of a pig (total = 20 % x 1711 = 342)
- Thus WATER = 35 l x (2367 + 342)
- = 94815 l
- = 94.8 t/yr
- MANURE given as 270 t/yr
- MEAT given as 4.6 t/yr
- MAIN OUTPUT = MEAT_RAW, thus rate = 4.6 t/yr

[TODO: add diagram]

#### Irrigation from source

- Given as a 1:1 mapping between source and irrigation

#### Domestic heating

- Splitting firewood equally between cooking, heating, and domestic hot water, and using domestic heating firewood to provide the heat for both heating and domestic hotwater:
- FIREWOOD
- = (2/3) x 530 t/yr
- = 353 t/yr
- Splitting total heat equally between cooking, heating, and domestic hot water, and using domestic heating heat to provide the heat for both heating and domestic hotwater:
- HEAT
- = (2/3) x 5375.6 GJ/yr
- = 3584e3 MJ/yr
- MAIN OUTPUT = HEAT_DOMESTIC, thus rate = 3584000 MJ/yr

#### Domestic hot water

- HEAT calculated Using half of the heat provided by domestic heating
- = 0.5 x 3584e3
- = 1792e3 MJ/yr
- WATER
- = 445 t/yr (based on our assumption of an equal split each way)
- MAIN OUTPUT = HOTWATER_DOMESTIC, thus rate = 446 t/yr

#### Stove heat production

- HEAT output is one-third of the 5375 GJ/yr
- = 1792e3 MJ/yr
- FIREWOOD used is one-third of the total domestic demand
- = 177 t/yr
- MAIN OUPUT
- = heat_stove
- = 1792000 MJ/yr
- [NOTE: If we divide this over 105 properties, the model is infeasible. But we could see if this is solved by fixing the num_process parameter at 105]

#### Cooking

- WATER
- = 445 t/yr
- HEAT
- = the remaining third of the 5375.6 GJ/yr
- = 1792e3 MJ/yr
- VEG
- = bamboo + other
- = 60 + 408
- = 468 t/yr
- MEAT
- = farmed + imported
- = 4.6 + 2.6
- = 7.2 t/yr
- FISH
- = 0.27 t/yr
- MAIN OUTPUT = MEAT_COOKED, thus rate = 7.2 t/yr

#### Pump

- Assumes a 10 m increase in head, so for 1 tonne of water:
- ELEC = mgh
- = 1 x 9.81 x 10
- 98.1 MJ/yr

#### Water treatment (livestock)

- Assume 50:50 split between clean water and waste water

#### Water treatment (domestic)

- Assume 1:0.25 split between clean water and waste water

#### Biomass (wet) drying

- No loss. Just time for the biomass to dry to become firewood

#### Biomass (medium) drying

- No loss. Just time for the biomass to dry to become firewood

#### Domestic sector

We will consider this as a few sectors:

- Domestic appliances which use electricity (e.g. lighting)
- Cooking
- Space heating
- Domestic hot water

#### Other processes

We will add other processes which interact between the processes.

- Biomass drying (for wet biomass -- justified on the basis that the MFA includes values for water loss from biomass. Dry biomass would be required for some purposes, such as fuel.)
- Biomass drying (for medium-wet biomass)
- Agricultural machinery (which will use petrol to generate power)
- Water treatment (to bring water up to suitable quality for livestock)
- Water treatment (to bring water up to suitable quality for domestic use) -- these allow us to define water with different contamination qualities
- Dam (to generate some electricity, and allow us to define water with different energy head qualities)
-->

[^tat-context]: Examples include @Alam1997 and @Tripathi2001.

<!--
[TODO: Move to the appendix]

-->

## Deriving three optimisation models

As the conceptualisation above indicates, the highly integrated resource management model should be able to consider a city as comprised of a number of zones, for which can be specified resource demands, and which contain the conversion processes which manage resources. These zones will be connected to one another via transport processes. The model should also be able consider that resources will need to be imported into the village (either to meet a demand directly, or to feed a process), and resources which neither meet a demand nor feed a process (excess waste heat, perhaps), can be exported from the area. Added to this is also the need for a temporal component, such that resource demands can vary with time, along with the schedule of resource imports and exports, and process operations.

An existing model which can accomplish these things -- specifically for that energy sector -- has been developed by @Keirstead2013a. This is a MILP model which chooses the optimal mix of processes, and schedule of process operations and resource imports and exports to meet spatially and temporally defined demands for heating, cooling and electricity. Using the terminology of Section \ref{sec:optim-model-overview}, this is a city-scale model, not integrated (because it only optimises the energy sector), and high-level (because it does not compute detailed design of the optimised energy system, but rather focusses on allocating resources to the right place, at the right time, in their right quantities).

To model the processes which convert resources, @Keirstead2013a is based upon the engineering State-Task Network (STN) model of @Kondili1993, in which processes ('tasks') convert materials from one 'state' to another (Figure \ref{fig:STN}). Keirstead's model applies this model's principles to urban energy systems using what they term a Resource-Technology Network (RTN), developing a model which chooses the mix of processes using available resources to meet demand for heat and electricity -- an example is given in Figure \ref{fig:Keirstead-RTN}. While, on this thesis' definitions (Chapter 2), Keirstead's [TODO: update] model is categorised as having no system integration, the STN representation is highly generalised (i.e. all conversion processes are represented by the same type of equation); this makes the formulation extendable to other types of resources and processes. The urban energy systems model has two types of processes: those that convert resources (such as a wastewater treatment plant), and those that transport them (such as a pipeline). 

\begin{figure}
	\centering
	\includegraphics[width=0.8\textwidth]{05_model-development/STN-Kondili-et-al.png}
	\caption{A diagram of an STN representation of a chemical engineering system, taken from \citet[p.241, Figure 1b]{Kondili1993}. The circles represent resources (`states'), while the rectangels represent the `tasks' which convert a resource from one state to another. The paper then goes on to turn this concpetualisation into a MILP which can compute an optimal operation schedule for a chemical plant which maximises profits.}
	\label{fig:STN}
\end{figure}

\begin{figure}
\input{05_model-development/BiomassRTN.tex}
\caption{Example of an urban energy system optimised by the MILP model of [TODO: Keirstead reference], which shows resources (circles) and conversion processes (rectangles) -- note this diagram does not show transport processes.}
\label{fig:Keirstead-RTN}
\end{figure}

A feature of @Keirstead2013a's model is that it is spatially and temporally disaggregated. The urban area is divided up into zones which can each have their own energy demands and set of technologies. Moreover, these demands can be different for each timestep (perhaps representing broad differences such as seasonality, or smaller differences on an hour-by-hour basis). Demand in a zone can be met by a combination of three means: (i) being imported from outside the urban area; (ii) being produced in the zone by a conversion process; (iii) being transported into the zone from another by a transport process. (For 'negative' demands, i.e. the demand for wastes to be removed, these means become (i) exports, (ii) consumption, and transport from the zone.) These are brought together in the model's main equation, which is a balance of resources in each zone at any moment in time:

\begin{align}
\begin{split}
&\mbox{Imports} + \mbox{Net inflow from other zones} + \mbox{Net production of resource by processes}\\
&= \mbox{Demand} + \mbox{Exports}
\label{eq:balance}
\end{split}
\end{align}

[TODO: express this in our notation, then in next paragraph, use notation to highlight the difference between the models. Then possibly join the next two paragraphs]

Demand (for each resource, in each zone and each time period) is a parameter given to the model, with the other terms being variables whose values are selected by the optimisation process. The import and export variables can be limited using constraints, while the net inflow and net production variable are computed using equations which model the behaviour of conversion and transport technologies. The overall goal of the programme is then to choose variable values which minimise some objective (such as cost or emissions) which is formulated from the programme's parameters and variables -- examples are given in Section [TODO: cross-reference to section on objectives].

[TODO: add illustrative diagrams, e.g. for the processes, and the zones]

The next three subsections specify three different model formulations based on @Keirstead2013a. They are each based on the resource balance, however they differ in the way that they model the conversion [TODO: and transport?] processes (in other words, how the variable $G_{prz}$) is defined), varying in their fidelity, generality, tractability, and usability:

\begin{description}

\item [Null model] This formulation is very similar to the MILP urban energy systems model, only it is applied to a broader set of resources and processes, to incorporate the water and waste sectors. The purpose of this model is to investigate what can be achieved for as little computational effort as possible. 
\item [Processes resources and qualities model (PRaQ)] This formulation also linear, and is in many ways similar to the null model, but it develops it to use a more sophisticated definition of resources, in which a resource can have multiple properties ('qualities') attributed to it. For example, water can have both a mass and an energy head. This means that processes can be defined to require (and produce) resources of particular qualities, e.g. a dam needs not just a sufficient mass of water, but a sufficient mass of water at a required energy head. This more detailed representation of resources can more accurately characterise the properties of a system's resource, and the transformations it undergoes during a process (e.g. as water passes through a dam, its mass remains the same, but its quantity changes). In practice, this requires defining extra parameters and variables in the model, and inserting some additional equations. 
\item [Nonlinear (NL)] This formulation allows nonlinear relationships between the resource flows into or out of a process.
\end{description}

Figure \ref{fig:evolution} shows how the three formulations are related both to the original urban energy systems model, and each other. Each formulation, in theory, increases its fidelity relative to the preceeding model: PRaQ increases in fidelity with respect to resources; and NL increases it with respect to processes too. However, this comes at a cost to generality because the PRaQ and NL formulations require more customisation of the data and equations. [TODO: Is this better in the discussion section? Add comments on] The differences between the formulations can be illustrated with reference to the example of the pipe and dam system show in Figure \ref{fig:pump-dam-example} which represents conversion and transport processes, and further explained in [TODO: cross-ref the tcolorbox]. For the purposes of simplification, the model formulations below have not been defined temporally. Model objective functions are also not defined with the model constraints -- instead, Section \ref{sec:model-objs} provides an overview of the sorts of objectives which could be used with any of the formulations.

\begin{figure}
	\centering
%	\begin{spacing}{1.0}
%	\sffamily
%	\resizebox{\columnwidth}{!}{\input{05_model-development/model-family.pdf_tex}}
	\includegraphics[width=0.7\columnwidth]{05_model-development/model-relationships.pdf}
%	\end{spacing}
	\caption{The relationship of this chapter's formulations to each other and the urban energy systems model of \citet{Keirstead2013a}.}
	\label{fig:evolution}
\end{figure}

\begin{figure}
	\centering
	\begin{spacing}{1.0}
	\sffamily
	\resizebox{\columnwidth}{!}{\input{05_model-development/pipe-dam-example.pdf_tex}}
	\end{spacing}
	\caption{An example to illustrate the difference between model formulations. There are two zones. Zone 2 has an electricity demand which can be met by a dam (a conversion process), also in zone 1. However, the water must first be pumped (via the pump -- a conversion process in zone 1) and transported to zone 2 via a pipe (transport process).}
	\label{fig:pump-dam-example}
\end{figure}

\begin{figure}
	\centering
	\includegraphics[width=0.8\textwidth]{05_model-development/pipe-dam-network.pdf}
	\caption{An RTN representation of Figure \ref{fig:pump-dam-example}. The electricity (E) required by the pump can be imported from outside the system; the amount required depends on the mass of water (W) to be pumped, and the elevation to which it needs pumping. The dashed arrow indicates that the electricity in Zone 2 is a demand.}
	\label{fig:pump-dam-RTN}
\end{figure}

\clearpage
\begin{tcolorbox}
For the pipe-dam example of Figures \ref{fig:pump-dam-example} and \ref{fig:pump-dam-RTN}, the models need to calculate the pumping energy and water volumes required at point A to raise the water to a sufficient height at point B, that will allow the dam to generate enough electricity to meet demand at point C. This box expresses this problem using equations of fluid mechanics, before showing how it would be modelled by the three formulations. The starting point is to use the Bernoulli equation, which states that along a streamline of fluid of density $\rho$, energy is conserved:

\begin{align}
\frac{P}{\rho g} + z + \frac{v^2}{2g} = \mbox{constant}
\end{align}

where at a chosen point $P$ is the water's pressure, $z$ is it's elevation with respect to a reference, and $v$ is it's velocity ($g$ is the constant of acceleration due to gravity).

First, consider the water flow from A (zone 1) to B (zone two) via the combination of a pump and a pipe. The pump provides the energy to raise the water's elevation and has an electrical efficiency of $\eta^{pump}$. This energy includes that which is required to overcome the energy loss due to friction. Typically this friction loss is defined as a function of the pipe's length $l$ and diameter $D$ as $\mbox{friction loss} = f_D(l/D)(v^2/2g)$ (where $f_D$ is the Darcy Friction Factor). It is also assumed that $P_1=P_2$ and that $v_1=v_2=v$, and that the datum is measured from A and C (which are at equal height), thus $z_A=z_B=0$. Finally, the models formulated later work with mass ($m$) and energy balances, thus it is convenient to multiply each term by $mg$. The resulting equation gives the water's energy at points A and B expressed in terms of mass:

\begin{align}
%z_A  + \eta^{pump} \frac{\mbox{pump energy}}{\rho V g}  = z_B + F \frac{l}{D} \frac{v^2}{2g}
\eta^{pump} (\mbox{pump energy})  = m \left( gz_B + F \frac{l}{D} \frac{v^2}{2} \right) 
\end{align}

Second, consider the flow across the dam, between $B$ and $C$. Using the same assumptions as above, and defining the dam with an electrical generation efficiency, $\eta^{dam}$, and again multiplying through by $mg$, the relationship of water input attributes to the dam's electrical output is:

\begin{align}
mgz_B = \eta^{dam} (\mbox{elec gen})
\label{eq:damEnergy}
\end{align}

\end{tcolorbox}

### Null (N) formulation

The null model can be defined using similar base equations as for the @Keirstead2013a model, having as its main constraint, the balance for each resource $r$, in each zone $z$:

\begin{align}
I_{rz} + \sum_t^TJ_{\tau rz} + \sum_{p}^{P}G_{prz} &= D_{rz} + E_{rz} \qquad \forall r,z
\label{eq:null_balance_qty}
\end{align}

$J$ and $G$ denote the variables of resource production and transport by conversion and transport processes $p$ and $\tau$, respectively (their equations are defined in [TODO: cross-reference equations], below). $D$ denotes the demand parameter. $I$ and $E$ denote the import and export variables respectively, and these are limited by constraints which specify which zones are allowed to import/export each resource and the maximum they are allowed to import/export:

\begin{align}
I_{rz} &\geq \delta^I_{rz} I^{min}_r \label{eq:null_imp_min} \\
I_{rz} &\leq \delta^I_{rz} I^{max}_r \label{eq:null_imp_max} \\
E_{rz} &\geq \delta^E_{rz} E^{min}_r  \label{eq:null_exp_min} \\
E_{rz} &\leq \delta^E_{rz} E^{max}_r \label{eq:null_exp_max}
\end{align}

where $I_r^{min}$, $I_r^{max}$, $E_r^{min}$ and $E_r^{max}$ are parameters which limit the quantity of how much of any resource can be imported or exported. $\delta^I$ and $\delta^E$ are binary variables which equal 1 if a zone is allowed to import or export a resource, respectively, or 0 if it is not; these binary variables values are subject to limits on the total number of zones that are allowed to import or export a particular resource, defined by the parameters $N^I_r$ or $N^E_r$, and must satisfy:

\begin{align}
	\sum_z \delta^I_{rz} &\leq N^I_r \qquad \label{eq:null_imp_allowed} \\
	\sum_z \delta^E_{rz} &\leq N^E_r \qquad \label{eq:null_exp_allowed}
\end{align}

#### Conversion processes

To calculate the production of a resource by a particular process $p$ in a zone, the null formulation models processes as black boxes, where the relative quantities of resource inputs and outputs are denoted by coefficient $k$:

\begin{align}
	G_{prz}&=k_{pr} F_{pz} \qquad 
\label{eq:null_process}
\end{align}

where the $F$ variable defines the operation rate of a technology (for example, a dam may operate with a generating capacity of 3 MW). Carrying forward the principles of [TODO: cross-reference relevant section of Chapter 4], the output resource (in the dam example this would be electricity) always has a coefficient value, $k_{pr}=1$. The value of the $F_{pz}$ is defined from the number $N$ of any type of process in a zone, and their maximum operating capacities, $F^{max}$:

\begin{align}
	F_{pz} \leq N_{pz} F^{max}_{p} \qquad 
\label{eq:null_process_rate}
\end{align}

\begin{tcolorbox}
Considering the dam example, the variables that the null model calculate are the mass of water passing into and out of the dam $m$, and the electricity generated $e^{dam}$ [TODO: cross-reference back to the node-link diagram earlier]. Carrying forward the principles of [TODO: cross-reference relevant section of Chapter 4], the electricity is considered the dam's `main' output, and hence its output coefficient is set to  1 MJ\footnote{Recall that this means that the process's rate, $F_{pz}$ becomes a one-to-one mapping of the resource production, which in this case is the dam's power.}


The other process coefficients are then defined relative to this electricity output using Equation \ref{eq:damEnergy}. For the model to remain linear, the water's elevation head (i.e. the dam height, $z_B$) cannot be considered a variable, thus the model requires a dam to be defined with fixed height. Therefore, assuming a dam of height $z_B=10$ metres and efficiency $\eta^{dam}=$80 percent, there mass of water required to produce a megajoule of electricity is 8.15 kg, resulting in the coefficients indicated in Listing [TODO: check the calculations here, and update the listing, and cross-reference listing].

\begin{tcblisting}[frame=single,
	caption = Production coefficients for the dam in the null model.,
	label = list:null_coeff_dam,
	float=[htbp]]
dam source_hiHead_lowQual -1
dam lowHead_lowQual 1
dam elec 98.1 
\end{tcblisting}

\end{tcolorbox}

#### Transport processes

The net resource inflow variable $J$ is calculated from the difference between the resource quantity entering a zone via a transport technology, and the resource quantity leaving a zone via a transport technology.

\begin{align}
\begin{split}
	J_{trz} = &\sum_{tz'} (k^{qty,src}_{tr} + k^{dist,src}_{tr}\l_{zz'})F^{transp}_{tzz'} + \\
	       &\sum_{tz'} (k^{qty,dest}_{tr} + k^{dist,dest}_{tr}\l_{z'z})F^{transp}_{tz'z} \label{eq:null_transp_rate}
\end{split}
\end{align}

The calculation of $J$ is somewhat analogous to the calculation of $G$, in that it constitutes a resource coefficient multiplied by a rate, but developed in three ways ways. First, it is defined for a transport technology $t$ between two zones, $z$ and $z'$, and thus considers each zone both as a source ($src$) from which resources leave, and as a destination ($dest$) into which resources arrive, and thus resource flows arriving in zone $z$ must be summed over all flows coming from all other zones $z'$, and resource flows leaving zone $z$ must be summed over all flows travelling to all other zones $z'$. Second, the amount of resource arriving in/leaving from a zone is a function both of the technology itself and the distance spanned by the technology. For example, [TODO: think up an example, e.g. the amount of electricity used to pump water through a pipe of particular lenght]. This is represented in the bracketed term, which is the multiplier of the transport technology's rate of operation $F^{transp}$ 's variable. Thirdly, it is possible (though not necessary) that several transport technologies can carry the same resource (for example biomass can be transported by both lorries or vans: these would have different rates, and require different amounts of petrol etc.), hence the summation over transport technologies $t$ [TODO: check this summation is required. It may already be considered in the main equation]. Table [TODO: cross-ref] below gives examples of the parameter values for the examples of electricity and biomass transport in Figure [TODO: cross-ref].

\begin{table}[]
\centering
\caption{Example parameter values to model transport processes.}
\label{my-label}
\begin{tabular}{@{}lllllll@{}}
\toprule
\multirow{2}{*}{$t$}  & \multirow{2}{*}{$r$} & \multicolumn{2}{l}{Source}               & \multicolumn{2}{l}{Dest}                  & \multirow{2}{*}{Comment}               \\ \cmidrule(lr){3-6}
                      &                      & $k^{qty,src}_{tr}$ & $k^{dist,src}_{tr}$ & $k^{qty,dest}_{tr}$ & $k^{qty,dest}_{tr}$ &                                        \\ 
\midrule
Cable                 & Electricity          & -1                 & 0                   & 1                   & \textless0          & Losses depend on distance              \\ \cmidrule(lr){1-2}
\multirow{3}{*}{Road} & Biomass              & -1                 & 0                   & 1                   & 0                   & No losses                              \\
                      & Petrol               & 0                  & \textless0          & 0                   & 0                   & Petrol requirements depend on distance \\
                      & CO2                  & 0                  & \textgreater0       & 0                   & \textgreater0       & Emissions depend on distance           \\
\bottomrule
\end{tabular}
\end{table}

Like for conversion processes, $F^{transp}$ is contingent upon a binary variable which specifies if transport technology $t$ is exists between zones $z$ and $z'$, and must lie between minimum and maximum rates of operation:

\begin{align}
F^{transp}_{tzz'} &\geq \delta^{transp}_{tzz'} F^{transp,min}_t \label{eq:null_transp_min} \\
F^{transp}_{tzz'} &\leq \delta^{transp}_{tzz'} F^{transp,max}_t \label{eq:null_transp_max}
\end{align}

and transport technologies can only exist between zones which are defined as being neighbours [TODO: check this]:

\begin{align}
\delta^{transp}_{tzz'} = 0, \qquad \forall (z,z') \notin nb \label{eq:null_neighbs}
\end{align}

where $nb$ defines a set of neighbouring pairs of zones. For the final constraint, we can define the following equation which allows resources to be transported in both directions along a transport technology:

\begin{align}
\delta^{transp}_{tzz'} = \delta^{transp}_{tz'z} \label{eq:null_direction}
\end{align}

[TODO: Move this to a separate subsection?]

There are a number of objectives that the model can meet (for example minimum emissions or minimum water footprint), but here we will minimise the cost of the overall system:

\begin{align}
cost = \min\left\{\sum_{rz} C^R_r I_{rz} + \sum_{pz} C^P_p N_{pz}\right\}
\label{eq:null_obj}
\end{align}


### Processes, resources and qualitites (PRaQ) formulation

The PRaQ model is based on the same equations as the null model, also following a black-box approach to modelling the conversion processes and transport technologies, and so as before, there is an equation which balances the resource quantities in each zone (Equation \eqref{praq_balance_qty}:

\begin{align}
I_{rz} + \sum_p^P G^{(qty)}_{prz} + \sum_{\tau} V^{(qty)}_{rz\tau} &= D^{(qty)}_{rz} + E_{rz},
\label{eq:praq_balance_qty}
\end{align}

In addition, PRaQ develops Keirstead's formulation, to incorporate a more sophisticated definition of a resource, in which it possesses not just a quantity, but also the qualities, mentioned earlier. An example where this would be useful is a water pump, where the head to which the water input must be pumped needs to be matched by the electrical energy input (Figure \ref{fig:praq-water-pump}). To model this, PRaQ uses an equation analogous to the quantity balance, which balances the resource qualities, $q$, within each zone $z$. The PRaQ formulation relates a resource's quantity to its quality by way of the parameter $X_{rq}$: this is multiplied by a resource quantity value to separate a quantity into its qualities[^qual-param].

[^qual-param]: For example, 1 kg of water at a 10 m elevation would have an energy head of 98.1 J, thus, $X_{rq}$ would be defined as $X_{\mbox{water, mass}} = 1$, $X_{\mbox{water, energy}} = 98.1$. Therefore, if this body of water were being imported into zone $z$, $X_{\mbox{water}, q}I_{\mbox{water}, z}=$ 1 kg and 98.1 J, for $q=$ mass and energy, respectively.

\begin{figure}
	\centering
	\includegraphics[scale = 0.5]{05_model-development/praq-water-pump.pdf}
	\caption{Example of PRaQ's resource-quality balance for a water pump which is bringing a kilogram of water to an elevation of 10 m. In this example, there are two input resources (water, and electricity). The water has two qualities attributed to it (mass and energy), and the electricity has just energy associated with it. Both mass and energy balance across the pump.}
	\label{fig:praq-water-pump}
\end{figure}

\begin{align}
X_{rq} I_{rz} + \sum_p^P G^{(qual)}_{prqz} + \sum_{\tau}^T V^{(qual)}_{\tau rqz} &= D^{(qual)}_{rqz} + X_{rq} E_{rz} \qquad \forall q,
\label{eq:praq_balance_qual}
\end{align}

The limits on imports and exports are defined in the same way as for the Null model:

\begin{align}
I_{rz} &\geq \delta^I_{rz} I^{min}_r \label{eq:praq_imp_min} \\
I_{rz} &\leq \delta^I_{rz} I^{max}_r \label{eq:praq_imp_max} \\
E_{rz} &\geq \delta^E_{rz} E^{min}_r  \label{eq:praq_exp_min} \\
E_{rz} &\leq \delta^E_{rz} E^{max}_r \label{eq:praq_exp_max}
\end{align}

<!--
\begin{align}
\sum_r \big ( X_{rq} I_{rz} + J^{qual}_{rqz} + G^{qual}_{rqz} ) &= \sum_r (D_{rqz} + X_{rq} E_{rz})
\label{eq:praq_balance_qual}
\end{align}
-->

<!--
The demand $D^{(qty)}$ parameter is specified by the user, and the model will choose the resource quantity imported into the city $I$, exported from the city $E$, generated by conversion processes $G$, and net inflow from other zones $V$ (referred to as 'variables').

Like Keirstead's model, the resources are expressed in terms of quantities (such as MW of electricity or kg/s of solid waste), which in our equations is denoted by the $^{(qty)}$ superscript.
-->

#### Conversion processes

The modelling of conversion processes is similar to the black-box formulation of the null model, but again, two equations are used. The first defines the net resource quality, $G^{(qual)}_{prqz}$, generated by a conversion process in a zone at a particular time, for a process with variable operation rate $F_p$, and parameters to define the relative ratio of resource inputs and outputs, $k^_{prq}$:

\begin{align}
G^{(qual)}_{prqz} &= k_{prq} F_pzt,
\label{eq:praq_conv_qual}
\end{align}

The second equation is required so that resource quantities also balance. This constraint is effectively the same balance of quality as above, but is defined using the quantity variable ($G^{(qual)}_{prq}$, by using the $X_{rq}$ parameter to translate a resource's quantity into its quality attributes:

\begin{align}
X_{rq}G^{(qty)}_{prz} &= k_{prq} F_{pz} \delta^R_{rq}, \qquad \forall~\delta^P_{prq}=1
\label{eq:praq_conv_qty}
\end{align}

This equation uses two binary parameters to ensure the balance only applies to qualities when they are attributed to a resource: therefore $\delta^R_{rq}=1$ for all resource-quality pairings which exist, otherwise it takes a value of zero[^binary-res-qual]. There is then a process equivalent parameter, $\delta^P_{prq}$, which takes a value for 1 for all resource-quality pairings which exist (i.e. $\delta^P_{prq} \forall p$ when $\delta^R_{rq}=1$).

[^binary-res-qual]: For example, $\delta_{rq}=1$ when $r=\mbox{water}$ and $q=\mbox{mass or energy}$, and when $r=\mbox{electricity}$ and $q=\mbox{energy}$; but when $r=\mbox{electricity}$ and $q=\mbox{mass}$, $\delta_{rq}=0$.

The constraint on the number of allowable processes is defined as for the Null model:

\begin{align}
	F_{pz} \leq N_{pz} F^{max}_{p} \qquad 
\label{eq:praq_process_rate}
\end{align}

<!--
This equation only needs to be applied in the case where a process $p$ produces or consumes resource $r$ with qualities $q$, hence the condition based on the $\delta_{prq}$.
-->

\begin{tcolorbox}
The dam example has two 'water' resources (one high-head, the other low-head); other water resources could include water at different temperatures or contamination levels. 

 However, here we evolve Keirstead's formulation, by defining resource flows in terms of their \emph{quality}, such that a resource can be attributed with both an energy and a mass. This is useful as we consider interaction between different sectors. Consider a body of water: this can supply (for example) both cooling for industrial processes, and hydroelectric electricity -- in our model we would need to know both its mass, and its energy head due to elevation. Thus the formulation specifies an equation analogous to \eqref{eq:bal_qty} which gives the quality balance for each resource  in terms of their quality (using the $^{(qual)}$ superscript notation):
\end{tcolorbox}

#### Transport processes

The transport processes are defined similarly, following the same logic as the Null model formulation to quantify the net inflow of resource quality, $V^{(qual)}_{\tau rqz}$, into a zone, according to the rate at which the transport technologies can operate, and losses, and other resources involved:

\begin{align}
V^{(qual)}_{\tau rqzt} = &\sum_{z'} (k^{\alpha}_{\tau rq} + k^{\beta}_{\tau rq} l_{zz'}) F^{transp}_{\tau zz't} \\
+ &\sum_{z'} (k^{\alpha'}_{\tau rq} + k^{\beta'}_{\tau rq} l_{z'z}) F^{transp}_{\tau z'zt}
\label{eq:praq_transp_qual}
\end{align}
<!--
Coefficients and process rates are defined for transport technology $\tau$, both for the zone of origin $z$, and the zone of destination $z'$ (where the $'$ notation indicates the destination zone). Furthermore, the quantity of input resources can be defined by the linear sum of two coefficients, denoted by $\alpha$ and $\beta$. For example to transport 1 kg of coal from $z$ to $z'$ (defined by $k_{\tau rq}^{\alpha}=-1$, $k_{\tau rq}^{\alpha'}=1$) will require a quantity of petrol dependent on the distance between the zones $l_{zz'}$, thus defined by $k_{\tau rq}^{\beta}$ and $k_{\tau rq}^{\beta'}$. In the case where transport losses occur (such as electricity transported via a cable), $k^{\alpha}_{\tau rq} > k^{\alpha'}_{\tau rq}$. To calculate the quantity flows, we once again use the $X_{rq}$ parameter:
-->

Again, this balance is also defined in terms of net inflow of quantities, $V^{(qty)}_{\tau rz}$, by using the $X_{rq}$ parameter, and the binary parameter, $\delta^{R}_{rq}=1, \mbox{where } \delta^{\tau}_{\tau rq}=1$ (these parameters are defined according to a similar logic to that used for the conversion processes[^binary-transp]):

\begin{align}
X_{rq}V^{(qty)}_{\tau rzt} &= \Big[ \sum_{z'} (k^{\alpha}_{\tau rq} + k^{\beta}_{\tau rq} l_{zz'}) F^{transp}_{\tau zz't} \\
&+ \sum_{z'} (k^{\alpha'}_{\tau rq} + k^{\beta'}_{\tau rq} l_{z'z}) F^{transp}_{\tau z'zt} \Big] \delta^R_{rq} \qquad \forall~\delta^{\tau}_{\tau rq}=1
\label{eq:praq_transp_qty}
\end{align}

[^binary-transp]: As for the conversion processes, $\delta^{\tau}_{prq}$ takes a value for 1 for all resource-quality pairings which exist (i.e. $\delta^{\tau}_{prq}~\forall p$ when $\delta^R_{rq}=1$).


The existence of transport processes between zones are defined using the same equations as for the Null model:

\begin{align}
F^{transp}_{tzz'} &\geq \delta^{transp}_{tzz'} F^{transp,min}_t \label{eq:praq_transp_min} \\
F^{transp}_{tzz'} &\leq \delta^{transp}_{tzz'} F^{transp,max}_t \label{eq:praq_transp_max} \\
\delta^{transp}_{tzz'} &= 0, \qquad \forall (z,z') \notin nb \label{eq:praq_neighbs} \\
\delta^{transp}_{tzz'} &= \delta^{transp}_{tz'z} \label{eq:praq_direction}
\end{align}


<!--
The quantity of resource produced can then be determined by ensuring that the resource quality produced by each processes matches the resource quality produced in the system as a whole. The resource-quality pairs that exist (and hence need to be balanced) are defined by the boolean $\delta_{rq}$. The balance needs to take place on these resource-quality pairs for every process in the system (that is, where the boolean $\delta_{prq}=1$).
-->

\begin{lstlisting}[frame=single,
	caption = Production coefficients for the dam in the PRaQ model.,
	label = list:praq_dam,
	float = [htbp]]
dam water_source mass -1
dam water_generated mass 1
dam water_source energy -98.1
dam elec energy 98.1
dam water_source contam -0.004
dam water_generated contam 0.004
\end{lstlisting}

<!--
The equations of null and PRaQ, and how their formulations are analogous to one another are summarised in Table~\ref{tab:null_praq_eqns}.

\clearpage
\input{05_model-development/tabs/null_praq_equations.tex}
-->

### Nonlinear (NL) formulation

The two model formulations we have derived thus far (null and PRaQ) are both as generic as it is possible to be. That is to say that all resources, conversion processes and transport technologies can be defined in the same way, and only the data (the values of each index/subscript) will change. In the earlier discussion of model generality and fidelity, we discussed that we could achieve greater fidelity with a less general model. This derivation will show how a nonlinear model formulation can achieve greater fidelity to the way conversion and transport processes behave in reality (in contrast to our simple black-box representations). [TODO: Move this to the discussion?] 

The equations of this model are largely based on those of the Null model, with the main balance equation, and the imports and exports defined in the same way:

\begin{align}
I_{rz} + \sum_t^TJ_{\tau rz} + \sum_{p}^{P}G_{prz} &= D_{rz} + E_{rz} \qquad \forall r,z \label{eq:null_balance_qty} \\
I_{rz} &\geq \delta^I_{rz} I^{min}_r \label{eq:null_imp_min} \\
I_{rz} &\leq \delta^I_{rz} I^{max}_r \label{eq:null_imp_max} \\
E_{rz} &\geq \delta^E_{rz} E^{min}_r  \label{eq:null_exp_min} \\
E_{rz} &\leq \delta^E_{rz} E^{max}_r \label{eq:null_exp_max}
\end{align}

#### Conversion processes

The change that the NL model makes is in the way conversion processes are modelled -- these have the choice of either being linear or nonlinear, by way of an adaptation to the conversion process equation \eqref{eq:null_process}:

\begin{align}
	G_{prz}&=(\kappa^{O}_{pr}-\kappa^{I}_{pr}) F_{pz} \qquad 
\label{eq:nl_process}
\end{align}

In \eqref{ed:nl_process}, the $k_{pr}$ parameter has been replaced by an expression which calculates the net output of a resource from process $p$, in which $\kappa^{O}_{pr}$ and $\kappa^{I}_{pr}$ represent the output and input of quantities of resource $r$, respectively. These variables can then be defined in a bespoke way. For a linear process, $\kappa^{*}_{pr}$ is defined by a number, which essentially reduces \eqref{eq:nl_process} to the null formulation \eqref{eq:null_process}. However, for a nonlinear process, these values can be defined by equations. For example, for a dam's management of resources could be defined by two equations -- an energy balance and a mass balance:

\begin{align}
\kappa^{I}_{\mbox{dam},\mbox{water}} g H_I &=  \kappa^{O}_{\mbox{dam},\mbox{water}} g H_O + \kappa^{O}_{\mbox{dam},\mbox{elec}} \label{eq:nl_process_dam_energy} \\
\kappa^{I}_{\mbox{dam},\mbox{water}} &=  \kappa^{O}_{\mbox{dam},\mbox{water}} \label{eq:nl_process_dam_mass}
\end{align}

where $H_I$ and $H_O$ are heights of the water on the input and output sides of the dam, respectively. In this dam example, variables can be multiplied by each other (i.e. the mass of water and its height). 

The number of processes is defined as for the Null model:

\begin{align}
	F_{pz} \leq N_{pz} F^{max}_{p} \qquad 
\label{eq:nl_process_rate}
\end{align}

Note that as in the Null model, $F_{pz}$ is defined with respect to the resource that is considered the 'main output' which by definition has a magnitude of one, this needs to be fixed in the NL formulation. In the case of the dam, the main output is electricity, thus $\kappa^{O}_{\mbox{dam},\mbox{elec}}=1$

#### Transport processes

In theory, these could be formulated in a similar way to the conversion processes, to allow for nonlinear behaviour, however, they have been defined using the same set of equations as for the Null model:

\begin{align}
J_{trz} &= \sum_{tz'} (k^{qty,src}_{tr} + k^{dist,src}_{tr}\l_{zz'})F^{transp}_{tzz'} \\
&+ \sum_{tz'} (k^{qty,dest}_{tr} + k^{dist,dest}_{tr}\l_{z'z})F^{transp}_{tz'z} \label{eq:nl_transp_rate} \\
F^{transp}_{tzz'} &\geq \delta^{transp}_{tzz'} F^{transp,min}_t \label{eq:nl_transp_min} \\
F^{transp}_{tzz'} &\leq \delta^{transp}_{tzz'} F^{transp,max}_t \label{eq:nl_transp_max} \\
\delta^{transp}_{tzz'} &= 0, \qquad \forall (z,z') \notin nb \label{eq:nl_neighbs} \\
\delta^{transp}_{tzz'} &= \delta^{transp}_{tz'z} \label{eq:nl_direction}
\end{align}

<!--
NOTE: MUCH OF THIS CONTENT IS REPEATED ABOVE. bUT SOME WORKING MAY BE BETTER HERE.]

Finally, a NL model is formulated, to solve the same network optimisation as the null and PRaQ models. However, in contrast to the other models which represent processes as 'black boxes', defined by production coefficients, the NL model aims to represent the physical processes as realistically as possible. Therefore it achieves an accurate and flexible representation of a resource-process network, at the expense of increased computational requirements. Some of the parameters in the NL model are similar to those in null and PRaQ, and include demands and costs. In addition, physical constants (such as gravity $g$ are introduced). However, there is no need for the production coefficients required by the 'black box' approach. Some of the model variables are also analogous to those in null and PRaQ, and include imports, exports, and quantities of resource production/consumption for a processes. The model equations fall into two categories:
\begin{enumerate}
	\item \emph{Processes.} Since the model is nonlinear, it is possible to fairly accurately represent a physical process. These replace the quality/quantity production equations \eqref{eq:null_prod_qty}, \eqref{eq:praq_prod_qual} and \eqref{eq:praq_prod_qty} of the null and PRaQ models. For example, the energy balance across a dam (of 100\% efficiency) is formulated as follows:

\begin{align}
	\mbox{water}^{dam}_{in} g \cdot \mbox{head}^{dam}_{in} &= \mbox{water}^{dam}_{out} g \cdot \mbox{head}^{dam}_{out} + \mbox{elec}^{dam}_{out}
\end{align}

%\begin{align}
%	G_{\mathclap{\substack{\begin{aligned}p&=dam\\r&=water\\q&=mass\\z\end{aligned}}}} g G_{\mathclap{\substack{\begin{aligned}p&=dam\\r&=water\\q&=head\end{aligned}}}}  = G_{\mathclap{\substack{\begin{aligned}p&=dam\\r&=water-out\\q&=mass\\z\end{aligned}}}} g G_{\mathclap{\substack{\begin{aligned}p&=dam\\r&=water-out\\q&=head\end{aligned}}}} + G_{\mathclap{\substack{\begin{aligned}p&=dam\\r&=elec\\q&=energy\end{aligned}}}}
%\end{align}

\begin{align}
	&G_{p=dam,r=water,q=mass,z} \cdot g \cdot G_{p=dam,r=water,q=head}  = \\
	&G_{p=dam,r=water-out,q=mass,z} \cdot g \cdot G_{p=dam,r=water-out,q=head} + \\
	&G_{p=dam,r=elec,q=energy}
\end{align}

Equations such as these allow us to formulate nonlinear problems. In the example above, all the terms apart from $g$ are nonlinear.
Equations such as these allow us to formulate nonlinear problems. In the example above, all the terms apart from $g$ are nonlinear.

	\item \emph{Balances}. These equations balance the imports, exports, demands, production and consumption of the resources for the whole system. These equations are analogous to the balance equations \eqref{eq:null_balance_qty}, \eqref{eq:praq_balance_qual}, and \eqref{eq:praq_balance_qty} of null and PRaQ. 
	\begin{align}
		\mbox{water}^{dam}_{in} &= \mbox{water}^{dam}_{out} \\
		\mbox{water}^{dam}_{in} + \mbox{water}^{agriculture}_{in} + \mbox{water}_{export} &= \mbox{water}_{import}
	\end{align}
\end{enumerate}	

In addition, the boundaries on the imports and exports and the objective function are defined as for the null and PRaQ models.
-->

### Model objectives {#sec:model-objs}

The three models will minimise some objective. The are numerous possibilities with a simple objective being to minimise the imports of a particular resource (e.g. water) -- this would require no additional parameters to be defined in the model. A more sophisticated objective is the financial cost of resources ($C^R$), conversion processes ($C^R$), and transport processes ($C^{\tau}$):

\begin{align}
C^R &= \sum_{rzt} c_r I_{rzt} \\
C^P &= \sum_{pz} c_p N_{pz} \\
C^{\tau} &= \sum_{\tau zz'} c_\tau \delta^{transp}_{\tau zz'} l_{zz'}
\end{align}

where the parameters $c_r$, $c_p$, $c_{\tau}$ defines the cost of an item per unit (e.g. a kilogram of water, a joule of energy, or a single process). These costs can be combined into a single objective function:

\begin{align}
C = \gamma^R C^R + \gamma^P C^P + \gamma^{\tau} C^{\tau}
\label{eq:objective_cost}
\end{align}

where coefficients $\gamma^*$ could weight the costs appropriately: for example, annualising system cost by multiplying the resource imports up to a yearly level, and dividing the capital costs over its expected lifetime.

Other types of objective function could include the carbon footprint $(CF)$ of an area, defining this using the emissions factor of a resource $(EF)_r$:

\begin{align}
CF &= \sum_{rzt} (ef)_r I_{rzt}
\end{align}

Multiple objectives can be used, and traded-off against one other, in so-called 'Pareto optimisation'. In this method, one objective is used as the objective function (such as cost), while another is defined as an inequality constraint (such as emissons):

\begin{align}
\sum_{rzt} (EF)_r I_{rzt} \leq \mbox{Emissions limit}
\end{align}

The model is then run multiple times, changing the value of the emissions limit each time, enabling the plotting of a curve of the system's emissions against its cost.

### Summary

The Null model is built around the resource balance \eqref{eq:null_balance_qty}, for which resource imports and exports are constrained by \eqref{eq:null_imp_min}--\eqref{eq:null_exp_max}. The conversion processes operate according to \eqref{eq:null_process} and the number of them which exist is constrained by \eqref{eq:null_process_rate}. Similarly, transport processes operate at rates governed by \eqref{null_transp_rate}, with their existence between zones defined by \eqref{eq:null_transp_min}--\eqref{eq:null_direction}. 

The PRaQ model is formed using a similar set of constraints to the Null model (Equations \eqref{eq:praq_balance_qty}--\eqref{eq:praq_direction}), namely resource balances, import and export limits, and black-box models of conversion processes and transport processes. In order to incorporate resource qualities, the formulation introduces additional equations, which use new parameters and variables whose purpose is to map resource qualities onto quantities. Finally, the NL model is formulated in the same way as the Null model, apart from for the conversion process equation, which is formulated to allow processes to be modelled is either linear or nonlinear.

The three formulations use continuous variables (e.g. resource quantities and process rates), integer variables (e.g. the number of conversion processes in a zone), and binary variables (e.g. to define the existence of a transport process between two zones). The Null and PRaQ models are linear, and so form mixed-interger linear programmes (MILPs), whilst the nonlinear model forms a mixed-integer nonlinear programme (MINLP). In each case, the models requires users to specify zonal demands for the resources available to an area, as well as the parameters (and/or equations) for available conversion process and transport technologies. The constraints are solved in order to minimise an objective function (with the option of defining additional constraints to accomplish Pareto optimisation).

## Implementation

The model is encoded using the specialist GAMS language[^GAMS], and uses the CPLEX solver to solve. The model has two components, namely the **formulation**, which includes the abstracted mathematics, and other GAMS-specific parameters (such as the length of time a model should run for); and the **data**, i.e. the parameter values (site layout, resource demands, process behaviour etc.).

[^GAMS]: General Algebraic Modelling System: \url{https://www.gams.com/}

The data are separated into two types. *Library* data defines the properties of resources (i.e. their quality attributes) and processes (i.e. their $k$ coefficients and maximum processes rates $F$); this data is defined in YAML format. *Model-definition* data defines everything else, including the site's spatial layout, the resource demands, and restrictions on imports and exports; this is all defined in CSV format. Both CSV and YAML data formats are chosen for their human-readability, their ease of editing, their ability to be read by programming languages, and the fact that as plain-text, they can be version-controlled.

These two components of data and formulation are kept strictly separate. To build a model, the requisite sets of data needs to be combined with the correct aspects of the formulation in the correct order. For example, a case study may decide to consider just a limited set of conversion technologies, and might choose a minimum cost objective (rather than a minimum emissions objective, for example). Combining the data and formulation, is performed by a  script (written using the R programming language), which can specify the data and formulation-elements required, and write the GAMS script. This architecture is visualised in Figure \ref{fig:assemble-model}.

This approach to implementation means its easy to generate new models, just by changing or adding to the CSV or YAML data. It also means that data used in multiple models need only be defined once, and relatedly, makes it possible to use the same data with different formulations. Finally, this 'modular' implementation makes it easy to modify or extend the formulation, and apply to multiple cases.

These properties serve not just the practical convenience for a modeller, but make help establish this model as a benchmarking study by making it as straightforward as possible to test new formulations on the same case study, and to compare them with other formulations. All the data and code to run these models, as well as the results of the Tat Hamlet study (below) are freely available online at \url{https://github.com/tomravalde/model-development-code}.

\begin{figure}
	\centering
	\sffamily
	\resizebox{0.5\columnwidth}{!}{\input{05_model-development/assemble-model.pdf_tex}}
	\caption{Schematic for assembling the benchmark models for the Tat Hamlet case study.}
	\label{fig:assemble-model}
\end{figure}

## Applying the formulations to Tat Hamlet

Each formulation is applied to the Tat Hamlet case study, to compare how each model performs in relation to the tradeoffs in generality, fidelity, usability and tractability. The approach takes is to build up the Tat network one conversion process at a time (beginning with the just the dam) -- introducing resources necessary for each set of processes, and transport processes used by these resources -- until the complete network of figure [TODO: cross-ref] is realised. Each network is run, model characteristics and behaviours (such as number of variables and runtime) are recorded. The order in which the network is built up is given in Table [TODO: cross-ref table] (which also presents the results of the characteristic analysis), with diagrams of the networks provided in Appendix [TODO: cross-ref]. Model runs were subject to a time limit of 1,000 seconds[^time-limit]. The linear models where solved using the GLPK solver[^GLPK], whilst the nonlinear model was solved using the SNOPT solver[^SNOPT]. [TODO: check which solvers where used]. [TODO: Are we going to tabulate the results (i.e. objective function values, etc.) anywhere, and if so, should we indicate that here?]

[^time-limit]: In GAMS, this is specified with the resource limit option, i.e. `option reslim=1000`.

[^GLPK]: GNU Linear Programming Kit: \url{https://www.gnu.org/software/glpk/}

[^SNOPT]: \url{http://www.sbsi-sol-optimize.com/asp/sol_products_snopt_desc.htm}

[TODO: Apendicise the network bit by bit build up of the network diagrams.]

\begin{figure}
	\centering
	\begin{spacing}{1.0}
	\sffamily
	\resizebox{\columnwidth}{!}{\input{05_model-development/network-1.pdf_tex}}
	\end{spacing}
	\caption{The first network.}
	\label{fig:network-1}
\end{figure}

### Results

Figure \ref{fig:comparison-formulations} shows how the number of equations and variables, runtime, and objective function value) [TODO: units/cost?? add USD units to facet strip?] changes with the number of processes in Tat's network. These plots show that as the number of conversion processes added to the network increases, then so do the number of equations, and variables (both continuous and discrete). However, when comparing between the models, these quantities all have the same order of magnitude. More interesting is to note the nonlinear model's behaviour where the objective function and the solution time changes with the number of processes. First, unlike for the numbers of equations and variables, the objective function and the solution time do not monotonically increase with the number of processes (note in particular the spike in objective value for 8 conversion processes). This unpredictability is because the speed at which nonlinear optimisation algorithms arrive at an optimal solution is sensitive to the way the model is formulated, even being affected by the order in which equations, variables, and components are defined. Second, a difference in the order of magnitude of solution time opens up from the point at which the network contains 6 or more conversion processes. Note that these solution times are to achieve objective function values that are very similar to those produced by the linear formulations (this can be more clearly seen in the plots where outliers at [TODO:] and [TODO:] have been removed). These behaviours give insight into how the formulations behave with respect to fidelity, generality, tractability, and usability.
<!--
TODO: Move a version of this comment into the discussion.
This is because nonlinear models are harder to solve than equivalently sized linear models, thus more computational effort is required.
-->

[TODO: note the nonconvexity and the need to find a guaranteed global optimum, rather than stopping at any optimum, especially when there are integer variables in a network problem, using branch and bound methods [@Williams, Chapter 8].


```{r compare-formulations, fig.height=8, fig.cap="Comparison of model formulations. The plots headed with ``outliers removed''} show the same information as their counterparts, however with the data for 6 and 8 conversion processes removed. (The explanation for these outliers is given in Section [TODO:].) \\label{fig:comparison-formulations}"}

setwd("05_model-development")

source("process-results.R")

plot_conversion

```

### How well do the formulations represent reality? Fidelity and generality

A model's fidelity can be validated in two ways. The first is practical; the model's results are verified against the results of real, historic data. However, the parameters in the Tat Hamlet case study (i.e. the $k$ coefficients) have actually been derived from the historic data, and so this test is not fair. In theory, one could keep all processes in the real-life Tat system the same, but change some of the demands, observing how the network of processes responds; one would then see if this could be replicated in the model by changing the same demands. However, this would be both impractical and unethical; and as pointed out earlier, practical and ethical limitations are what makes models useful [p.TODO: page reference, quoting @Williams1990]. A second reason is that for the purposes of developing the model, Tat Hamlet as been reimagined (with simplifications, adjustments and assumptions). The inability to validate the model in this way is not unique to this thesis; many other models which optimise the systems at the urban scale cannot be validated in this rigorous manner, including [TODO: list examples, e.g. Keirstead].

This does not mean that nothing can be said about the fidelity of the three formulations: a second way to assess fidelity is theoretical. Throughout the derivations, it was demonstrated that the nonlinear formulate can model phenomena that linear models cannot (such as energy loss due to friction in pipes). In theory, there are other processes with nonlinearities that the nonlinear formulation can model with greater fidelity. However, the concern here is not necessarily the fidelity of the formulations relative to each other, but their fidelity relative to the purposes for which they are used. What is important with these sorts of models is that they are used for their intended purpose; that is for "insight, not numbers" [TODO: cite Hamming], to make explicit decisions that would otherwise be implicit, by adding some objectivity, by formalising the assumptions, relationships, and mathematics of the decision-making. Models such as these should be used to get an overall sense of how a system behaves. Does it choose to centralise or decentralise processes? Are their geographical features of the are which constrain the process choice in some locations, and what is the effect of this on the rest of the network? Which kinds of resources are cascaded? To that end, a general picture of system behaviour emerges from sensitivity analysis, comparing outcomes over a range of parameter values.

A model's fidelity is one of how it represents the real-world, hence it is discussed here with generality, another model feature of this type. [TODO: note this insight is made earlier in the chapter]. While the nonlinear formulation might be, in mathematical terms, the most faithful, it is also the least general, because nonlinear processes need specially defined equations [TODO: spell out in more detail what this actually looks like, cross-ref to appropriate equations and examples], while the linear models can use the same format for any process type.


<!--
this is not possible with the Tat Hamlet case study, whose resource-technology network and resource interconversions have largely been invented for this case study. Thus, it is not possible to verify the model results against any real, historic data. Thus the only way we can assess the performance of the models is to compare them against each other for similarity in the outputs, namely the objective function. [TODO: I'm not sure this is legit validation, partly becuase the formulation and parameters are fixed to achieve the same result] 

As shown by the results in Table~\ref{tab:results}, the two three formulations generally return very similar objective function values linear models give identical results, both in the objective function value, and the resource import quantities. The nonlinear model results vary very slightly. This is perhaps a feature of the nonlinear solver, because the model has avoided outputting any exports of excess materials. Further work needs to be done on the nonlinear model to see if changes to the use of software will bring a result which is identical to those of the linear models.

Our final consideration when evaluating the model performance is the behaviour and flexibility of the model. In this respect, the null model is the poorest performing model, with the least flexibility, because it doesn't incorporate quality considerations. When comparing the PRaQ and NL models, we must conclude that the NL model is superior. Whilst both consider resource quality, the NL model's handling of it is more flexible. For example, in the case of the dam in the NL model, the fact that the water's mass and energy head are both variables means one can compensate for the other in the $MgH$ calculation, when meeting and electricity demand. In the PRaQ model, only $M$ is a variable, hence the model is 'locked-in' to a relationship whereby 1 kg of water will produce 98.1 J of electricity -- in effect, a dam height of 10 m has to be assumed.
-->

### How easily can the formulations be used in practice? Tractability and usability

As well as the representational considerations above, there are practicalities to modelling More natural introduction of which tractability is one element. The most straightforward measure of this is computation time, with the nonlinear model being the clear loser here (see Table \ref{tab:results}): The linear models are solved in a few seconds, significantly quicker than NL model which takes about 13 minutes to run. Figure [TODO: cross-ref] shows that the driver of these times is the non-linearity: this is because the relationship between the number of conversion processes and the number of equations or variables is linear for both types of model, and futhermore, the nonlinear model never has the highest number of equations or variables. Yet, as the model grows through the addition of conversion processes, the solution time increases exponentially for the nonlinear model, but linearly for the linear models.  Furthermore, these solution times are for models without spatial or temporal disaggregation, which would widen the gap between linear and nonlinear solutions even more. [TODO: some sensechecking maths on how variables increase with the the spatial and temporal indices.]

Of course, the longer computation times are not necessarily a problem -- computations gets faster and faster over time, and some might have the power of parallel computing at their disposal. Even without the computational advantages, their are the heuristic methods [TODO: cross-ref appropriate section] which can find near-optimal solutions in shorter times. And nonlinear models can even by linearised into so-called piecewise linear models. This is where the second practical consideration -- usability -- comes into play.

Usability is a more qualitative metric than tractability, and so harder to quantify precisely, but it can be measured buy the ease of model construction. The simplest model to build is the null model, followed by PRaQ, with NL being the slowest and most difficult to construct. The reason for the ease of construction for the linear models is that the equations which model the processes and the resource balances can be defined generically. Then only the production coefficients $k_{pr}$ and $k_{prq}$ need to be specified. The PRaQ model is slightly slower to construct because of the extra variables additional variables. However, once $X_{rq}$ has been defined, the model construction can mainly be carried out using 'copy and paste', changing just a few words. Furthermore, the procedure for building the null and PRaQ models can be made faster by having these processes already matched with their coefficients, to be stored in a library. The user then just needs to specify the processes, to automatically generate the code which defines the network. [TODO: Relate this back to the model architecture outlined earlier in the chapter] In practice, with the build scripts supplied with the formulations, both Null and PRaQ models can be built just as easily, from the same library of process definition YAML files.

On the other hand, the NL model takes longer to construct, because it can't be defined generically, with the model equations requiring much more customisation. The activity of defining production coefficients in the null and PRaQ models becomes defining process equations in the NL model. The generic way in which the system resources are balanced in null and PRaQ gives way to a need to specify each resource balance individually in the NL model -- this is because the way a resource balance is defined depends on which processes exist in the network. In summary, the null model requires writing an average of about 18 lines of code per process, most of which is simply specifying a production coefficient. The PRaQ model requires about 58 lines of code per process. Most of this is either specifying a single number for production coefficients, or copy-and-pasting the process-resource-quality sets to define the quality coefficients $\delta_{prq}$ -- defining these coefficients is nearly 60\% of the model code. The NL model requires about 43 lines of code per resource, almost all of which are custom equations (rather than coefficients), which are specific to the resource-technology-network being considered. Thus, whilst smaller in length than the PRaQ model, the NL model is significantly more effort to formulate. [TODO: Update, because the new NL formulation might be a bit quicker.] 

- The implications Reduced usability: unable to complete a number of tests in reasonable time. E.g. looping over different parameter values.

This is true of a network with only 16 processes, and so will become even more apposite [TODO: better word] when recalling that Chapter 4 introduced a library of over [TODO: number] processes. If all these were considered in a model, then computational times could become unrealistic for research purposes.

## Conclusion

- This study has established three plausible methods to optimise an integrated urban resource network. The PRaQ model is preferred due to its speed and ease of construction, whilst the NL model is preferred due to its flexibility.
- The performance of the models where compared for their
	- generality
	- fidelity
	- tractability
	- usability
- The choice of formulation is first and foremost guided by the model's purpose -- it is this which provides the priority of the four characteristics.
- The priority a modelling gives to ... depens on the purpose of the model
- Given the necessity for usability and generality, non-linearity matters less...
- Given that the model's purposes allow a certain amount of freedom in fidelity, other properties become more prominent in deciding the model most suited for this work
- Generality is important in this work because a necessary part of it is to write a model which can model resource consumption/production, transport and storage for different resource types.
- but nonlinear considerations may be too much of a luxury for a more generic model, where the equations should apply to more real world systems (i.e. energy, water and waste management processes)
- Alongside this fidelity-generality trade-off is a relationship between generality and usability: as the former decreases, so does usability, due to the need to write equations that represent the resource management processes in our model (see Chapter 4).
- fidelity is in fact a *necessary* trade-off for a model in which trying stuff out/judgement etc. is the primary use 
- Reasons for a linear model:
	- Can be constructed generically (note how this links with usability)
	- Easier, and hence more appropriate, within the early stages of optimisation modelling within UM. Increased complexity can come later, now we built a foundation for this type of work
	- More widely useable (i.e. does not require such advanced solvers)
	- Generality: more widely applicable (see discussion on fidelity criteria)
- Why don't we use a piecewise linear model? The advantage of this is the solvability (easier to get a global optimum than nonlinear methods). But this isn't our problem. We are concerned with generality, such that we don't have to come up with lots of complex process and transport technology models.
- E.g. the process search gave us a lot of results: we need a generic method to handle that.

- In some situations, the null method might be a quick solution
- However, because of the code I've written, it isn't actually any harder to define a PRaQ model than a null model. Lots of the awkward calculations happen under the hood.
- The nonlinear method does have promise, and could perhaps be developed in the future, using sector-specific expertise.

the results suggest...
this appears to be because...
the future development of...

The PRaQ model will be carried forward into the next chapter, where we use it on a case study, to help optimise the intersectoral synergies of a Chinese urban development.

#### Further work 

- the nonlinear model falls down on generality, due to the need to define processes differently. Future work might assemble a library of nonlinear process descriptions to help here.
- It may be possible to (partially) linearise it using various techniques (for example piecewise linearisation). Other solution methods also exist in addition to the standard nonlinear solution methods. These include genetic algorithms and other heuristic methods, which should be explored. These alternatives to the standard nonlinear model can also be explored during the next stage of work.
- the nonlinear model falls down on generality, due to the need to define processes differently. Future work might assemble a library of nonlinear process descriptions to help here.


<!--
## Why modelling? [TODO: could this introduce the model review section of the literature review?]

- We need to note that this will inform our expectations, and hence where we want to position ourselves on the fidelity-usability-tractability (FUT?) trade-off curve.
- UM has a rich heritage already, in accounting, forecasting, finding trends, sustainability metrics. What does modelling bring to the party?

- Model-dependnent realism?
- fidelity-tractability trade-off:
  	- Example from biological systems modelling: \url{https://books.google.com/books?id=EnYjAQAAQBAJ&pg=PA410&lpg=PA410&dq=model+fidelity+tractability&source=bl&ots=6i47sLJQVJ&sig=Mfp7bq95qb9Qfsxopc5m57uIXfw&hl=en&sa=X&ved=0CDIQ6AEwA2oVChMI1vCm0uXQyAIViQMaCh0czAWu#v=onepage&q=model%20fidelity%20tractability&f=false}. NOTE: Discussion is limited to ecological models
	- A variable fidelity model management ramework for designing multiphase materials: \url{http://mechanicaldesign.asmedigitalcollection.asme.org/article.aspx?articleid=1449847}
	- A global optimization approach to robust multi-model fitting: \url{http://ieeexplore.ieee.org/xpls/abs_all.jsp?arnumber=5995608&tag=1}.
	- Do simple models lead to generality in ecology? \url{http://www.sciencedirect.com/science/article/pii/S0169534713001444}.
	- The effect of model fidelity on real-time optimization performance \url{http://www.sciencedirect.com/science/article/pii/S0098135403001649}
	  	- Chemical plant case study (to improve profit).
	- Discrete optimisation in early vision -- model tractability versus fidelity: \url{https://lup.lub.lu.se/search/publication/3233391}
	  	- McIntosh and Hamarneh (2011) highlight tractability ("how amenable the model is to optimization techniques", p.2) and fidelity (how well they describe reality, and the quality of the results obtained). "There is a natural trade-off between tractability and fidelity" (p.2).
  		- McIntosh and Hamarneh (2011): \url{http://www.ncbi.nlm.nih.gov/pubmed/21788185}. Note that increased fidelity (of a medical image segmentation model) is harder to formalize and optimize.
	- Model building in Mathematical programming:
		- Note 'the relationships which it incorporates' (p.3) -- the focus of this chapter, is distinct from the data used.
		  	- relationships encoded mathematically as "equations, inequalities, logical dependencies, etc." (p.3).
		- Consider the ambitions for our model. We do not (like some do) deny the value of a model at all (e.g. critics of CBA, which can be countered by recognising that decisions always *implicitly* contain quantitative evaluations; skeptics of coefficient accuracy, countered by seeing that model structure can minimise solution inaccuracy -- Section 6.3). Nor do we place a blind, unquestioning faith in modelling: a model "should be used as one of a number of tools for decision making" (p.5), to help "clarify the options" and "obtain a greater understanding of what is possible" (p.5).
		- Section 6.3, p111 (on coeff accuracy). On the accuracy of solutions, even when coefficients may be incorrect.
			  - What are the limits within which changes in parameter values can change, with predictable effects for a shadow price to hold true. 
			- *Post-optimal analysis*: see the 'right-hand ranges' which parameters can take.
			- Note that 'parametric programming' is required to study effects of simultaneously changing multiple parameters and going outside the ranges.
- fidelity-constructability (or usability) trade-off
  			- *Sensitivity analysis*: When ranges of a coefficient on the right-hand side of a constraint are narrow, then solutions are more critically dependent on the accuracy of a solution.
			- As well as right-hand side ranges, we can also test *objective ranges*.
			- Look at the *marginal rates of substitution* for the rate of change in variable values. Within permitted ranges, the changes in the objective value are governed by the constraint shadow price. If a parameter is altered (within a permitted range) by a unit, by how much does the variable value change? E.g. how should a system respond to resource scarcity, or reduced process efficiency?
			- *Parametric programming*. "computationally quick and therefore provides a cheap means of determining how the optimal solution changes with alterations in objective and right-hand side coefficients" (p123). In programming practice: by specifying the limits within which a parameter can vary.
		- James notes on uncertainty analysis: I.e. Monte Carlo (refined with Sobol' sequencing) to trial parameter values drawn from a distribution to investigate the effects on output

We will compare how three different mathematical formulations measure up to these goals.

- The structure of tradeoffs in model building: \url{http://link.springer.com/article/10.1007/s11229-008-9366-y#/page-1}
  	- precision vs generality
	- Thus the model-building strategy will depend on its theoretical goal (Levins, 1966)
		- Who argued "a three-way exists between generality, realism, and precision" (p170). Note this has been met with scepticism, but neverthless most agree that trade-offs will remain. This paper defines and formalises its own taxonomy of trade-offs
		- Strict-tradeoffs (increase one, necessarily decreases another)
		- Increase-tradeoffs (increase one, and another one can't be increased)
		- Levins-tradeoffs (magnitude of both attricbutes cannot simultaneously be maximised
	- Precision: attribute of the equations/model decriptions; not the model itself
	- Fidelity criteria: dynamical and representational. More "permissive criteria" will enable more general applications of the model.
	- Generality. The number of target systems a model applies to.
	- Conclusions:
	  	- "Tradeoffs in scientific modelling". These tradeoffs won't go away with scientific progress!
		- Presents "demonstrable proof" for the existence of trade-offs
		- Generality is important to scientists because it's correlated with explanatory power (until the point it is so general, that is says nothing at all). "One way to achieve the desired level of generality is to make the equations used to decribe the model less precise than would otherwise be optimal" (p189); or by limiting it's scope or fidelity criteria.
		- Note that this paper is disucssion scientific methodology (rather than optimisation)

- Qualitattive theory and chemical explanation
  	- models can relate to target systems in the real world
	- precision: proprty of model descriptions, rather than models themselves. How finely specified is a parameter in an eqaation? If model description D1 can pick out a 'proper subset' of the models picked out by D2, the D1 is more precise.
	  	- thus models "are determinate sets of relationships between properties"
		- model cescriptions can by instantiated: with precise values, will pick out a single model
	- Generality: "a property of the relationship between models and target systems". How many actual, or logically possible targets systems are there?
	- An imprecise model description "will pick out a larger set of models", and thus "will apply to many more target systems"
	  	- Trade-off between precision and p-generality. They cannot simultaneously both be increased
	  	- Trade-off between precision and a-generality
		  	- "actual target systems constitute a very small part of the possibility space", so would expect the same trade-off relationship that exists between precision and p-generality unless they a-systems are evently distributed amongst the p-systems. So we need information from the world to tell us how a-general a model. Basically, precision is an "attenuating factor" of a-generality -- i.e. it doesn't make it impossible to achieve, but it does make it more difficult: increasing precision attenuated a-generality
		- Conclusion: we can "defend a model-building norm that associates explanatory depth with the sacrifice of precision, which is one aspect of qualitative theorizing"

We will use a case study based on data for Tat Hamlet -- a village in Vietnam, and formulate a set of equations which can use the data to optimise the metabolism, e.g. by minimising emissions. Thus our aim is less about finding optimial metabolisms for Tat, and more about finding a methodology which could in theory identify optimal metabolisms for Tat.

As we believe optimisation modelling is pioneering work within urban metabolism, we offer this Tat Hamlet case study of this chapter as a 'benchmark problem for researchers. That is to say that others can use the same problem definition and accompanying data for their own formulations, to try and improve on ours. We will therefore make our data [TODO: and code -- or are there IP issues surrounding this?] freely available on line.

We should note somewhere about the trade-off: that modelling the individual technologies, when trying to describe a whole city's metabolism 
-->

<!--
FROM MY DRAFT CHAPTER
-->

<!--
Sections from JK's MILP paper

# Model structure, formulation, and implementation

In our model, the urban region under study is

- Zones/demands/imports/exports
- Resources (demands)
- Conversion technologies (STN)
- RTN
- Interzonal connections
- Storage

# Mathematical formulation

- Key equation

## Imports and exports
## Resource conversion technologies
### Domestic technologies
### Part-Load operation
### Further extensions
## Units of measurement
## Transport technologies
## Storage technologies
### Detailed storage constraints
### Aggregate storage constraints
## Footprint constraint
## Performance metrics and objective function

# Implementation

- Ontology database
- GAMS
- Java app
-->

<!--
- [TODO: ref metric paper] showed that so-called 'grey-box' metrics (i.e. exergy-based and ENA-based) provide particularly helpful insights on urban resource efficiency.
	- Background section on precedent modelling: justify chosen metrics (e.g. exergy) with respect to Ravalde and Keirstead (2015), and justify omission of cost (one reason, is that our data included future technologies, i.e. as yet uncosted. Futhermore, 'costable' processes still vary around the world, due to exchange rates and differences in purchasing power, and furthermore, will change as a f(time)).
-->

<!--
There is no doubt that modelling has helped planners and policy makers design systems to manage resources to optimal performance in cities. However, to date, energy, water and waste resources have been managed with their own separate modelling tools. But by neglecting the synergies between different resource types, these approaches limit the resource savings a city can make. Thus we have adapted @Keirstead2013a's urban energy systems model to introduce a new model which optimises an urban area's resource-technology management, by choosing an appropriate technology mix and a corresponding schedule of resource imports and exports. Using the database of @Ravalde2016, we have applied the model to a Chinese urban development case study, for [TODO: number] scenarios.

[TODO: discuss the middle of the system]
Despite a gallimaufry of urban metabolism models and resource optimisation models, there is still need for an integrated model, to meet ambitions for intersectoral urban synergies. We have begun this processes, developing @Keirstead2013a's model to create a generically defined [TODO: complete...]

In this paper, we have adapted the urban energy systems model of [TODO: cite Keirstead et al.] to formulate a new model which simultaneously optimises the management of energy, water and waste, to improve the metabolism of an area, and applied it to a new urban development in China, using data collected for @Ravalde2015b.

- Assume documentation gives peak values
	- Assume peak values at all times?
	- Calculate daily averages based on peaks?
	- Compartmentalise into peaks and averages?
-->

<!--
For the Appendix?

- Full mathematical formulation. I.e., in the main body, we only need to include the essential balance and process equations. Other constraints (e.g. limits on imports/exports can go in the Appendix).
- Demands
- Tabulate resource data (exergy, emissions, CF, WF Cost Revenue)
- Example black box process models
- Identify dummy processes (waste splitter, and waste generaliser, water splitter (recognising that higher quality waters can be used in lower quality applications)
- Example network configuration results
- Links to data, code and results on GitHub
- Summarised version of the demand data
- Link to GitHub/website of supplementary information
  	- CSV master table
	- R-script to produce data summaries, based on the master table's 'tidy' form.
	- Details on model formulation (comparison of performance, etc.)
	- Details on Shann Gu specific parameters (e.g. groundwater pumping, surface water availability, rainfall)
-->

## Appendix

\begin{table}[]
\centering
\caption{My caption}
\label{tab:tat-resources}
\begin{tabular}{@{}llllll@{}}
\toprule
Resource                         & Demand & Number of import zones & Notes        &  &  \\ \midrule
water\_source                    &        & 1                      & See appendix &  &  \\
water\_generated                 &        & 0                      & See appendix &  &  \\
water\_qualDomestic              &        & 0                      & See appendix &  &  \\
water\_waste\_treatmentDomestic  &        & 0                      & See appendix &  &  \\
water\_pumped                    & 111    & 0                      & See appendix &  &  \\
\textit{elec}                    &        & 4                      & See appendix &  &  \\
\textit{appUse}                  & 1585   & 0                      & See appendix &  &  \\
water\_qualLivestock             &        & 0                      & See appendix &  &  \\
water\_waste\_treatmentLivestock &        & 0                      & See appendix &  &  \\
meat\_raw                        &        & 4                      & See appendix &  &  \\
veg\_raw                         &        & 4                      & See appendix &  &  \\
manure                           &        & 0                      & See appendix &  &  \\
manure\_green                    &        & 0                      & See appendix &  &  \\
fishFeed                         &        & 4                      & See appendix &  &  \\
water\_irrigation                &        & 0                      & See appendix &  &  \\
petrol                           &        & 4                      & See appendix &  &  \\
biomassMedium                    &        & 4                      & See appendix &  &  \\
firewood                         &        & 4                      & See appendix &  &  \\
biomassWet                       &        & 0                      & See appendix &  &  \\
fish\_raw                        &        & 4                      & See appendix &  &  \\
\textit{heat\_domestic}          & 896000 & 0                      & See appendix &  &  \\
\textit{heat\_stove}             &        & 0                      & See appendix &  &  \\
hotWater\_domestic               & 111    & 0                      & See appendix &  &  \\
meat\_cooked                     & 1.8    & 0                      & See appendix &  &  \\
veg\_cooked                      & 117    & 0                      & See appendix &  &  \\
fish\_cooked                     & 0.07   & 0                      & See appendix &  &  \\
CO2                              &        & 0                      & See appendix &  &  \\ \bottomrule
\end{tabular}
\end{table}

\begin{sidewaystable}[]
\tiny
\centering
\caption{My caption}
\label{my-label}
\begin{tabular}{@{}lp{4cm}llp{4cm}llll@{}}
\toprule
\multicolumn{3}{l}{Conversion processes}                             & \multicolumn{3}{l}{Resources}                                                                     & \multicolumn{3}{l}{Transport processes}                                                                                           \\ \midrule
No.        & Added                                    & Abbrev.      & No. & Added                                                                             & Abbrev. & No. & Added                                                                            & Abbrev.                                  \\
1          & Dam                                      & Dam          & 3   & Water, Water (dam), Electricity                                             & TODO    & 1   & Cable                                                                            & Cab.                                     \\
2          & Water treatment (for livestock)          & WT (l/stock) & 5   & Water (livestock), Wastewater (livestock)                            & TODO    & 2   & Pipe (livestock water)                                                           & P (l/stock)                              \\
3          & Water treatment (for domestic use)       & WT (dom.)    & 7   & Water (domestic), Wastewater (domestic)                              & TODO    & 2   &                                                                                  &                                          \\
4          & Irrigation                               & Irrig.       & 8   & Water (irrigation)                                                                 & TODO    & 3   & Pipe (irrigation water)                                                          & P (irrig.)                               \\
\textit{5} & Pump                                     & Pump         & 9   & Water (pumped)                                                                     & TODO    & 4   & Pipe (domestic water)                                                            & P (dom.)                                 \\
\textit{6} & Agriculture                              & Agric.       & 17  & Vegetables, Manure, Green manure, Fish feed, Petrol, Biomass (medium moisture content), Biomass (wet), CO2 & TODO    & 8   & Vehicle (manure), Vehicle (green manure), Vehicle (petrol), Vehicle (vegetables) & V (man.), V (g/man.), V (pet.), V (veg.) \\
7          & Livestock                                & L/stock      & 18  & Meat                                                                         & TODO    & 9   & Vehicle (meat)                                                                   & V (meat)                                 \\
8          & Stove                                    & Stove        & 20  & Heat (stove), Firewood                                                             & TODO    & 10  & Vehicle (firewood)                                                               & V (f/wood)                               \\
9          & Biomass drying (medium moisture content) & BMD (med.)   & 20  &                                                                                   & TODO    & 10  &                                                                                  &                                          \\
10         & Biomass drying (high moisture content)   & BMD (wet)    & 20  &                                                                                   & TODO    & 10  &                                                                                  &                                          \\
11         & aquaculture                              & Aqua         & 21  & Fish                                                                         & TODO    & 12  & Vehicle (fish), Vehicle (fish feed)                                              & V (fish), V (f/feed)                     \\
12         & Cooking                                  & Cook.        & 24  & Meat (cooked), Fish (cooked), Vegetables (cooked)                                           & TODO    & 12  &                                                                                  &                                          \\
13         & Agricultural machinary                   & Agric. Mach. & 24  &                                                                                   & TODO    & 12  &                                                                                  &                                          \\
14         & Domestic appliances                      & App.         & 25  & Appliance use                                                                            & TODO    & 12  &                                                                                  &                                          \\
15         & Heating                                  & Heat.        & 26  & Heat (domestic)                                                                    & TODO    & 12  &                                                                                  &                                          \\
16         & Hot water                                & HW           & 27  & Hot water                                                                & TODO    & 12  &                                                                                  &                                          \\
           &                                          &              &     &                                                                                   &         &     &                                                                                  &                                          \\
           &                                          &              &     &                                                                                   &         &     &                                                                                  &                                          \\
           &                                          &              &     &                                                                                   &         &     &                                                                                  &                                          \\ \bottomrule
\end{tabular}
\end{sidewaystable}

\begin{description}

\item [Simplifications] help ensure the benchmark study is user-friendly:

\begin{itemize}
\item The commercial sector (i.e. the shops, which sells 'final goods') will be ignored. These goods are directly imported, and are thus not managed by processes, so add nothing to the benchmark study
\item Amalgamate all livestock (chickens, dogs, buffalo, and cows) into a single 'livestock' category which produces all livestock products in the village (meat, dairy, and manure).
\item Amalgamate all agricultural activities into a single 'agriculture' category which produces all agricultural produced in the village (firewood, swidden, green manure, vegetables)
\end{itemize}

\item [Assumptions] account for the fact that the literature does not resolve Tat's energy flows down to their final use:

\begin{itemize}
\item Tat's total electricity use are split equally between domestic, agriculture, and water pumping purposes.
\item Tat's total heat output  = 5375.6 GJ/year [TODO: check source]. Assume this is split between domestic heating, cooking, and domestic hot water
\end{itemize}

\item [Additions] give the benchmarking study greater ability to test different types of formulation:

\begin{itemize}
\item A dam is added to the village. This generates electricity from the river water. As shown below, this will enable two types of linear formulation, and one type of nonlinear to be compared for their performance.
\item Each household will include cooking, space heating, and hot water heating processes.
\item The literature does not provide any spatial information regarding the point of demand and the location of processes. In order that the benchmarking can consider spatial disaggregation, Tat will be divided into four zones (each of which have equal demands for resources).
\end{itemize}

\end{description}

<!--
- literature seeks to understand the socio-environmental aspects of rural living, through a metabolism study of Tat Hamlet
- 105 households
- Average size = 4.4 people
- 69 hectares of farmland
- Small river, to supply the paddy field
- mainly agricultural community:
	- Wet rice paddy fileds
	- Swidden cultivation
	- Livestock
	- Collecting products from the forest, including non-timber forest products (NTFP) such as bamboo shoots, cassava roots and Canna, sold to visiting traders.
- Electricity available since 2001
- Dirt road (parallel to the river)
- Houses use electricity, water
- Other services: education and shops
- Flows include (p.15):
  	- paddy and swidden fields inputs
  	- Livestock: feed, productions, livestock sold, bought and killed
	  	- water (for feeding and washing)
  	- NTFP
	- firewood
	- bamboo (for fire and construction)
	- Household artefacts
	- Lamp oil, batteries and candles
	- gasoline for motorcycles
- System components (p18)
  	- Atmospohere
	- Fishpond
	- Forest
	- Grasslands
	- Ground
	- Home/tree gardens
	- Household
	- Household assests
	- Houses
	- Human population
	- Livestock
	- Middleman
	- External markets
	- Public structures
	- Paddy fields
	  	- Need more water
	- Swiden fields (forest areas on mountain slopes, can't be fertilised)
	- Shop
	- Storage of seeds etc.
	- Swidden fields
	- Water bodies
	- Other

- Paddy and Swidden fields both belong to 59% of the houses, though 26% only have pddy, and 5% only swidden
- Average paddy size = 1160m2
- Average swidden size = 1770m2
- 78% engage in logging
- Buffalo (56%), cows (51%), and pigs (47%) for meat (a few goats, and chickens)
- Construction materials also present as stocks and flows
- Annual rainfall 1840 mm/year
- p.28
  	- Biomass: rice, swidden, fruit and feg, fish from fish ponds, time and bamboo from forest, NLTP, livestock grazing (interal, external, or imports)
	- Water: household, livestock washing and drinking
	- Fuel and process foods and constructon materials (importes)
	- Outputs (dispolas): fertilisers, fishpond feed
	- Outputs (biomass): timber, NTFP, livestock products, live animals, harvests
	- Wastes and emissons: feces, incinerated products, household and agricultural wasates, durables, fossil-fuel emissions, wastewater, water varpour from drying agricultural and forest products
- biomass is dried, and unsed residue is thrown away
- Fishponds belong to 80 hoseholds
- pipes transport water to the home (p38)
- 20 households use 696 l of water per day
  	- 60 litres to wash 2 pigs, 10 l to feed 2 pigs
- 530 tons of firewood per year
- 95 tons per year of bamboo used for cooking fuel
- 60 tons per year bamboo shoots (=food), 30 t are sold at market
- Green manure (for paddy fileds and fishponds): 9.1 tons per year
- plant roots (medicinal and food) = (2.3 + 0.9 tons per year)
- 930 tons per year land products
  	- 120 tons imported
	- 810 land products from paddy, swidden, homes gardens and fish ponds
- Domestic extraction of food (biomass) = 408 t/yr (of which rice is 97 t/yr). This corresps. to by products (e.g. leaves) of 405 t/yr (107 t/yr)
- Household food imports = 81 t/yr (another 2 tons per year for seeds etc.)
- Imported meat: 2.6 t/yr
- Final goods: 46 t/year (e.g. appliances, herbicide etc.)
- Fossil fules: 4 tons per year
  	- 2.9 t/yr for motorbikes
	- 0.87 t/yr for petroleum lighting
	- 0.37 t/yr lamp oil
	- 0.19 t/yr lubricant oils
- Outputs:
  	- Water: 2600 t/yr extracted and thrown away; 630 tons per year evaporated from biomass
	- Wood: 230 t/yr, bamboo: 52 t/yr (cooking fuel)
	- Fish fee (palm leaves and broom grass): 6.6 and 12 tons per year
	- Lnad products: cassava leaves (270 t/yr), grass (46 t/yr), bran (30 t/yr) for fish feed
	- Land products: cassava stems (49 t/yr) for fields
	- H/hold biomass waste and food (49 t/yr) + rice straw (9.4 t/yr)
	- Manure: 270 t/yr (fertilizer and fish feed)
	- Final good wastes and emissions: 36 tons per year
- Stocks (2001). Feed in brackets in t/yr (e.g. cassava leaves, rice bran, etc.)
  	- Buffalo: 107 (7.8) 
  	- Cow: 138 (85)
  	- Pig: 214 (265)
  	- Chicken: 1600 (43)
  	- Dog: 46 (22)
  	- Goat: 8
  	- Duck: 65 (5.6)
- Livestock products (t/yr):
  	- Eggs: 0.038
	- Manure: 270 (210 in fishonds, 55 on paddy fields, 2.5 for home gardens)
	- Chicken meat: 0.26
	- Duck meat: 0.0056
	- Buffalo meat: 3.1
	- Cow meat: 0.57
	- Pig meat: 0.49
	- Goat meat: 0.11
	- Dog meat: 0.077
- Livestock feed (t/yr):
	- Chicken: 43
	- Duck: 5.6
	- Buffalo: 7.8
	- Cow: 85
	- Pig: 265
	- Goat: -
	- Dog: 22
-->

---
title: 'Introducing the PRaQ model to optimise urban metabolism'
journal: "TBC"
author:
- name: 'Tom Ravalde\corref{cor1}'
  email: thomas.ravalde08@imperial.ac.uk
  group:
  address:
- name: James Keirstead
  email: j.keirstead@imperial.ac.uk
  group:
  address:
address-general: "Department of Civil and Environmental Engineering, Imperial College London"
biblio-files: "my-refs"
topline: (Draft.)
options: "review, authoryear"
date: \VCDateISO
css: /home/tr608/.pandoc/marked/kultiad-serif.css
abstract:
  "Cities have proved successful at increasing the quality of life enjoyed by a growing global population. However, they have not yet realised their potential to meet the needs or a population with more effecient resource management. Specifically, the dense nature of cities should enable the wastes and by-products of one process to be used as inputs to another, thus a level of demand for goods and services can be met, but with reduced resource consumption and waste output.\\

  One way that planners help to design resource management systems is to use optimisation modelling, which can help choose the processes, infrastructure, and operation schedules which meet demand subject to some minimum cost (financial, environmental, or other). While many models exist within individual resource sectors (e.g. energy supply or water distribution), our systematic and detailed survey of the literature shows that there are no models which consider multiple sectors in combination. In this paper, we formulate a model which simultaneously considers energy, water and waste management, such that cities may realise the resource-saving benefits of synergies in integrated resource management. We demonstrate the model via application to a new Chinese urban development. Our results show that..."

keywords: "TODO, TODO, TODO, TODO, TODO, TODO"
---

```{r Setup, include=FALSE, results="hide", warning=FALSE}
opts_chunk$set(fig.path = "figures/", dev=c("pdf", "png"), fig.pos='htbp', fig.width=5, fig.height=1.6, dpi=700, fig.show='hold', fig.lp="fig:", cache=TRUE, par=TRUE, echo=FALSE, results="hide", message=FALSE, warning=FALSE)

#library(extrafont)
#font_import(pattern="LinBiolinum")

```

\begin{footnotesize}
\wordcount
\end{footnotesize}

# Scratchpad {-}

- use: scenario analysis includes sensitivity analysis
- use: strategic planning can include policy, decision-making support
- use: system improvements can include problem identification (troubleshooting)
- TODO: try generating separate PNG and PDF figures, for HTML and PDF document outputs, respectively.

# Introduction 

Cities have proved key to humanity's success, by making a high quality of life possible for billions of people through the efficient provision of goods and services [@WorldBank2009]. However, to sustain their populations, cities consume large quantities of energy and water, and generate significant waste. This leads to environmental challenges such as water stress, global warming and land-use constraints [TODO: references]. As such, much effort has been devoted to improving urban sustainability.

To aid these efforts, researchers have looked to the urban metabolism (UM) concept, for a theoretical framework to understand how urban populations consume resources and generate wastes (and thus impact the environment). UM was introduced by @Wolman1965 as "all the material and commodities needed to sustain a city's inhabitants at home, at work and at play" (p156). Consequently, the UM concept has provided tools which help planners and policy makers improve urban sustainability (see for example the report for the UK Government by @Clift2015).

Another research field that is used in an effort to help cities meet demands for goods and services, is that of optimization modelling, in which a resource allocation/management problem is represented by sets of equations using known data, which are then solved to select an optimal mix, layout, and operation schedule for resource management infrastructure [TODO: reference], such as water pipes [TODO: reference], waste transportation [TODO: reference], and power plants [TODO: reference].

Among many possible solutions to cities' resource management challenges, ('smart cities', behavioural changes, renewable energy, etc.), one proposal is that cities adopt the principles of industrial ecology (IE) by taking advantage of their dense configuration, which means various resource management infrastructure are co-located, thus making possible synergies between different systems [TODO: reference]. In this way, the wastes and by-products of one process become the inputs to another (as seen in an energy-from-waste plant, for example). From the UM point of view, it is important to consider how technological processes within a city affect a city's overall metabolism, given that "the history of cities such as London clearly shows that technological change can lead to transformations of urban metabolisms" [@Clift2015, p50].

However, as we show in our systematic literature reviews below, among the many and varied UM-based modelling tools resource optimization models, little attention is given to how the processes work in combination to affect a city's overall metabolism. To capture these intersectoral synergies, we introduce a model which takes a 'process-oriented' view of urban metabolism [@Ravalde2016b], by integrating the planning of energy, water and waste management processes, using a Chinese urban development case study to show how an area's metabolism can be improved.

# Literature review/Background

[TODO: Intro both UM and optimization modelling more generally.]

Studies of an area's metabolism can take a number of forms, focussing on the different elements of an urban system summarized by @Ravalde2016's hierarchical representation illustrated in Figure \ref{fig:metab}. Resource demand and waste generation at the bottom drives aggregate resource exchanges between a city and the environment at the top. In the middle, are the processes which convert and transport resources. Often UM studies will compare the resource flows at the top between cities. Other times, these resource flows at the top will provide information to calculate other performance indicators, such as carbon footprint or ecological footprint. Elsewhere, UM studies can correlate flows at the top with socioeconomic factors, or urban form at the bottom. Finally, the UM concept can give rise to models which abstract the urban system (conceptually and/or mathematically) to help explain or predict the many relationships within an urban metabolic system. It is such modelling tools that are the focus of this section.

\begin{figure}
	\centering
	\begin{spacing}{1.0}
	\sffamily
	\resizebox{\columnwidth}{!}{\input{metab.pdf_tex}}
	\end{spacing}
	\caption{Heirachical representation of urban metabolism, which relates the top, middle and bottom metabolism components to Wolman's definition of UM. Figure adapted from \cite{Ravalde2015b}.}
	\label{fig:metab}
\end{figure}

In this section, we provide an overview of the current landscape of modelling tools for urban resource management. Our purpose is to identify where modelling considers intersectoral synergies.
We recognize the 'model' can be defined quite loosely, so we adopt [TODO: Cite Rosen]'s definition, which @Keirstead2012b summarizes as "a formalized representation of a natural system with its own internaly consistent rules ... we primarily mean mathematical models and computer codes". First we review models from the urban metabolism literature, however, resource management is not the sole interest of the UM field, and so in the second part of the review, we review resource management models more generally.

## Review of UM models

Our review starts by using the Scopus tool to search for relevant articles, using the search term **urban metabolism AND model OR modelling**. We exclude irrelevant subject areas (such as medicine) from the search[^search]. 

[^search]: The full search term is available at \\url{http://www.scopus.com/results/results.uri?sort=plf-f&src=s&st1=urban+metabolism+AND+model+OR+modelling&sid=A080B1BFA7BBE9DC169DA27B04E5945E.f594dyPDCy4K3aQHRor6A%3a150&sot=b&sdt=cl&cluster=scosubjabbr%2c%22MEDI%22%2cf%2c%22BIOC%22%2cf%2c%22PHAR%22%2cf%2c%22NURS%22%2cf%2c%22CHEM%22%2cf%2c%22NEUR%22%2cf%2c%22IMMU%22%2cf%2c%22MATH%22%2cf%2c%22BUSI%22%2cf%2c%22ARTS%22%2cf%2c%22PSYC%22%2cf%2c%22HEAL%22%2cf%2c%22MULT%22%2cf%2c%22VETE%22%2cf%2c%22Undefined%22%2cf&sessionSearchId=A080B1BFA7BBE9DC169DA27B04E5945E.f594dyPDCy4K3aQHRor6A%3a150&origin=savedSearchNewOnly&txGid=A080B1BFA7BBE9DC169DA27B04E5945E.f594dyPDCy4K3aQHRor6A%3a15}]

This step returned 239 results which was manually reduced to 108, by removing articles which were  inaccessible, not published in English, only tangentially related to UM, or did not use the definition of 'model' as we have understood it. Looking further at the remaining results, we classified each paper according to three three categories: model focus, modelling techniques, and model use. Figure \ref{fig:UM-model-lit} plots each paper as a point which is located according to its whereabouts within the two dimensions. We outline the model focus and technique categories below, with reference to models in our literature review (which are marked on the plot using text labels), before summarizing the UM modelling landscape, noting features and gaps.

```{r metab-lit-review, results="asis"}
###--------------------------------------------------
## PREPROCESSING
### From lit-metab-modelling.csv, we used R to remove rows with states!="cut")
### From lit-keep-maybe.csv, we summarised the attributes for each paper, and identified more papers to cut
### We are left with lit-final-cut.csv, which is used below
###--------------------------------------------------

###--------------------------------------------------
### Set up the database for cluster analysis
###--------------------------------------------------

### Load in literature titles and attributes, removing the remaining papers marked 'CUT'
lit_draft_cut <- read.csv("lit-final-cut-alt.csv")
lit_final_cut <- filter(lit_draft_cut, type!="CUT")

## TODO: merge some of the model use groups together for clarity (e.g. include 'other' grouping)

## Only keep variables relevant for our cluster analysis
lit_final_cut <- select(lit_final_cut,
			c(Title, type, techniques.broad, techniques, techniques.IO, techniques.other, focus.broad.cat, focus.broad, focus, focus.multiple, focus.other, use, use.other, text.label))

```


```{r metab-lit-review-plot, fig.height=5, fig.width=8, fig.cap="An overview of the UM modelling literature.\\label{fig:UM-model-lit}"} 

###--------------------------------------------------
### Select and order attributes for ordinal data
### E.g. for plotting, it is helpful for "Low-level", "Medium-level", and "High-level" to appear in this order
###--------------------------------------------------

## Select attributes to be plotted in the analysis
lit_main_cats <- select(lit_final_cut, c(type, techniques.broad, techniques, focus.broad.cat, focus.broad, use, text.label))

## Order attributes for ordinal data (e.g. for plotting, it is helpful for "Low-level", "Medium-level", and "High-level" to appear in this order)
lit_main_cats <- transform(lit_main_cats,
			   type=factor(type,
			     levels=c("conceptual", "mathematical", "various"),
			     ordered=TRUE),
			   techniques.broad=factor(techniques.broad,
			     levels=c("Low-level", "Medium-level", "High-level", "statistical", "misc."),
			     ordered=TRUE),
			   techniques=factor(techniques,
			     levels=c("Bottom-up mathematical description", "ENA", "integrated", "LCA", "mass and/or energy balance", "mathematical representation of subsystems", "other", "ratios", "regression", "relate actors", "relate various", "various")),
			   focus.broad.cat=factor(focus.broad.cat,
			     levels=c("resource", "other", "methodology"),
			     ordered=TRUE),
			   focus.broad=factor(focus.broad,
			     levels=c("single resource", "multiple resources", "integrated", "form", "socioeconomic", "environment", "methodology"),
			     ordered=TRUE),
			   use=factor(use,
			     levels=c("accounting", "forecasting", "other", "scenario analysis", "strategic planning", "system understanding/improvements", "theory")))

###--------------------------------------------------
### Plot results to identify clusters
###--------------------------------------------------

plot_cluster <- ggplot(lit_main_cats, aes(y=focus.broad, x=techniques.broad)) +
  geom_jitter(aes(colour=factor(use)), width=0.1, height=0.1) +
  geom_text(aes(label=text.label, colour=factor(use)), size = 2) +
  theme_bw() +
  theme(axis.text.x = element_text(hjust=1, angle=30),
	legend.position="bottom",
	legend.direction="vertical") +
  guides(col=guide_legend(ncol=2)) +
  xlab("Modelling techniques") +
  ylab("Model focus") +
  scale_colour_discrete(name="Model use")
#  facet_wrap(~focus.broad.cat, scales="free_y", ncol=1)
plot_cluster
```

### Focus (horizontal axis)

Models have different foci. Some consider a **single resource** (such as @Zeng2014, who simulate urban water flows among various facilities and end uses), while others consider **multiple resources** such as @Liang2011 who model how various energy and material flows including coal, water, biomass and pollutants, change under proposed policies. Thirdly **integrated** models unite multiple resource types under a single value system, such as @Huang2005 who use *emergy* to encapsulate various flows including solar energy, rain, and fossil fuels.

Non-resource foci include models which examine a city's **form**, for example  @Liang2014 describes how a city's quantity of steel stock can be related to the level of nighttime lighting. Next are the models with a **socioeconomic** focus, such as @Newman1999a, who makes a conceptual addition to the UM idea, by including 'livability' as something that is affected by resource flows and urban form. Finally, other models focus on the **environment**, for example @Ye2011 relate household construction and characteristics to greenhouse gas emissions.

### Techniques (vertical axis)

In our classification of models according to approach they take, we have used four [TODO: word]. The **statistical** category use regression models to relate different UM variables. For example @Liang2014 relates a city's building steel stock to long-term nighttime lights. The remaining categories refer to UM models in which some part of a UM system's dynamics are represented (either conceptually or mathematically). Such a system can be broken into component parts at different levels. At the most detailed level, the **low** categorisation captures models which quantify energy and mass balances among the processes and sectors within an urban system, such as @Zeng2014 who calculate water flows between different sectors (domestic, industrial etc.) and systems (supply, treatment etc.). Alternatively, this could denote models where equations for bottom-up mathematical descriptions of system components (e.g. emissions sources) @Kellet2013, which builds up emissions from building, transport, human, and vegetation sources.

At the next level of detail, the **medium** level categorisation denotes models in which conceptual or mathematical relationships are defined for a UM system's organisational sectors and socioeconomic elements. For example, @Zhang2010a uses ecological network analysis to relate the resource flows of 17 economic sectors to each other, while @Fung2005 relates an area's institutional activities to its sustainability, and @Huang2005 relates energy flows to urban development.

Finally, the **high** level categorisation captures system dynamics in their broadest sense, using ratios. For example, relating society size and transport volumes as in @Fischer-Kowalski2004's model, or calculating a long-term time series for sectoral energy demand based on the upstream energy consumption data as in @Baynes2012a.

- **misc.**: these models include input-output analysis, decomposition analysis,and scaling laws, amongst other methods. [TODO: lots of these could be reassigned to a level?]
<!--

[TODO: probably delete this excess detail on some specific models]

#### Specific methodology: BRIDGE

- Applying sustainability metrics (i.e. not market logic) to urban planning -- the BRIDGE methodology: http://www.iacm.forth.gr/papers/2008_Chrysoulakis.pdf
  	- "will provide the means toquantitative estiamte the various components of the urbam metaoblism..., the means for quantitative estiamte their impacts..., as well as the means for resource optimisation in urban fabric...
	- Figure 1 provides a useful overview
- BRIDGE use of ICT: http://enviroinfo.eu/sites/default/files/pdfs/vol122/0175.pdf
  	- Decision support system (DSS)
	- An ICT supported "bottom-up" approach (monitoring, simulations, databases, GIS, IE, DSS etc.)
	- BRIDGE DSS integrates "bio-physical observations with socio-economic data and models"
	- Resource optimisation considered separately though (p177): Energy, Water, Carbon and pollutants

#### Specific methodology: SUME

- E.g. SUME relating spatial form, to overall flows: http://sume.at/webfm_send/88, http://www.foresight-platform.eu/wp-content/uploads/2012/06/EFP-Brief-No.-219_Sustainable-Urban-Metabolism-for-Europe.pdf
-->

### Summary of urban metabolism modelling

Figure \ref{fig:UM-model-lit} gives an overview of the UM modelling landscape. The clusters indicate some common trends between UM models, such as the weighting of **low-level** models to consider a **single resource** in **scenario analysis**; and the trend of **medium-level** models to be used in **system understanding/improvements**. But it also highlights gaps. As we return to this paper's theme of cities making use of intesectoral synergies between resource management processes, we examine more closely the **low-level** **multiple-resources** segment (shaded on Figure [TODO: cross-ref]), we note two models.

First, @Villarroel2009 develops a model to conduct mass/energy-based substance flow analysis (SFA) to investigate the nitrogen cycle within a region under different scenarios of urine separation. This work is **multi-resource** because it tracks flows wthin water, forestry, food, energy, and waste management sectors. It is **low-level** because it is built at the level of individual flow (e.g. biomass, sewage sludge, fossil fuels, etc.) and processes which mix, seprarate or transform flows (e.g. power generation, wastewater treatment, etc.). This method can track the accumulation of N, P, and C, identifying a pinpointing a system's influential flows, and how system changes can make improvements. The model is applied to a case study in Georgia, testing how separation of household urine affects nitrogen flows.

Second, is the model developed by @Procter2015 to assist decision makers achieve 100% renewable energy, zero waste to landfill, and zero water resource depletion (hence **multi-resource**, on Fort Carson military base by 2020. The model is **low-level** as it uses mathematics to simulate resource flows into and out of various processes. The model is used to test eight scenarios (e.g. population growth, water reclamation schemes etc.) to examine links between energy, water and waste management exemplified as synergies and trade-offs: A waste-to-energy plant exemplifies the former through diverting waste from landfill to energy generating purposes, but the latter inasmuch as they increase water requirements.

The @Villarroel2009 and @Procter2015 models show by precedent the possibility of **low-level** **multi-resource** UM models which use mass and energy balances to track the flow of various resource types through various processes, to inform system interventions and development. However, as we turn to consider a city as a whole, there is a clear gap for such models which consider regions larger than a military base, and in a more generalised form, considering UM more broadly. (There may of course be other identifiable gaps which can form the basis of future research.)

@Zhang2013 has traced the history of how UM is understood, starting with @Wolman1965 who proposed a linear model, where a city was viewed as a black-box into and out of which resources flowed. This idea was developed by @Giradet1990, who suggested UM could be understood cycliclally, with some of the black-box city's outputs being reused is inputs. Finally, @Zhang2009 opened up the black box, adding the notion of a network of processes which manage the resources. However, this has mainly been understood in terms of economic sectors (e.g. @Zhang2009 and @Zhang2009a), using the input-output methodologies of of @Leontief1951. As such, @Ravalde2016 proposed that the networked process understanding of UM could also be understood as an engineered system, made up of resource management processes. Our findings correspond with the view of others in the field.

We might summarise UM's research gap by quoting the recent work of @Fernandez-Mena2016, who researched the UM literature for a method to model nutrient flows in agro-food systems. They found that UM models:

> "... may seldom consider a whole mass balance since some flows are sometimes not quantified and do not always follow elements  along their whole cycle... The poor mechanistic basis underlying urban metabolism may prevent their use for exploring and simulating options for more efficient recycling loops within social ecological systems."

In summary, modelling is used for many and varied purposes within urban metabolism, but our exhaustive search of the metabolism-modelling literature has shown that there are no process-based models which integrate the management of energy, water and waste resources (the closes work being that of @Procter2015). Thus work must be carried out in the area in order to meet calls for IE perspectives on UM [@Clift2015] which (for example) identify future sustainable urban technologies.

<!--
Integrating energy, water and waste areas. System dynamics are simulated, e.g. water requirements in WTE (which can be adjusted), and demand for energy, water, and waste generation, with these management sectors linked. Testing eight scenarios, identifying trade-offs and synergies (e.g. WTE plant both a synergy (waste/energy) and a trade-off (increased wataer), energy-water conservation eshcemes ("no synergies appear across all three schemes), water reclamation
	- not optimisation
	- not very general (specific to the Fort Carson case, from a limited set of process options)
	- not forward looking (e.g. hydrogen)
	- focussed on the Fort William case, and not UM more generally.
	- futher work suggests adaption to civilian communities

Each of these models use mass/energy balances to inform 
-->
<!--
- Note key content of Kennedy paper [TODO: cite An integrated macroeconomic model for assessing urban sustainability], on limitations of urban metabolism models. We can add our own reflections: it's possible to have same/similar economic activity (the bottom), but different environmental impacts, because the system-middle is different. (Obviously this simplifies a little, by assuming that the middle != f(bottom) and bottom != f(middle).)

- In top/middle/bottom terms, the current UM 'modelling' landscape looks like this:
	- Relating models to the top/middle/bottom (summary table with top, middle, bottom, top-bottom etc. row headings)
	- "Because quantification of urbam emtabolism in all flows in complex, some researchers have focused on the metabolism of a single flow such as energy metabolism..." [<< TODO: find source of quote]
-->

	- Section 4.3 of http://pubs.acs.org/doi/pdf/10.1021/acs.est.5b03060 describes modeling methods in UM. Three ways to get inside the black-box "to highlight the relationships among the urban system's components, quantify both direct and indirect consumption of resources, and assess the influence of the human system on the natural environment":
	  	- LCA???
	  	- upstream I-O analysis, deriving physical values from monetary (economic data more readily available)
	  	- ENA "to account for both direct and indirect flows", abstracting a city as a "network of nodes", and can be combined with EFA and MFA analysis
	- Section 6 of http://pubs.acs.org/doi/pdf/10.1021/acs.est.5b03060 gives 'Future developments':
	  	- "a systems engineering approach should be introduced to unify and standardize the methods of categorizing and quantifying data; to establish databses that will support investigation analysis, and evaluation,...,..."

		- "Other research should seek ways to decrease the magnitude of flows by ... the establishment of closed-loop resource utilizatation plans"
		  	- References http://onlinelibrary.wiley.com/doi/10.1111/jiec.12144/abstract:
		- Proposes "biological, human, and *technical* solutions...The technical solutions are practical techniques and measures that can be taken to reduce resource consumption and waste emission and to increase waste recycling, with the goal of promoting a transformation from the current economic system to a more sustainable industrial ecosystem." Then notes these three components are linked.

<!--
[NOTE: paragraph below summarises the requirements of our model, using the language of the top-middle-bottom.]

This representation can inform the requirements of our model. It should take as inputs:

- *Bottom.* demands (for "work and play"), e.g. electricity, heating, potable water.
- *Top.* resource availability (e.g. local groundwater supplies, biomass supplies). As this represents "aggregate exchanges with the environment", this also includes landfill capacity etc.
- *Middle.* This is what our model will optimise (according to some objective). However, some information about the middle will be required:
  	- existing processes
  	- allowable 'new' processes
	- allowable resource transport links (roads, pipes, cables etc.)
  	- layout/allowable imports
- *Other.* 
- *Options.* Temporal disaggregation (e.g. seasons) and spatial resolution (e.g. zones).

meaning this work can only use the concepts of UM to simulate nutrient flows in agr-food systmes.

Another way to summarise:

- Models which relate top and bottom
- Models which analysis bottom
- Models which analyse middle, from an economic perspective (as economic sectors)
- But not models which analyse middle, from an engineered perspective (as resource management processes) 
-->

## Review of resource optmisation modelling

As we show above, a process-oriented approach to urban metabolism modelling is currently lacking. However, there do exist process-oriented models which plan the management of resources outside the urban metabolism literature, namely within application of optimization modelling to resource management. This type of modelling aims to maximise some quantity associated with a real-world problem (e.g. profit from product manufacture). The problem is modelled by a set of linear and/or nonlinear equations whose variables represent unknown decisions (e.g. the quantity of a given product to be produced by a particular process), which can themselves by bounded by other equations representing real-world constraints (e.g. maximum daily machine output). Mathematical routines operate on the equations to choose the variable values which maximise a quantity of interest. @Williams1999.

Within the resource management field, such optimization modelling is used to help plan urban energy supply. One example is that of @Keirstead2012, whose model evaluates energy supply for a UK eco-town, focussing on the potential benefits of biomass-based systems. A set of linear equations represent the resource quantities (e.g. biomass, heat, electricity, etc.) supplied to and removed from zones within the town at any given time. Parameters represent the zonal resource demands, resource availability, and technology behaviour. Variables represent whether a technology is present in a given zone, and at what rate is operates, as well as a schedule of resource movements within and without the city. Similar types of models exist for water supply networks (e.g. @Lim2010), and waste management planning (e.g. @Li2006).

Below we conduct a systematic literature review of the resource management optimisation literature, extending to another field, our search for models with apply IE principles to seek intersectoral synergies for urban energy, water and waste planning.

### Review methodology

Our review starts by once again using the Scopus tool to search for potentially relevant literature, using the search term **energy AND water AND waste AND optimization model**, excluding irrelevant subject areas (such as psychology) from the search [^search-res-models]. 

[^search-res-models]: The full search term is available at \\url{http://www.scopus.com/results/results.uri?sort=r-f&src=s&sid=492559A18BFC5EDC7C12FF9547004CF1.fM4vPBipdL1BpirDq5Cw%3a100&sot=a&sdt=cl&cluster=scosubjabbr%2c%22CHEM%22%2cf%2bscosubtype%2c%22ar%22%2ct%2bscosubjabbr%2c%22BIOC%22%2cf%2c%22MATE%22%2cf%2c%22PHYS%22%2cf%2c%22MEDI%22%2cf%2c%22IMMU%22%2cf%2c%22MATH%22%2cf%2c%22SOCI%22%2cf%2c%22ECON%22%2cf%2c%22PHAR%22%2cf%2c%22NURS%22%2cf%2c%22VETE%22%2cf%2c%22ARTS%22%2cf%2c%22HEAL%22%2cf%2c%22NEUR%22%2cf%2c%22PSYC%22%2cf%2c%22Undefined%22%2cf&sessionSearchId=492559A18BFC5EDC7C12FF9547004CF1.fM4vPBipdL1BpirDq5Cw%3a100&origin=savedSearchNewOnly&txGid=492559A18BFC5EDC7C12FF9547004CF1.fM4vPBipdL1BpirDq5Cw%3a10}.

```{r model-lit-review-load, results="asis"}

## Packages required by our analysis of the literature
library(tm)
library(dplyr)
library(ggplot2)
library(reshape2)

## Load in all titles
lit <- read.csv("lit-resource-modelling.csv")
titles <- as.character(lit$Title) # The unedited paper titles
```
This step returned 6,840 results, which we filtered and categorised based on each title's content, to identify (i) the scale at which the model is applied (e.g. chemical plant, urban area), and (ii) the resource types considered in the optimization. We automatically removed any titles which did not contain words related to 'optimization' [TODO: add footnote with URL], and then removed other irrelevant papers manually. Next, we operated on the whole corpus of titles to remove common words (e.g. 'the'), before identifying 11,967 unique words. From this automatically generated list, we manually removed words which did not refer to resources (e.g. 'network'), leaving 366 unique words.

```{r model-lit-review-tm, results="asis"}

## Merge titles into single block of text
text_full <- paste(titles, collapse=" ")

## Edit the text for mining
text_source <- VectorSource(text_full)
corpus <- Corpus(text_source)
corpus <- tm_map(corpus, content_transformer(tolower))
corpus <- tm_map(corpus, removePunctuation)
corpus <- tm_map(corpus, stripWhitespace)
corpus <- tm_map(corpus, removeWords, stopwords("english"))

## Create the document-term matrix, and count word frequency
dtm <- DocumentTermMatrix(corpus)
dtm2 <- as.matrix(dtm)
frequency <- colSums(dtm2)
frequency <- sort(frequency, decreasing=TRUE)

## Create dataframe of word frequency
words <- names(frequency)
freq <- as.data.frame(frequency)$frequency
word_freq <- data.frame(words, freq) # 11,967 unique words in total

## Save word-frequency list for manual editing
write.csv(word_freq, "words-pre-cut.csv", row.names=FALSE)
```

```{r model-lit-review-listReduction, results="asis"}

###--------------------------------------------------
### Manually reduce the list of words (removing those which don't refer to resources, e.g. 'network')
##### Original list: words-pre-cut.csv (11,967 unique words)
##### Reduced list: words-post-cut.csv (366 unique words)
### Manually categorise remaining words (e.g. "electricity" --> "energy"), and store in word-cats.csv
### Apply word-frequency analysis to identify:
##### (A) the number of word matches for each title
##### (B) the number of category matches for each title
### Plot and save results
###--------------------------------------------------

## Load manually-reduced database of word frequencies
word_freq_cut <- read.csv("words-post-cut.csv")

```

To each listed resource, we attribute a category, denoting which sector it is in. For instance, 'heat' would be categorised as 'energy'[^unique-words]. The other categories we use are 'water', 'waste', and 'other' [TODO: check this]. Then, using R code we identify the resource categories represented by each title [TODO: provide a worked example?]. Finally, for each title, we study the literature and identify the scale to which optimization modelling is applied (e.g. a chemical plant, or a city etc.). Figure \ref{fig:resOpt-model-lit} plots each literature item, according to their scale, and the resource categories they consider.

[^unique-words]: This list of resources and their categories is supplied at [TODO: add URL].

```{r model-lit-review-categs, results="asis"}

## Load in categorisation of words
word_cats <- read.csv("word-cats.csv") ## TODO: Remove the 'nonresource category'
```

```{r model-lit-review-categMatches, results="asis"}

## List of words to match
text_cut <- read.csv("text_cut.csv")$word

## Set up vectors to store the results of the word-frequency analysis
T <- length(titles)
word_matches <- length(T)
cat_matches <- length(T)
cat_matches_list <- length(T)
optim <- rep(1, T)

## Loop over all titles, to identify the number of matching words
for(i in 1:T){

  ## Convert title into a vector where each word is a unique element
  title <- titles[i]
  title <- tolower(title) # Convert to lowercase
  title <- gsub("[[:punct:]]", " ", title) # Replace punctuation with spaces
  title <- unlist(strsplit(title, split=" ")) # Convert to vector

  ## For each title, count the number of words matching those in our list
  intersections <- intersect(title, text_cut)
  word_matches[i] <- length(intersections) ## a vector of how many matching words

  ## For each title, identify the number of unique categories containing the matched words
  categs <- filter(word_cats, words %in% intersections)

  ## For each title, count the number of unique categories containing the matched words
  cat_matches[i] <- length(unique(categs$category))

  ## For each title, list the unique categories containing the matched words
  categs_list <- as.character(sort(unique(categs$category)))
  categs_list <- paste(categs_list, sep="", collapse=", ")
  cat_matches_list[i] <- categs_list

  ## Identify the titles with 'optimi[s/z]ation', or similar
  optims <- match(c("optimization",
	  	 "optimisation",
	  	 "optimized",
	  	 "optimised",
	  	 "optimal"), title)

  if(all(is.na(optims)) == TRUE){
    optim[i] <- 0
  }

}

## Store results for each title in dataframe
title_matches <- data.frame(titles, word_matches, cat_matches, cat_matches_list, optim)
```

```{r model-lit-review-plot, results="asis"}
## Save titles and category matches (in original order)
write.csv(title_matches, "title-matches-original-order.csv", row.names=FALSE)
```

```{r model-lit-review-optimReduction, results="asis"}

## As above, but just the titles containing 'optimization' and similar words
title_matches_optim <- filter(title_matches, optim==1)
write.csv(title_matches_optim, "title-matches-optim-original-order.csv", row.names=FALSE)

## Save titles and category matches (sorted according to the frequency of category matches)
title_matches <- arrange(title_matches, desc(cat_matches))
write.csv(title_matches, "title-matches.csv", row.names=FALSE)
```

```{r model-lit-review-categMatchFreq, results="asis"}

###--------------------------------------------------
### Make dot plot of category combinations in the literature
###--------------------------------------------------

## Get frequency of each combination of categories
combo_freqs <- data.frame(count(title_matches, cat_matches_list))
names(combo_freqs) <- c("Combinations", "CatFreq")

## Get frequency of 'optimization' within each category
optim_freqs <- title_matches %>% group_by(cat_matches_list) %>% summarize(sum(optim))
optim_freqs <- data.frame(optim_freqs)
names(optim_freqs) <- c("Combinations", "OptimFreq")

combo_freqs <- merge(combo_freqs, optim_freqs)

## Incorporate the number of categories for each combination (so plot can be faceted according to this)
tmp <- title_matches[!duplicated(title_matches$cat_matches_list), ]
tmp <- select(tmp, c(cat_matches_list, cat_matches))
names(tmp) <- c("Combinations", "n")
combo_freqs <- merge(combo_freqs, tmp)

## Create a column of titles (to be printed as facet_wrap strip titles)
combo_freqs$NumCats <- combo_freqs$n
combo_freqs[combo_freqs$n==0, ]$NumCats <- "Zero category matches"
combo_freqs[combo_freqs$n==1, ]$NumCats <- "One category match"
combo_freqs[combo_freqs$n==2, ]$NumCats <- "Two category matches"
combo_freqs[combo_freqs$n==3, ]$NumCats <- "Three category matches"
combo_freqs[combo_freqs$n==4, ]$NumCats <- "Four category matches"
combo_freqs[combo_freqs$n==5, ]$NumCats <- "Five category matches"

## Sort so number of categories will be faceted in ascending order
combo_freqs$NumCats <- factor(combo_freqs$NumCats,
			  levels= combo_freqs$NumCats[order(combo_freqs$n)])

## Sort so combination frequencies will be plotted in ascending order
combo_freqs$Combinations <- factor(combo_freqs$Combinations,
			  levels= combo_freqs$Combinations[order(combo_freqs$CatFreq)])

## Reshape so that CatFreq and OptimFreq can both be plotted as points
combo_freqs <- select(combo_freqs, -c(n))
combo_freqs <- melt(combo_freqs, id.vars=c("Combinations", "NumCats"), value.name="Frequency")
```

```{r model-lit-review-reduction, results="asis"}

###--------------------------------------------------
### POST-PROCESSING
### Copy title-matches-optim-original-order.csv --> title-matches-optim-original-order-edit.csv,
### (A) manually identify irrelevent papers with 'CUT'
### (B) assign a scale (e.g. 'domestic', 'regional' etc.) to each paper
### This is so we can analyse the content of the remaining papers
###--------------------------------------------------

title_matches_edit <- read.csv("title-matches-optim-original-order-edit.csv")
```

```{r model-lit-review-categMatchPlot, fig.height=5, fig.cap="An overview of the resource optimization modelling literature.\\label{fig:resOpt-model-lit}"}

###--------------------------------------------------
### Plot overview of literature
###--------------------------------------------------

## Remove the single category matches
lit <- filter(title_matches_edit, cat_matches!=1)

## Only keep the relevant literature
lit <- filter(lit, notes!="CUT")

unique_levels <- unique(lit$level)
unique_cats <- unique(lit$cat_matches_list)

## Sort so levels are plotted in ascending order
lit <- transform(lit,
		 Scale=factor(Scale,
		   levels=c("component",
			    "domestic", 
			    "plant",
			    "plant (multiple components)",
			    "plant (couple)",
			    "refinery/chem. plant",
			    "EIP",
			    "city",
			    "region",
			    "agricultural area",
			    "global",
			    "various"),
		    ordered=TRUE),
		 cat_matches_list=factor(cat_matches_list,
		   levels=c("various, waste",
			   "various, water",
			   "waste, water",
			   "energy, various",
			   "energy, waste",
			   "energy, water",
			   "energy, various, waste",
			   "energy, various, water",
			   "energy, waste, water",
			   "energy, water, waste",
			   "various, waste, water",
			   "energy, various, waste, water"),
		    ordered=TRUE))

## Add column to colour the points within the site and the city regions
lit$colour <- "noColour"
lit[lit$Scale=="region", "colour"]  <- "colour"
lit[lit$Scale=="city", "colour"]  <- "colour"
lit[lit$Scale=="EIP", "colour"]  <- "colour"
lit[lit$Scale=="refinery/chem. plant", "colour"]  <- "colour"


## Plot as dot plot: no. of categories vs. level (both ordinal factors)
plot_lit <- ggplot(lit, aes(Scale, cat_matches_list)) + 
#  geom_jitter(aes(colour=colour)) +
  geom_jitter(aes(colour=focus)) +
#  facet_wrap(~cat_matches, scale="free_y", space="free", ncol=1) +
  facet_grid(cat_matches ~ ., scale="free_y", space="free") +
  theme_bw() +
  theme(axis.text.x = element_text(hjust=1, angle=30),
	legend.position = "bottom",
	legend.direction="vertical") +
  guides(col=guide_legend(ncol=2))
plot_lit
```

### Summary of optimisation modelling

Figure \ref{fig:resOpt-model-lit} overviews the landscape of resource optimization modelling. The distribution of points can identify trends and gaps. For example, optimizing energy plus some other resource is the dominant practice, especially for systems smaller than a chemical plant. Zooming in on this paper's interest in modelling intersectoral synergies in urban resource management, we are interested the existence of models which optimize multiple resources at scales from **refinery/chem. plant** to **region**, inclusive, indicated by the non-green points. At these scales, there tend to be multiple resource types involved in exchanges among various processes.

Examining these titles, it is clear that there are no models which address the opportunity to simultaneously plan energy, water, and waste management in order to improve an area's metabolism. The models to most closely meet these ambitions are for eco-industrial parks (**EIP**s), where models try to realise maximum benefit from IE possibilities, to identify the most beneficial energy and material exchanges between processes [TODO: cite an example?]. However, as the review article by @Boix2015 notes, these models emphasize "...either the water network, or the energy links or waste disposal facilities but never the whole networking" (p.314). Similarly, the **city** scale models tend to focus on the integration of energy with some other system or integrating water networks into existing systems. Similarly, the **regional** scale models do not consider energy-water-waste system synergies as a whole.

In summary, optimisation modelling is used for many purposes to help plan resource management. However, our exhaustive search of the literature how shown that no models are appropriate to consider urban energy, water and waste management simultaneously, to realise synergistic benefits. Nevertheless, they do model multiple resource optimisation at suitable scales, to make the idea of such a model plausible (at least from an engineering point of view, if not one of free-market economics.

<!--
[TODO: cite Optimal design for heat-integrated water-using and wastewater treatment networks]

- simultaneous water-using network, wastewater treatment network, and heat exchanger network integration
- general superstructure
- MINLP to minimize total ananual network cost
- captures trade-offs "between freshwater usage, hot and cold utilities consumption, and capital cost of heat exchangers (HEs) and wastewater treatment units (TUs)."
- Mass and energy balances, heat transfers, 
- Assume the example is some sort of plant

[TODO: cite Biomass to liquid transportation fuels (BTL) systems: Process syntheses and global optimization framework]

- biomass gasification -> syngas -> hydrocarbons
- simultaneous heat, power, and water integration, to associasted costs of utility production and wastewater treatment can be included
- MINLP
- 24 case studies examine effects of "refinery capacity, liquid fuel composition, and biomass feedstock on the overall system cose, the BTL refinery topological design, the process material/eerngy balances, and the lifecycle greenhouse gas emissions."

[TODO: cite Simultaneous side-wide energy, waste and production optimiztion -- industrial case studies]

- (fourth resource is a water treatment system)
- petrochemical site
- material and energy balaances, with variable bounds, to maximise profit
- looks at specific cases (e.g. increasing ethylene cracker (ETY) production capacity)

[TODO: cite Optimization methods applied to the design of eco-industrial parts: A literature review]
	
- heuristics (small problems), optimization methods (larger, more copmlext problems)
- a lack of multi-objective optimization approaches (need for social function, e.g. job creation)
- "In the literature review, it is emphasized that authors optimized either the water network, or the energy links or waste disposal facilities but never the whole networking." (Data as a barrier to this.)
- Lack of multiperiod, consideration of available natural resources, etc.

### Other notes

- Definition of 'high-level' [TODO: is superstructure a better alternative?] : can be diagramatically represented as a state-task network (processes and resources), where the subject of the optimization is, at the very least, the quantities of resource exchanges along each vector.
-->

### Summary

Our systematic literature reviews of both UM modelling and resource optimization modelling have identified a space to contribute a model which simultaneously optimises energy, water and waste management, to promote IE-inspired synergies which improve an area's overall metabolism.

In relation to @Ravalde2016's representation of UM [TODO: figure cross-ref], such a model will optimise a system's middle, in order to meet demand at the bottom, with the resource availability at the top.
<!--
In summary, while 'modelling' is a common activity in urban metabolism, and models are increasingly used to examine the middle of the system, there still a need for models which consider the middle as an engineered system (rather than economic), and the *whole* of the middle (not just a single sector, such as energy). In the next section we will review existing models which optimize resource consumption in the energy, water and waste sectors, to influence a method we can use in our integrated model.
-->

# Formulation/Model specification

<!--
- [TODO: ref metric paper] showed that so-called 'grey-box' metrics (i.e. exergy-based and ENA-based) provide particularly helpful insights on urban resource efficiency.
	- Background section on precedent modelling: justify chosen metrics (e.g. exergy) with respect to Ravalde and Keirstead (2015), and justify omission of cost (one reason, is that our data included future technologies, i.e. as yet uncosted. Futhermore, 'costable' processes still vary around the world, due to exchange rates and differences in purchasing power, and furthermore, will change as a f(time)).
-->

- [TODO: ref metric paper] complied a database
	- Background section on data: citing Ravalde and Keirstead (2015, forthcoming).

Our models will be based on the model by @Keirstead2013a which we introduced earlier, which itself is based on the chemical engineering State-Task Network model of @Kondili1993, in which processes ('tasks') convert materials from one 'state' to another. Keirstead's model applies the same principles to urban energy systems in a so-called Resource-Technology Network (RTN), developing a model which chooses the mix of processes that uses available resources to meet demand for heat and electricity. The State-Task network model is highly generalised (i.e. all conversion processes are represented by the same type of equation), thus the formulation can be extended to include resources and processes from the water and waste sectors.

Like Keirstead's model, processes are separated into conversion processes (such as a wastewater treatment plant) and transport processes (such as a pipeline). The transport processes will connect the different zones into which an urban area is divided, allowing resources to be transported to and from different parts of the city. The main equation is a resource balance,

\begin{align}
I_{rzt} + \sum_p^P G^{(qty)}_{przt} + \sum_{\tau} V^{(qty)}_{rzt\tau} &= D^{(qty)}_{rzt} + E_{rzt},
\label{eq:bal_qty}
\end{align}

which specifies the amount of a particular resource $r$ at any given time $t$ in zone $z$. The demand $D^{(qty)}$ parameter is specified by the user, and the model will choose the resource quantity imported into the city $I$, exported from the city $E$, generated by conversion processes $G$, and net inflow from other zones $V$ (referred to as 'variables'). Like Keirstead's model, the resources are expressed in terms of quantities (such as MW of electricity or kg/s of solid waste), which in our equations is denoted by the $^{(qty)}$ superscript. However, here we evolve Keirstead's formulation, by defining resource flows in terms of their *quality*, such that a resource can be attributed with both an energy and a mass. This is useful as we consider interaction between different sectors. Consider a body of water: this can supply (for example) both cooling for industrial processes, and hydroelectric electricity -- in our model we would need to know both its mass, and its energy head due to elevation. Thus the formulation specifies an equation analogous to \eqref{eq:bal_qty} which defines flows in terms of their quality (using the $^{(qual)}$ superscript notation):

\begin{align}
X_{rq} I_{rzt} + \sum_p^P G^{(qual)}_{prqzt} + \sum_{\tau}^T V^{(qual)}_{\tau rqzt} &= D^{(qual)}_{rqzt} + X_{rq} E_{rzt} \qquad \forall q,
\label{eq:bal_qual}
\end{align}

This introduces the quality index $q$, and the parameter $X$ which defines a resource's quality[^qual-param] which is a multiplier of any resource quantity value, such that it separates a quantity into its qualities.

[^qual-param]: For example, 1 kg of water elevated by 10 m would have an energy head of 98.1 J. Thus $X_{rq}$ would be defined as $X_{\mbox{water, mass}} = 1$, $X_{\mbox{water, energy}} = 98.1$.

The variable $G$ denotes the net quality of resource produced by a conversion process in a zone at a particular time. Conversion processes are modelled as black boxes with resource inputs and outputs, defined by the coefficients $k^{proc}_{prq}$:

\begin{align}
G^{(qual)}_{prqzt} &= k_{prq} F_p,
\label{eq:conv_qual}
\end{align}

The variable $F_p$ defines the operation rate of a process $p$ which can run between a range of values (e.g. a power plant's maximum operating capacity). Using the $X_{rq}$ parameter, we can formulate the quantity version of \eqref{eq:conv_qual}:

\begin{align}
X_{rq}G^{(qty)}_{przt} &= k_{prq} F_{pzt},
\label{eq:conv_qty}
\end{align}

<!--
This equation only needs to be applied in the case where a process $p$ produces or consumes resource $r$ with qualities $q$, hence the condition based on the $\delta_{prq}$.
-->
Transport processes are defined similarly to conversion processes, using coefficients to represent the relative quantities of resources involved in the transfer from one zone to another, to calculate the variable $V$ for each zone, as the net inflow of a resource ($\mbox{summed inflow from all other zones} - \mbox{summed outflow to all other zones}$):

\begin{align}
V^{(qual)}_{\tau rqzt} = &\sum_{z'} (k^{\alpha}_{\tau rq} + k^{\beta}_{\tau rq} l_{zz'}) F^{transp}_{\tau zz't} + \\
+ &\sum_{z'} (k^{\alpha'}_{\tau rq} + k^{\beta'}_{\tau rq} l_{z'z}) F^{transp}_{\tau z'zt}
\label{eq:transp_qual}
\end{align}

Coefficients and process rates are defined for transport technology $\tau$, both for the zone of origin $z$, and the zone of destination $z'$ (where the $'$ notation indicates the destination zone). Furthermore, the quantity of input resources can be defined by the linear sum of two coefficients, denoted by $\alpha$ and $\beta$. For example to transport 1 kg of coal from $z$ to $z'$ (defined by $k_{\tau rq}^{\alpha}=-1$, $k_{\tau rq}^{\alpha'}=1$) will require a quantity of petrol dependent on the distance between the zones $l_{zz'}$, thus defined by $k_{\tau rq}^{\beta}$ and $k_{\tau rq}^{\beta'}$. In the case where transport losses occur (such as electricity transported via a cable), $k^{\alpha}_{\tau rq} > k^{\alpha'}_{\tau rq}$. To calculate the quantity flows, we once again use the $X_{rq}$ parameter:

\begin{align}
X_{rq}V^{(qty)}_{\tau rzt} = &\sum_{z'} (k^{\alpha}_{\tau rq} + k^{\beta}_{\tau rq} l_{zz'}) F^{transp}_{\tau zz't} + \\
+ &\sum_{z'} (k^{\alpha'}_{\tau rq} + k^{\beta'}_{\tau rq} l_{z'z}) F^{transp}_{\tau z'zt}
\label{eq:transp_qty}
\end{align}

Finally, the model will minimise some objective, for example, the cost of resource imports:

\begin{align}
\min\left\{\sum_{rzt} \mbox{cost}_r I_{rzt}\right\}
\label{eq:ob}
\end{align}

Equations \eqref{eq:bal_qty}--\eqref{eq:ob} form the programme's main constraints. For a full description, see Appendix [TODO: cross-ref to appropriate appendix] which lists other constraints (such as upper limits imposed on resource imports). The formulation includes continuous variables (such as resource quantities and process rates), integer variables (the number of conversion processes in a zone), and binary variables (for the existence of a transport process between two zones). All equations are linear, resulting in a mixed-integer linear programme (MILP).

# Case study (results and discussion, although discussion might be separate)

To demonstrate the model we have formulated above, we will use a new Chinese urban development as a case study. The development is led by the Shann GU company[^confidential], and concerns a 13 km$^2$ site accommodating 133,000 people, with residential, commercial, industrial and recreational functions. For the case study take the predicted resource demands for the site, and run the model for several scenarios (outlined below) to optimise the development's metabolism. Note that a strict definition of 'optimise' is not considered here (though this question has been explored elsewhere, e.g. @Ravalde2015a); our primary purpose is to introduce our new model. As such we will apply various environmental and economic objectives which may interest stakeholders.

[^confidential]:More detailed information regarding its location is confidential.]

[TODO: idealised representation figure]


## Input data
<!--
- Data
  	- resources
  		- generic
  		- specific, due to the site, e.g. exergy of heat
  	- processes
  		- generic, from the database
	  	- specfic, due to the site, e.g. rain, leachate = f(rain, evaporation, landfill area)
		- real processes, heat exchangers (and associated water flows)
		- dummy processes (e.g. MSW splitting, waste generalising)
-->

This section introduces the data used as parameters in the model. Further details regarding sources and assumptions are given in the Appendix. The actual data is available from the supplementary information at [TODO-link-to-supplementary-information](../shann-gu-documentation/data.html).


[^process-data]: \\url{https://github.com/tomravalde/urban-metabolism-process-database}

### Site layout

This data defines the set of zones $Z$, and the distances between any pair of zones ($l_{zz'}$), and whether any pair of zones are neighbouring (and hence if they can be connected by transport processes from set $T$). We have estimated this information from the Shann Gu documentation, with 13 zones defined within the 13 km^2^ construction region.

### Site layout -- Appendix

According to the Shann Gu documentation, the site's construction region is 13 km^2^, with industry in the north, residential and commercial use in the centre, and recreational functions in the south.

Neighbouring zones belong to set $nb(z,z')$.
[Complete]

### Times

The times set $T$ defines the times considered, with their lengths given by $span(T)$ [TODO: re-notate]. In our case we've defined seasons for `winter`, `summer` and `shoulder`, with spans of 90 days, 90 days, and 180 days, respectively. 

### Resource demands

The Shann Gu documentation specifies demands ($D^{(qty)}_{rzt}$) for electricity, heating, water consumption. We also derive quantities for wastewater and waste generation, which can be defined using negative values. Demand is defined on a per-second basis (MW for energy demands, kg/s for the others).


### Resource demands -- Appendix

- The code is set up, such that only $D^{(qty)}_{rzt}$ need be defined, with $D^{(qual)}_{rqzt}$ defined automatically.
- Summary table?

### Resource options

As well as the resource demands, our case studies consider another [TODO: number] resources in set $R$ which can be used as part of the conversion chain to meet demand. These include [TODO: list examples]. For each resource why can apply a conta

Each resource has at least one associated quality $q$, which are defined in the $Q$ set. For our purposes we use `mass` and `energy` qualities, which are attributed to each resource with the $X_{rq}$ parameter.

For each resource, we need to define the minimum and maximum allowable imports and exports (again, on a per-second basis), and the number of zones allowed to import or export any particular resource. We also define a cost to import each resource [TODO: source information].

### Process options

Our modelling considers up to [TODO: number] processes $p$ which convert resources (depending on the scenario). [TODO: add details on scenarios here, or elsewhere?] These processes are taken from the open-source database of urban metabolism processes outlined in @Ravalde2015b[^process-data], or the Shann Gu documentation. Each process definition also includes its capacity (i.e. the maximum MJ/s or kg/s which can be converted).

For each process, we also provide an estimated cost (in USD). Apart from the shear number of processes in our database (over 300), several factors make this tricky: first and foremost, our process database considers future processes which have not yet penetrated into the market. In addition, exchange rates and purchasing power parities around the world make it difficult to cost a process with any degree of certainty. For this reason, our costing is approximate. Nevertheless, this is important to get plausible results. (See the supplementary information for references, assumptions, calculations, and other details.)
). 

Similarly, up to [TODO: number] transport processes are also defined (using the $k$ coefficients), and maximum transport rates (MW or kg/s).

- pipes (costed)
- roads (free)

## Model scenarios

We study [TODO: number] scenarios using different subsets of the processes, to suggest how different networks of processes can satisfy demand under varying circumstances (following the methodology of @Keirstead2012). For some scenarios, we model sub-scenarios, where we use different objective functions, or introduce an additional constraint to illustrate Pareto optimality. The scenarios are:

1. *Base case.* This assumes that electricity, fuels and water are imported to the site as needed (with wastewater treated on site), thus there is no attempt to take advantage of synergies. As such, this scenario provides baseline results.
2. *Design case.* The Shann Gu site developers intend to take advantage of intersectoral synergies to minimise resource consumption. This scenario considers the processes suggested in the Shann Gu documentation, including combined heat and power (CHP), a wastewater source heatpump combined with a district heating network. We consider how the process choice changes, with different objecitves:
	a. Minimise cost
	b. Minimise emissions
	c. Minimise waste
	d. Minimise freshwater consumption
3. *Wildcard case.* This scenario allows any process from the database compiled by @Ravalde2016 to be incorporated into the site's resource management network. This database includes both existing and still-to-be-implemented management processes, so we consider the following sub-scenarios, at minimum cost:
   	a. Currently available processes
   	b. Medium-term available technologies
   	c. Long-term available technologies

Scenario 3a [TODO: update if necessary] is the largest, and thus indicates the computational effort required to solve the problems, having [TODO: number] single variables, [TODO: number] discrete variables, [TODO: number] binary variables, [TODO: number] equations [TODO: etc.].

These scenarios are fairly simple, and illustrate the sensitivity of a network to fairly broad considerations (technology availability, and simple objective functions). Detailed design problems should be more narrowly focussed, by applying sensitivity analysis to understand how a system design responds to changes in efficiency (reducing demand), market value of imported and exported goods, and other factors. [TODO: reproduce Saltelli et al. citation from @Keirstead2012??].
<!--
OTHER SCENARIO VARIATIONS
- DSM
- min-cost
- min emissions
- cost/emissions pareto
- export revenue (e.g. hydrogen economy)
- Exergy verses other objectives (cost, carbon footprint, water footprint, waste output)
- min cost -- DSM
- min cost -- phased planning
- min water
- min landfill
- min cost/targets of individual sectors (energy, water, waste), or differently weight them?
-->

## Results (and discussion)

We present the results of each scenario in a number of ways (summarised in Table [TODO: cross-ref]. First, the annual costs (including conversion and transport capital costs, as well as resource import costs), are calculated (Figure [TODO: cross-ref]). Second, we consider each system's emissions from the processes (though it is beyond the scope of this study to trace emissions up the supply chain) (Figure [TODO: cross-ref]). Third, we consider the metabolic inputs and outputs to each system (Figure [TODO: cross-ref]). Fourth, we consider the network of conversion processes which makeup each system (Figure [TODO: cross-ref]).

[TODO: SNA (or triangular grid) figures for each scenario]


```{r network-plot}

## Inter-sectoral plot for whole network stored separately, so it's easy to suppress from paper compilation (to save time)
#base::source("resource-network.R")
#
#resource_sectors <- read.csv("resources-sector.csv")
#sectors_lookup <- rbind(c("energy", "blue"),
#			c("water", "red"),
#			c("waste", "black"),
#			c("other", "green"))
#sectors_lookup <- data.frame(sectors_lookup)
#colnames(sectors_lookup) <- c("sector", "node_vector")
#resources_sectors_node <- inner_join(resource_sectors, sectors_lookup)
#node_vector <- c(resources_sectors_node$node_vector)
#
### Network plot (using SNA package)
#layout <-  c("fruchtermanreingold", "kamadakawai", "spring", "circle", "eigen", "hall", "mds", "princoord", "target")
#
##library(sna) # Code to plot figure for saving (and subsequent manual editing)
##gplot(link_matrix,
##      mode=layout[1],
##      gmode="graph",
##      label = resources,
##      label.pos = 1,
##      jitter=FALSE,
###      arrowhead = FALSE,
##      thresh=0,
###      vertex.sides = 0,
##      vertex.col = node_vector,
##      edge.col = rgb(220, 217, 217, maxColorValue=255),
##      displaylabels = TRUE)
```

\begin{figure}
	\centering
	\begin{spacing}{1.0}
%	\includegraphics[width=\columnwidth]{final-network.pdf}
	\end{spacing}
	\caption{The process network used in the design case. Processes are colourd according to the main resource they process. Graph is plotted using the R package from \citet{SNA2005}. A colour version of this plot is available in the electronic version of this paper.}
	\label{fig:sna_interactions}
\end{figure}


[TODO: Dot plot of scenario costs (import, transport, conversion, etc.)].

[TODO: Dot plot of imports and exports. All scenarios on same figure, faceted by resource and scenario].

With some systems so large (over [TODO: number]) process types, space limitations prevent us from display all information of interest (e.g. the quantity of any particular technology). However however, the Supplementary Information includes all results in CSV format.

The number of technologies used by a scenario increases as more are available, showing that systems take advantage of the full range of available conversion processes, with more being used to minimise the objective as much as possible. When different objectives are applied to the same technology choice (e.g. 2a and 2b [TODO: update if necessary]), we observe the sensitivity of the technology mix in the network [TODO: can this be quantified by some metric?].

[TODO: comment on the mix of technology sizes in various scenarios.]
[TODO: comment on which technogies are most relied upon in each system.]
[TODO: comment on transportation reliance (e.g. central import + distribution, or central import and conversion, etc.?]
[TODO: comment on coversion/transportation mix effect on (capital) costs?]

There are limitations to what the results show. We have already noted the approximate nature of process costs. Furthermore [TODO: comment on part-load operation], for the sake of simplicity, our model has aggregated yearly demand to a single per-second value (rather than considering peak and average demand). Thus, we are unable to quantify the degree to which conversion processes within our systems are oversized, without running models with a finer temporal resolution which accounts for variations within a single day.

### Costs

Comment on (percentage) differences between scenarios, and suggest reasons for differences (e.g. capital costs and imports).

### Emissions

Comment on (percentage) differences between scenarios, and suggest reasons for differences (e.g. synergies).

### Metabolic inputs and outputs

Comment on (percentage) differences between scenarios, and suggest reasons for differences (e.g. synergies).

# (Discussion and) Conclusions

There is no doubt that modelling has helped planners and policy makers design systems to manage resources to optimal performance in cities. However, to date, energy, water and waste resources have been managed with their own separate modelling tools. But by neglecting the synergies between different resource types, these approaches limit the resource savings a city can make. Thus we have adapted @Keirstead2013a's urban energy systems model to introduce a new model which optimises an urban area's resource-technology management, by choosing an appropriate technology mix and a corresponding schedule of resource imports and exports. Using the database of @Ravalde2016, we have applied the model to a Chinese urban development case study, for [TODO: number] scenarios.

[TODO: discuss the middle of the system]
<!--
Despite a gallimaufry of urban metabolism models and resource optimisation models, there is still need for an integrated model, to meet ambitions for intersectoral urban synergies. We have begun this processes, developing @Keirstead2013a's model to create a generically defined [TODO: complete...]

In this paper, we have adapted the urban energy systems model of [TODO: cite Keirstead et al.] to formulate a new model which simultaneously optimises the management of energy, water and waste, to improve the metabolism of an area, and applied it to a new urban development in China, using data collected for @Ravalde2015b.
-->

In addition to contributing a model for use in research, planning and policy, our results have showed that for the Shann Gu site, an objective (e.g. minimising cost, emissions, or some other quantity) is more readily met by taking advantage of more process types (particularly of a smaller capacity), in a decentralised network, rather than the more traditional centralised systems. This fits with findings from individual sectors (e.g. energy supply and water supply) where decentralised are increasingly encourages, with waste- and by-products cascading down through a system [TODO: provide reference].

[TODO: summarise and explain other key findings]

Having contributed this new tool, we recognise that given the early nature of this work, there is further work which can help make this tool more usable in the real world. Firstly, more data can be contributed to the @Ravalde2016 database (e.g. process costs, appropriate to specific locations and currencies). Secondly, the model formulation can be made more sophisticated, perhaps introducing separate categories of technologies which distinguish between domestic and non-domestic technologies, and introducing storage technologies [@Keirstead2013, equations 9.3--9.10, pp166--170]. It could also incorporate 'hierarchical non-uniform time discretization' which is a sophisticated way to consider the variation in resource demand over hourly, daily weekly, and seasonal periods, at lower computational cost than considering continuous profile over a long period [@Keirstead2013, p161]. Another addition to the formulation could be a device's spatial footprint. [TODO -- Note to James: domestic techs, and spatial footprint are considered in the unpublished paper, but not the book chapter.]

Moving up to a more conceptual level, work should consider how our model can be applied within the broader socioeconomic systems. In our case study, the modeller has complete control over energy, water, and waste management sectors. While the operator of a single system (such as an energy supplier) might have such control, different resources are often managed by different actors, each seeking to maximise their own profits and incentives [TODO: reference]. Plausibly therefore, this modelling work could contribute to arguments which favour planned utilities management over free-market management, a debate ongoing anyway with the increasing interest in Smart cities [TODO: reference].

In conclusion, in an increasingly resource-constrained world which faces the combined challenges of population growth, global warming,water scarcity, and shrinking landfill capacity, cities are being hailed as the most efficient means to provide goods and services. However, to take full advantage of this, cities should exploit their co-location of processes to benefit from synergies between energy, water and waste management systems. Our model is one step further along the journey to that end.

# Acknowledgements {.unnumbered}

Tom Ravalde is supported by the EPSRC Doctoral Training Partnership at Imperial College London. The [TODO: details] data was provided by [TODO: Yingru/Xiamen/Shann Gu].

# Appendix {.unnumbered}

- Full mathematical formulation. I.e., in the main body, we only need to include the essential balance and process equations. Other constraints (e.g. limits on imports/exports can go in the Appendix).
- Demands
- Tabulate resource data (exergy, emissions, CF, WF Cost Revenue)
- Example black box process models
- Identify dummy processes (waste splitter, and waste generaliser, water splitter (recognising that higher quality waters can be used in lower quality applications)
- Example network configuration results
- Links to data, code and results on GitHub
- Summarised version of the demand data
- Link to GitHub/website of supplementary information
  	- CSV master table
	- R-script to produce data summaries, based on the master table's 'tidy' form.
	- Details on model formulation (comparison of performance, etc.)
	- Details on Shann Gu specific parameters (e.g. groundwater pumping, surface water availability, rainfall)

# Appendix -- data [TODO: move to the appendix, and retitle]

- Assume documentation gives peak values
	- Assume peak values at all times?
	- Calculate daily averages based on peaks?
	- Compartmentalise into peaks and averages?

# Appendix -- formulation {.unnumbered}

The maximum rate at which a conversion process can operate is given as:

\begin{align}
F_{pz} \le N_{pz} F^{max}_p,
\end{align}

where the variable $N_{pz}$ is the number of process type $p$ in zone $z$, and the parameter $F^{max}_p$ is process $p$'s maximum operating rate.

The maximum rate between zones $z$ and $z'$ at which a transport process can operate is given as:

\begin{align}
F^{transp}_{\tau zz'} \le \delta^{transp}_{\tau zz'} F^{transp, max}_\tau,
\end{align}

where the integer variable $\delta_{\tau zz'}=1$ when transport process $\tau$ exists between zones $z$ and $z'$, and the parameter $F^{transp,max}_p$ is process $\tau$'s maximum operating rate (e.g. the maximum water flow rate of a pipe). Having defined the existence of a transport link between two zones, we assume that a link in one direction ($z \rightarrow z'$) necessarily defines a link in the opposite direction, thus:

\begin{align}
\delta^{transp}_{\tau zz'} = \delta^{transp}_{\tau z'z}
\end{align}

Further, we define a set $nb$ which specifies whether any two zones are neighbours. Only connections within this set can be linked by transport infrastructure. This not only models reality, but also reduces the model size:

\begin{align}
\delta^{transp}_{\tau zz'} = 0 \qquad \forall (z,z') \notin nb
\end{align}

The imports and export quantities must lie between $I^{min}$ and $I^{max}$ parameters, and thus can be expressed with the following constraint:

\begin{align}
\delta^{I}_{rz'} I^{min}_{rt} \leq I_{rzt} \leq \delta^{I}_{rz'} I^{max}_{rt}
\end{align}

where $\delta^I_{rz}$ is a binary variable which equals 1 if conversion process $r$ exists in zone $z$. This variable is itself subject to the constraint that only a $N^I_r$ zones can be used to import any given resource $r$:

\begin{align}
\sum_z \delta^{I}_{rz'} \leq N^I_r
\end{align}

Analogous constrains apply to exports:

\begin{align}
\delta^{E}_{rz'} E^{min}_{rt} &\leq E_{rzt} \leq \delta^{E}_{rz'} E^{max}_{rt} \\
\sum_z \delta^{E}_{rz'} &\leq N^E_r
\end{align}

Finally we consider possible objective functions, which could be a combination of costs ($C^*$) and environmental impacts. Resource costs could be defined, thus:

\begin{align}
C^R &= \sum_{rzt} c_r I_{rzt} \\
C^P &= \sum_{pz} c_p N_{pz} \\
C^{\tau} &= \sum_{\tau zz'} c_\tau \delta^{transp}_{\tau zz'} l_{zz'}
\end{align}

where the parameter $l_{zz'}$ defines the distance (length) between two zones. The costs above can be combined into a single objective function.

\begin{align}
C = \gamma^R C^R + \gamma^P C^P + \gamma^{\tau} C^{\tau}
\end{align}

where coefficients $\gamma^*$ could weight the component costs according to time span (e.g. a 20 year investment period), or their relative importance to a particular stakeholder.

Other types of objective function could include the carbon footprint $(CF)$ of an area, using the emissions factor of a resource $(ef)_r$:

\begin{align}
CF &= \sum_{rzt} (ef)_r I_{rzt}
\end{align}

More simple objective function might simply be to minimise the imports of a particular resource (e.g. water imports).

Objectives can be traded-off against each other, using so-called 'Pareto optimisation'. One equation is used as the objective function (for example cost), while another is defined as an inequality constraint (for example emissons):

\begin{align}
\sum_{rzt} (ef)_r I_{rzt} \leq lim
\end{align}

The user runs the model multiple times, changing the value of $lim$, such that one can plot a curve of emissions against cost.

# Useful files and folders {.unnumbered}

- Daiwang-case-study/data-notes.md
- code (copy) << (GMS files only)
- workshop-june-2014-shann-gu/shann-gu-parameters.gnumeric << assumptions for the pre-China trip version of the Shann Gu model
- workshop-june-2014-shann-gu/table-resource.csv << references for resource costs and emissions factors (for the pre-China trip version of the Shann Gu model)
- workshop-june-2014-shann-gu/table-process.csv << references for the process size and costs (for the pre-China trip version of the Shann Gu model)
- workshop-june-2014-shann-gu/paper/Shann-gu-paper_T-Ravalde.pdf << Appendix contains calculations, assumptions, and links for process and resource parameter values (for the pre-China trip version of the Shann Gu model)
- conf-paper << contains paper and presentation, giving zones etc. (for the post-China trip version of the model, i.e. more zones)
- shann-gu-documentation << various presentations and papers, and shann-gu_lingtong.gnumeric spreadsheet of data and assumptions

# References {.unnumbered}

<!--
```{r PowerPoint-figure-conversions}
#library('ReporteRs')
#
### Open data research
#doc <- pptx()
#doc <- addSlide(doc, "Two Content")
#doc <- addPlot(doc, function() print(plot_open_data), vector.graphic = TRUE)
#doc <- addPlot(doc, function() print(plot_open_data), vector.graphic = FALSE)
#writeDoc(doc, file = "word-figures/open-data.pptx")
#
```
-->

# Case study: a Chinese urban development

[TODO: Add epigraph]

\begin{tcolorbox}

An early version of the work in this chapter was published as: 
Tom Ravalde, James Keirstead, Integrated Resource Planning for a Chinese Urban Development, \emph{International Symposium for Next Generation Infrastructure Conference Proceedings}, doi: \url{http://discovery.ucl.ac.uk/1469209/}.

\end{tcolorbox}

```{r Setup, include=FALSE, results="hide", warning=FALSE}
library(knitr)
opts_chunk$set(fig.path = "figures/", dev=c("cairo_pdf"), fig.pos='htbp', fig.width=5, fig.height=3.5, dpi=700, fig.show='hold', fig.lp="fig:", cache=FALSE, par=TRUE, echo=FALSE, results="hide", message=FALSE, warning=FALSE)

library(extrafont)
font_import(pattern="LinBiolinum")

library(ggplot2)
```
<!--
Sections in JK's MILP paper

# Case study

- proposed eco-town development (ambitions)
- site characteristics
- zonal demands
- timings
- figrues with data

## Resources and technologies
## Objective function
## Results
-->


This thesis has argued for the need for an optimisation model which can help plan urban energy, water and waste infrastructure, with a view to improving the urban metabolism of an area. To that end, the previous chapter introduced the PRaQ model -- a MILP formulation that is generic enough to incorporate multiple resource types, user-friendly to construct, and can be solved without excessive computational effort. The architecture of the model is structured to separate code and data, for further ease of use. This chapter now applies this model to a case study, using the library of resource management processes assembled in Chapter 4, and using some of the metrics of Chapter 3 to assess the systems designed by the model.

This chapter first introduces the case study (Section \ref{sec:case-study-intro}), before outlining the data (for example defining zones, interzonal links, and resource demands) (Section \ref{sec:SPC-data}). Following this, Section \ref{sec:SPC-scenarios} introduces several scenarios for the case study to which PRaQ is applied. These scenarios will all use the same demand patterns, but vary in their objectives, and the set of processes available to manage resources. This will allow investigation of both currently proposed system designs, as well as other more speculative ideas. This section will present and discuss the results of modelling each scenario, in view of the UM-related concepts introduced in Chapters 1-3 of this thesis. In summary, this chapter's aim is to use a case study to provide insight to planners and decision makers developing SPC site plans further.

## The case study {#sec:case-study-intro}

The case study is an ongoing Chinese urban development led by the Xi'an Shann Gu Power Company (hereafter, SPC), who historically have provided turbo-machinary services (such as steam turbines, fans and energy recovery units) for the chemical industry, power generation, construction, and other sectors requiring heavy machinery [@SPC2014]. The SPC are implementing plans to redevelop one of their industrial sites and the surrounding region. The wider site is in the Xi'an province of China with an area of 51.03 km$^2$, which includes a short-term construction region of 13 km$^2$ which can accommodate 133,000 people. This short-term construction area has residential, commercial, industrial and recreational functions, roughly represented by Figure \ref{fig:site} [^confidential]. The homes, businesses and industrial functions will all have energy, water and waste management needs.

[^confidential]:The documentation regarding the SPC redevelopment plans is confidential and thus certain information (such as the precise site location) cannot be given here. There are six SPC documents (reports and PowerPoint presentations) from which this chapter draws information. In this thesis, these will be cited as 'SPC [X]', where X refers to one of the six papers, namely: 'energy' (details on energy needs and provision), 'water' (details on water needs and provision), 'wastewater' (details on wastewater management needs and provision), 'intro' (general details about the SPC site redevelopment), 'site' (specific details about the site), 'demand' (demand data).

\begin{figure}
	\centering
	\begin{spacing}{1.0}
	\sffamily
	\resizebox{0.5\columnwidth}{!}{\input{06_case-study/site.pdf_tex}}
	\end{spacing}
	\caption{A schematic of the SPC redevelopment site, adapted from figures in the SPC documentation. The outer dashed rectangle encloses the full 13 km$^2$ site; the solid rectangles and their bold text labels represent broad regions within the site (e.g. the \textbf{residential} region; the unbolded text labels denote zones more specifically (e.g. a hospital within the residential region).}
	\label{fig:site}
\end{figure}

A stated ambition of the SPC site redevelopment is to integrate the energy, water and waste management services in order to maximise energy efficiency, minimise the discharge of waste, and minimise economic costs. Proposals to that end include using heat stored within wastewater within a water source heat pump, and generating biogas from wastewater fermentation. Another specific need of interest is in the recreational area, which includes an artificial lake, which the planners hope to source via a water reuse project [@SPC_water]. These, and other intersectoral possible intersectoral synergies are summarised in Figure \ref{fig:shanngu-network}, which shows part of the resource management infrastructure proposed by the SPC for the site's redevelopment.

\begin{figure}
	\centering
%	\begin{spacing}{1.0}
%	\sffamily
	\includegraphics[width=\textwidth]{06_case-study/shanngu-network.pdf}
%	\end{spacing}
	\caption{SPC's proposed interactions between energy, water and waste management. Resources in \textbf{bold} represent resources either demanded or produced by the end-users in the regions of Figure \ref{fig:site-connections}; and * indicates a resource can be imported from outside the system boundary (indicated by the dashed line). These processes will be split between the zones of the site and be connected by transport infrastructure.}
	\label{fig:shanngu-network}
\end{figure}

\begin{figure}
	\centering
	\begin{spacing}{1.0}
	\sffamily
	\resizebox{0.5\columnwidth}{!}{\input{06_case-study/site-dimensions.pdf_tex}}
	\end{spacing}
	\caption{A re-representation of the SPC redevelopment site, indicating connections defined for set $nb(z,z')$. All distances are in kilometers. Each region centre connects to the other zones in the region (e.g. \textbf{Factory (south)} $\leftrightarrow$ Assembly) with a connection assumed to be 0.5 km in length.}
	\label{fig:site-connections}
\end{figure}

The proposed energy system has been simulated [@SPC_intro] using the TRNSYS[^trnsys] to simulate the energy, system, however this does not include detailed consideration of the water and waste systems. Furthermore, the system design has not been subjected to optimisation modelling. Thus, this case study presents an opportunity to (i) model water and waste systems, alongside the energy system; (ii) to go beyond simulations by applying optimisation modelling; and (iii) to consider not just the current proposed system designs, but also those made possible when the database of Chapter 4 is considered.

[^trnsys]: \url{http://sel.me.wisc.edu/trnsys/index.html}. TRNSYS allows users to lay out the components of an energy system (drawn from a library of thermal and electrical energy components), linking them together in a modular fashion, in order to simulate the behaviour of an overall energy system.


<!--
- [SPC-4, slide 17: water, waste and energy jigsawed together]
- [SPC-4, slide 19: Energy island with CHP, CCHP and sewage source heatpump 
- [SPC-4, slide 21: Energy island]
- [SPC-4, slide 22: Energy provision via CHP, CCHP and sewage source heatpump, (as well as traditional and renewable approaches)]
- [SPC-4, slide 25: "Increase energy supply efficiency", "decrease discharge cost" and influence "by cycle reuse", in order to save energy, give social benefits, and economic efficiency]
- [SPC-4, slide 26: Energy island logic diagram, incorporating sewage treatment, water reuse, solid waste treatment, cooling/heating, and solar-PV power]
- [SPC-4, slide 27: Within that, the "Combined water supply and treatment system" has WSHP, rainwater collection, fermentation to produce biogas, sewage plant, water treatment, and water reclamation]
-->

## Model data {#sec:SPC-data}
<!--
- Data
  	- resources
  		- generic
  		- specific, due to the site, e.g. exergy of heat
  	- processes
  		- generic, from the database
	  	- specfic, due to the site, e.g. rain, leachate = f(rain, evaporation, landfill area)
		- real processes, heat exchangers (and associated water flows)
		- dummy processes (e.g. MSW splitting, waste generalising)
-->

When applying the model to a case study, the first step is to specify the zones and time periods used in the model, defined by sets $z \in Z$ and $t \in T$, respectively. With the zones determined, another a set specifies whether any pair of zones $(z,z')$ are neighbours, by defining them as part of the set, $nb(z,z')$. Following this, the sets of processes and resources available to the model can be listed ($p \in P$ and $r \in R$, respectively). At this point, there is enough information to define the two final sets: first, the qualities to be attributed to resources ($q \in Q$); and second, the transport technologies, $\tau \in \Tau$ which transfer the resources between zones.

With the sets in place, the parameters can be defined. First the distance between between two any two neighbouring zones defines the interzonal distances $l_{zz'}$ (kilometers), while $\mathbb{S}_t$ defines the length of time of each time period, $t$ (days). Resource management needs can then be assigned to each time and location with $D^{(qty}_{rzt})$. ($D^{(qual)}_{qzt}$ can then be automatically defined by running the R script which builds the model from the formulation and the data (Section \ref{sec:implementation})). Other parameters to define include the limits on imports and exporting resources to particular zones, and the costs of resources and processes.

The following subsections outline how the sets and parameters are defined from the SPC documentation (with further details provided in Appendix \ref{sec:app-case-study}). The explanations are deliberately comprehensive, reflecting on why certain choices and assumptions regarding data are made, to justify the modelling decisions taken here -- recall that Section \ref{sec:modelling-intro} noted that the value of modelling found not only in the results, but in making *explicit* assumptions and methods which would have otherwise been unstated in the decision-making processes. This walks the reader through how one might design a model for a particular case study, and when it would be appropriate to take different decisions. The details are given in the recommended order of how a user might construct a particular case study model.

```{r resource-demands, fig.height=5, fig.width = 7, fig.cap="Resource management demands for the SPC site's regions (indicated by \\textbf{bold} axis labels) and functions (indicated by plain axis labels), according to zone and season. Positive values indicate the resource is consumed by the end-users; negative values (i.e., for wastes and wastewater) indicate the resource is produced by the end-users.\\label{fig:site-demands}"}
demands <- read.csv("06_case-study/resource-demands.csv")
demands <- demands[complete.cases(demands$value.conv), ]

demands$headings <- "placeholder"

demands[demands$resource=="heat", "headings"] <- "Heating [MW]"
demands[demands$resource=="cool", "headings"] <- "Cooling [MW]"
demands[demands$resource=="elec", "headings"] <- "Electricity [MW]"
demands[demands$resource=="waterPotable", "headings"] <- "Potable water [kg/s]"
demands[demands$resource=="wastewater", "headings"] <- "Wastewater [kg/s]"
demands[demands$resource=="waste", "headings"] <- "Waste [kg/s]"
demands[demands$resource=="waste_organic", "headings"] <- "Organic waste [kg/s]"
demands[demands$resource=="water_reclaimed", "headings"] <- "Reclaimed water [kg/s]"

demands$zoneLabels <- "placeholder"
demands[demands$zone=="general", "zoneLabels"] <- "General"
demands[demands$zone=="factory", "zoneLabels"] <- "Factory (south)"
demands[demands$zone=="factory_assembly", "zoneLabels"] <- "Factory (assembly)"
demands[demands$zone=="northDistrict", "zoneLabels"] <- "Factory (north)"
demands[demands$zone=="multifunction", "zoneLabels"] <- "Factory (multi-function facility)"
demands[demands$zone=="factory_blades", "zoneLabels"] <- "Factory (blade production)"
demands[demands$zone=="tech", "zoneLabels"] <- "Factory (technology building)"
demands[demands$zone=="quality", "zoneLabels"] <- "Factory (quality control)"
demands[demands$zone=="dormitories", "zoneLabels"] <- "Factory (dormitories)"
demands[demands$zone=="residential", "zoneLabels"] <- "Residential"
demands[demands$zone=="hospital", "zoneLabels"] <- "Hospital"
demands[demands$zone=="school", "zoneLabels"] <- "School"
demands[demands$zone=="energyIsland", "zoneLabels"] <- "Energy Island"
demands[demands$zone=="reserved", "zoneLabels"] <- "Reserved"

demands$seasonLabels <- "placeholder"
demands[demands$season=="sum", "seasonLabels"] <- "Summer"
demands[demands$season=="wint", "seasonLabels"] <- "Winter"
demands[demands$season=="shoulder", "seasonLabels"] <- "Shoulder"

demands_alt <- filter(demands, season=="sum")

demands$zoneLabels <- factor(demands$zoneLabels, levels=c("General",
							  "Factory (south)",
							  "Factory (assembly)",
							  "Factory (north)",
							  "Factory (multi-function facility)",
							  "Factory (blade production)",
							  "Factory (technology building)",
							  "Factory (quality control)",
							  "Factory (dormitories)",
							  "Residential",
							  "Hospital",
							  "School",
							  "Energy Island",
							  "Reserved"))

demands$zone<- factor(demands$zone, levels=c("general",
							  "factory",
							  "factory_assembly",
							  "northDistrict",
							  "multifunction",
							  "factory_blades",
							  "tech",
							  "quality",
							  "dormitories",
							  "residential",
							  "hospital",
							  "school",
							  "energyIsland",
							  "reserved"))


plot_demand <- ggplot(demands, aes(zoneLabels, value.conv)) +
  geom_point(aes(colour=seasonLabels), binaxis="y", position=position_dodge(width=0.6)) +
  facet_wrap(~headings, scales="free_y", ncol=2) +
  labs(colour="Season") +
  theme_bw() +
  theme(axis.text.x = element_text(hjust=1,
				   angle=30,
				   size=6.5,
				   face=ifelse(levels(demands$zone) %in% c("factory", "northDistrict", "residential"),"bold", "plain")
				   ),
	axis.title.x = element_blank(),
	axis.title.y = element_blank())
plot_demand

```

### Site layout {#sec:case-study-site}

Each of the twelve zones shown in Figure \ref{fig:site} (both the three regions and the nine functions) will be represented in the model, and thus each belong to the set of zones $z \in Z$, where $|Z|=12$. It is assumed that the three regions will be linked via a connection running north-south through the site, and also that the functions within a region are equidistant from the region's centre (with the exception of the energy island which does not belong to a region). This makes the size of set $nb(z,z')$ as $|nb|=12$. The connection distances have been estimated from the site's dimensions. Assuming that the region-to-region connections join the regional centroids, distances can be estimated by scaling distances from the site plans in the SPC documentation. The region-to-function distances will be assumed as 0.5 km. In total, there are twelve two-way connections defined, which are given in Table \ref{tab:zonal-connections}. The transport processes used for these connections are detailed in Section \ref{sec:case-study-transport-processes}, but briefly, roads are assumed to exist along any connection. Additionally, these roads have the option to run underground pipes and overhead cables along their length[^road-cost]. The GAMS code for site layout data is listed in Appendix \ref{sec:app-case-study-site}.

[^road-cost]: As discussed in Section \ref{sec:case-study-transport-processes}, this means that roads have no financial cost in the model, whereas pipes and cables will.

\begin{table}[]
\centering
\caption{The zonal connections defined for set $nb(z,z')$, and their corresponding lengths $l(z,z')$ used in the SPC case study.}
\label{tab:zonal-connections}

\begin{tabular}{@{}llll@{}}
\toprule
$z$                      & $z'$                     & Dimension on plan {[}cm{]} & Site dimension, $l_{zz'}$ {[}km{]} \\ \midrule
\textbf{Factory (south)} & \textbf{Factory (north)} & 3.4                        & 0.9                     \\
\textbf{Factory (south)} & Assembly                 & NA                         & 0.5                     \\
\textbf{Factory (south)} & Multifunction district   & NA                         & 0.5                     \\
\textbf{Factory (south)} & Dormitories              & NA                         & 0.5                     \\
\textbf{Factory (south)} & Turbines                 & NA                         & 0.5                     \\
\textbf{Factory (north)} & Technology building      & NA                         & 0.5                     \\
\textbf{Factory (north)} & Quality control          & NA                         & 0.5                     \\
\textbf{Factory (north)} & Energy island            & $4.8+1.3=6.1$              & $1.3+0.4=1.7$           \\
\textbf{Factory (north)} & \textbf{Residential}     & $4.8+3.4=8.2$              & 2.2                     \\
\textbf{Residential}     & School                   & NA                         & 0.5                     \\
\textbf{Residential}     & Hospital                 & NA                         & 0.5                     \\
\textbf{Residential}     & Reserved                 & NA                     & Assume to be 1                       \\ \bottomrule
\end{tabular}
\end{table}


<!--
Assembly,Factory (south)
Factory (north),Factory
Multifunction district,Factory (north)
Technology building,Factory (north)
Dormitories,Factory (north)
Energy island,Multifunction district
Technology building,Turbines
Quality,factory_blades
school,Residential
school,hospital
school,energyIsland
school,reserved
-->

### Times

The SPC documentation provides values of energy demands for winter, summer and year round [@SPC_demand]. This model therefore uses three timesteps, specified by $t \in T$, where $|T|=3$, representing the winter, summer, and shoulder seasons, having spans, $span(T)$, of 90 days, 90 days, and 180 days respectively. This means that the infrastructure selected by the model would be in place all year round, but could operate differently in each season. Consider the provision of domestic heating provided by district heating as an example: in the winter, the district heating would be delivering heat to homes, and this would have an impact on the operation of heat-generating processes upstream of the district heating network. However, these upstream impacts would not occur in the summer, when district heating does not run. As this phenomenon is applied in relation to other resource demands, the network of processes emerging from the system interactions could operate differently according to season, in order to optimise the site's metabolism.

Of course, operation might not just vary by season, but could vary for smaller time slices. For example each season could have alternative weekday and weekend resource demand (thus $|T|=3 \mbox{ seasons} \times 2 \mbox{ day types}= 6$), which could further be divided into hourly demands (thus $T=3 \mbox{ seasons} \times 2 \mbox{ day types} \times 24 \mbox{ hours} = 144$). The temporal resolution could become finer still, using minute-by-minute and second-by-second demand patterns.

Thus the decision here to use seasonal timesteps is not as coarse as it could be (i.e. yearly), but neither is it as granular as it could be. One reason for this is to go into greater resolution would require additional assumptions by downscaling the data from the SPC documentation (which are given at a seasonal level). Another reason to not go into greater temporal resolution is to keep computational expense low through being conservative in the number of variables in the model. (Section \ref{sec:further-work-model} discusses possible approaches to use more time steps without proportionatly increasing the computational costs.)

In summary, seasonal timesteps are appropriate for appropriate to the exploratory early-stage planning purposes of this model. Further along the planning process when detailed designs are being planned, it is justifiable to expend more effort, thus a finer temporal resolution may be warranted. Further more, at the more detailed design stages, some decisions will have been made (for example, the location of a particular conversion process), thus reducing the number of variables in the model, and thereby speeding up computation.

### Resource demands

Having determined the seasons and the time steps in the model, it is now possible to define the resource demand parameter $D^{(qty)}_{rzt}$ for each resource $r$. (As mentioned in Section \ref{sec:implementation}, the code which assembles the model is designed such that $D^{(qual)}_{rqzt}$ can be defined automatically once $D^{(qty)}_{rzt}$ is known.) The SPC documentation provides values which can be used in the modelling. However, these values do not necessarily cover all resources $r$, and may not be disaggregated to each zone $z$ and season $t$. Thus, sometimes, assumptions and calculations need to be applied in order to translate a documented value into a set of values which can be used in the modelling. The details of these adjustments are provided in Appendix \ref{sec:app-case-study-resources}.

The resource demands used here are summarised in Figure \ref{fig:site-demands}, showing the seasonal demand for energy (electricity, heating, and cooling), water (potable, and reclaimed), and waste management (wastewater, non-organic solid waste, and organic solid waste). The precise numeric values used in the model are provided in Appendix \ref{sec:app-case-study-resources}, Table [TODO:]. Resource demands are defined as rates, i.e. on a per-second basis (kg/s or MW). This is a common way to express energy quantities, which makes sense given that energy is most commonly demanded on such a basis, i.e. as a power[^energy-rate]. This means the $D^*_*$ parameter definition is consistent with PRaQ's definition of process behaviour, where the process rate is defined on a per-second basis. Having all the terms in the main resource balance equations \eqref{eq:praq_balance_qty} and \eqref{eq:praq_balance_qual} defined as per-second rates, negates the need for multiplication factors.

[^energy-rate]: This is in contrast to waste management services (to give one example) in which waste may be collected at regular intervals (e.g. weekly), and set to a particular processing unit once a certain threshold (e.g. tons) has been met. Nevertheless, for usability, there should be consistency between the definition of energy and mass quantities. One way to capture the non-rate properties of many material-based processes would be to introduce storage processes into the model. This may be the subject of future developments, as discussed in Section \ref{sec:further-work-model}.

### Other resources

The resource demands discussed above will define some of the $r$ items in set $R$, but to complete this set requires the resources which used in the network of conversion processes to meet demand. In total, there are 68 resources, including everything from algae to wood. Each resource has at least one associated quality $q$ (belonging to set $Q$), which is attributed to the resource using the $X_{rq}$ and $\delta^R_{rq}$ parameters. The qualities used in this case study are *mass* and *energy*. Most resources are only attributed with one of these (e.g. algae possesses mass, and heat possesses energy), though some resources are attributed with both mass and energy (e.g. ground water has both a mass and an energy head). Each resource is also given a cost, based on values from the literature. The full list of resources along with their associated qualities and costs is given in Section \ref{sec:app-case-study-resources}.

With the resources, zones and times determined (indexed by $r$, $z$, $t$, respectively), the parameters which impose limits on how many zones can import and export particular resources ($N^I_r$, $N^E_r$), and the maximum allowable imports of a resource in a season ($I^{max}_{rt}$, $E^{max}_{rt}$) can be specified (\ref{sec:app-case-study-resources}).

### Conversion processes

The contents of the process set $P$ will vary for each scenario, and will draw from both the SPC proposals, and the database of urban metabolism processes outlined in Chapter 4. The information needed to define the processes are the coefficients which define the input and output resource quantities with ($k_{pr}$), and maximum process rates $F^{max}_p$). For the database processes this information already exists, but for the SPC proposals, this information needs to be derived from the SPC documentation.

In addition to these parameters, each process needs a cost for use in the objective function. This work attempts to estimate process costs. This is not without its difficulties. First, there is the shear number of processes in the database (202in total). Second, the process database includes processes which have not yet penetrated into the market or are still to be developed, thus there are no values which can be easily lifted from the literature. Third, currency exchange rates and purchasing power parities around the world make it difficult to attribute a cost to a process with any degree of certainty. For this reason, costing is approximate.

The broad approach to estimating process costs is to assemble a number of 'process categories' ($\mbox{PC}$), to which processes from the database -- 'database processes' ($\mbox{DP}$) -- are assigned. As an example, *'biogas-fuelled CHP'* is defined as a $\mbox{PC}$, which includes four types of biogas-fuelled CHP conversion processes in the database. For each $\mbox{PT}$, unit costs (USD/MW or USD/kg/s) are obtained from the literature (this may require some assumptions and adjustments to numbers from the literature, of which details are given in Appendix \ref{sec:app-case-study-processes}). A guiding principle of these estimations is that process costs exhibit economies of scale [^scale-economy]. For this to be captured in the model, each $\mbox{PC}$ has both lowerbound and upperbound unit costs. Thus, the total cost of any particular $\mbox{DP}$ with a given capacity (MW or kgs/s) can be calculated from:

[^scale-economy]: For example, if a system demand requires 10 MW, then it should be cheaper to meet that demand with two 5 MW power plants than ten 1 MW power plants.

$$
\begin{align}
\mbox{DP Total Cost} = \mbox{PC Unit Cost}^* \times \mbox{DP capacity},
\end{align}
$$

where $^*$ stands for notation indicating either a lowerbound or an upperbound cost ($\mbox{Cost}^{LB}$ and $\mbox{Cost}^{UB}$, respectively). In this way, lowerbound costs are applied to larger instances of a process, and upperbound costs applied to smaller instances.

For the conversion processes which do not yet exist in the market, costs are estimated by basing them on existing processes which have the same main resource[^main]. This method is conservative in its approach, on the assumption that new processes will not penetrate the market unless they deliver a particular service at lower cost than a more traditional means of conversion[^cost-estimation].

[^main]: Recall from Chapter \ref{sec:process-mapping} the idea of a 'main' resource being the (e.g. electricity output for a powerplant, or wastewater input to a treatment facility), and always has a value of $k_{pr}=\pm 1$.

[^cost-estimation]: Though one may argue against this principle on the basis that a novel process may be more expensive than older methods due to other benefits (e.g environmental benefits). However, this thesis can only hope to be approximate with the cost of conversion processes, and indeed, such estimations warrant their own separate research focus [@Merrow1979, @Roy2005].

In summary, the conversion processes in this case study are drawn from both the SPC documentation (18 in total), and the database assembled in Chapter 4 (202 unique process types, 363 when including processes of different capacities), with each scenario using a subset of these processes (as outlined in Section \ref{sec:SPC-scenarios}, below). Cost estimates have been provided for these processes, which enable PRaQ to take into account economies of scale, and the cost of processes which do not yet exist in the market. The result is that the SPC modelling has up to 381 conversion processes from which to design an integrated resource management system, for which a rough overall system cost can be computed.

### Transport processes {#sec:case-study-transport-processes}

Many of the resources (with some exceptions such as heat[^heat-transport]) can be transported between zones, via three types of transport infrastucuture: roads, along which vehicles can transport everything from municipal solid waste, to gases and liquids carried by tankers; pipes, which transport water and gases; and cables, to carry electricity. As explained in the Section \ref{sec:case-study-site}, the roads are assumed to already exist to connect neighbouring zones ($nb(z,z')$), whilst underground pipes and overhead cables can be optionally added by PRaQ, if and where necessary.

[^heat-transport]: Though whilst heat itself cannot be transported, it can be carried by water, e.g. in a district heating pipe network.

Transport processes are defined by the origin-to-destination resource input and output coefficients, $k^*_{\tau rq}$ (Section \ref{sec:PRaQ}, and should include the resource carried (e.g. water through a pipe), as well as the energy resources required to carry that resource along the length of a connection (e.g. electrical energy to pump water along a pipe), as well as any by-products, wastes, and emissions from the process. Where as the main resource typically leaves the origin zone and arrives in the destination (perhaps minus some losses, such as electricity along a cable), the consumption and production of auxiliary resources should be appropriately shared shared between the origin and destination. The specifics of transport process coefficients are outlined below, for the three main types of transport technologies, with example values of $k^*_{\tau rq}$ given in Table \ref{tab:transp-coeffs}. 

\begin{description}

\item[Cables] This is the simplest transport process type, with no auxiliary resources, thus only a single resource ($r=\mbox{electricity}$) value is necessary here. Electricity transported via cables do incurr losses at rates of between 3--7\% over 1,000 km distances \citep{@IEA2016}, however, given the whole site is only 13 km\textsuperscript{2}, these losses are considered negligable. Thus cables can be defined simply with $k^{\alpha}_{\tau rq}=1$, $k^{\alpha'}_{\tau rq}=-1$, and $k^{\beta}_{\tau rq} = k^{\beta'}_{\tau rq}=0$ when $\tau=\mbox{cable}$, $r=\mbox{electricity}$ (and $q=\mbox{energy}$). 

\item[Pipes] These transport $r=\mbox{water}$ or $r=\mbox{gas}$, and also require the auxilliary resource of electricity to provide pumping energy. As hydraulic calculations given in Appendix \ref{sec:case-study-site} show, for water in a pipe of zero slope, this can be roughly calculated as $0.0054l_{zz'}$ to overcome friction between the water and the pipe\footnote{This is on the assumption the nonlinearities in the relationship between transport mass and volume can be ignored -- further explanation is given in Appendix \ref{sec:case-study-site}}. It is assumed that all this electricity is provided in the zone of the water's origin. For gases it is assumed that friction is low enough so as to make the energy requirements negligable for the distances in the SPC site.

\item[Vehicles] Other resources are carried by vehicles. As well as the carried resource (e.g. $r=\mbox{biomass}$), vehicles require gasoline as an auxilliary resource. It is assumed this is provided entirely by the source zone. As well as this, \COtwo emissions are emitted, with these being shared equally between the origin and destination zones. The $k_{\tau rq}^*$ values are derived in Appendix.

\end{description}

\input{06_case-study/tab-transp-coeffs.tex}

As with the conversion processes, transport processes each need to have an associated cost, $c^T_{\tau}$. As the roads already exist, these are not costed in the model, as their total cost would be the same, whatever the system designed by the model. The cost for the pipes and roads are defined per kilometer, and the values and sources for these calculations are provided in Appendix \ref{sec:app-case-study-processes}.


## Application to model scenarios {#sec:SPC-scenarios}

Having detailed the data sources, assumptions, and calculations used to determine the model's parameters, PRaQ is now applied to seven scenarios (\ref{itm:base}--\ref{itm:wild-long}, below) to suggest how to satisfy SPC demand using different sets of available processes and objective functions:

1. *Base case.* \label{itm:base} This assumes that electricity, fuels and water are imported to the site as needed (with wastewater treated on site), thus there is no attempt to take advantage of synergies. As such, this scenario provides baseline results to which other results can be compared.

2. *Design case.* \label{itm:design} The Shann Gu site developers intend to take advantage of intersectoral synergies to minimise resource consumption. This scenario considers the processes suggested in the Shann Gu documentation, including combined heat and power (CHP), a wastewater source heatpump combined with a district heating network. This scenario has three sub-scenarios to test how the process mix changes, with different objectives:
	a. \label{itm:design-cost} Minimise cost
	b. \label{itm:design-emissions} Minimise emissions
	c. \label{itm:design-waste} Minimise waste
	<!--
	d. \label{itm:design-water} Minimise freshwater consumption
	-->
3. *Wildcard case.* \label{itm:wild} This scenario finds the minimum-cost process mix, when the processes of the @Ravalde2016 database are made available, using three time horizons of process-availability:
   	a. \label{itm:wild-short} Currently available processes
   	b. \label{itm:wild-medium} Medium-term available technologies
   	c. \label{itm:wild-long} Long-term available technologies

Scenario \ref{itm:wild-long} is the largest, and thus indicates the computational effort required to solve the problems, having 1,220,809 single variables, 7,670 discrete variables, and 1,248,035 equations.

These scenarios enable testing of a network's sensitivity to fairly broad design considerations (such technology availability and objective functions). More detailed design problems should be more narrowly focussed, by applying sensitivity analysis to understand how a system design responds to other factors such as changing demand, resource and technology prices, and other factors. [@Keirstead2012, after @Saltelli2008]. These detailed considerations are beyond the scope of this study due to the nature of the model itself \ref{sec:fid-and-gen}, and -- more importantly -- the aims of this thesis, namely to understand the possible benefits of intersectoral synergies in improving urban metabolism.
<!--
OTHER SCENARIO VARIATIONS
- DSM
- min-cost
- min emissions
- cost/emissions pareto
- export revenue (e.g. hydrogen economy)
- Exergy verses other objectives (cost, carbon footprint, water footprint, waste output)
- min cost -- DSM
- min cost -- phased planning
- min water
- min landfill
- min cost/targets of individual sectors (energy, water, waste), or differently weight them?
-->

When GAMS runs a scenario[^case-study-runs], it outputs the results into a set of CSV files, which are passed into an R script for processing so the output data can easily be used to describe the system designs (namely the resource flows and network of processes), and compute quantities such as cost, emissions, water footprint, exergy efficiency, measures from ENA. The following subsections visualise and describe the results, before the next section discusses their implications in view of this chapter's aims. With some systems so large process types, space limitations prevent the display of all results that may be of interest, however, Appendix \ref{sec:app-case-study} provides links to all results in CSV format.

[^case-study-runs]: As with the benchmark study (Chapter 5), the project architecture separates the data and formulation, to facilitate running, reproducibility, modification, and development of the scenario models. Also to that end, the data and formulation are available at \url{https://github.com/tomravalde/shann-gu-case-study}, along with the results of the modelling.

```{r headlines, fig.height=5, fig.cap="fig:headlines", results="asis"}

headlines <- read.csv("06_case-study/headlines.csv")

## Presentation scenario names
headlines$scenario <- as.character(headlines$scenario)
headlines[headlines$scenario=="gridCase_minCost", "scenario"] <- "Grid case (min. cost)"
headlines[headlines$scenario=="designCase_minCost", "scenario"] <- "Design case (min. cost)"
headlines[headlines$scenario=="designCase_minEmissions", "scenario"] <- "Design case (min. emissions)"
headlines[headlines$scenario=="designCase_minWaste", "scenario"] <- "Design case (min. waste)"
headlines[headlines$scenario=="designCase_minWater", "scenario"] <- "Design case (min. water)"
headlines[headlines$scenario=="wildcard_current_minCost", "scenario"] <- "Wildcard case (current)"
headlines[headlines$scenario=="wildcard_medium_minCost", "scenario"] <- "Wildcard case (medium)"
headlines[headlines$scenario=="wildcard_long_minCost", "scenario"] <- "Wildcard case (long)"

## Order the scenario names
headlines <- transform(headlines,
		 scenario=factor(scenario,
		   levels=c("Grid case (min. cost)",
			    "Design case (min. cost)", 
			    "Design case (min. emissions)", 
			    "Design case (min. waste)", 
			    "Design case (min. water)", 
			    "Wildcard case (current)", 
			    "Wildcard case (medium)", 
			    "Wildcard case (long)"),
		    ordered=TRUE))

```

### System designs and etabolic flows

The idea central to this thesis is that the aggregate metabolic flows into and out of a city are governed to a significant extent by the middle of the system, i.e. the network of resource management processes. These metabolic inputs and outputs are displayed for each scenario in Figure \ref{fig:metabolic-flows}. The first broad observation is that, making more processes available to a system tends to result result in system designs which use a larger number of resource management processes and have a greater number of aggregate metabolic inputs and outputs to and from the site (Figure \ref{fig:metabolism_summary}). Thus PRaQ suggests that a site's resource-management objective is best met by a diverse mix of management processes working with a broad set of resources.

```{r metabolic_flows, fig.height=7, fig.width=7.5, fig.cap="Metabolic flows into and out of the SPC site.\\label{fig:metabolic-flows}"}

## Metabolic flows

metabolic_flows <- read.csv("06_case-study/metabolic_flows.csv")

## Reshape imports and exports into the same column
metabolic_flows <- melt(metabolic_flows, variable.name="Flow")

## Remove the non-real outflows
					      
metabolic_flows[metabolic_flows$scenario=="Design case (min. water)" & metabolic_flows$Flow=="exports" & metabolic_flows$resource=="elec", "value"] <- 0

metabolic_flows[metabolic_flows$scenario=="Design case (min. waste)" & metabolic_flows$Flow=="exports" & metabolic_flows$resource=="elec", "value"] <- 0

metabolic_flows[metabolic_flows$scenario=="Design case (min. water)" & metabolic_flows$Flow=="exports" & metabolic_flows$resource=="heat", "value"] <- 0

metabolic_flows[metabolic_flows$scenario=="Design case (min. waste)" & metabolic_flows$Flow=="exports" & metabolic_flows$resource=="heat", "value"] <- 0

metabolic_flows[metabolic_flows$scenario=="Design case (min. water)" & metabolic_flows$Flow=="exports" & metabolic_flows$resource=="gasNatural", "value"] <- 0

metabolic_flows[metabolic_flows$scenario=="Design case (min. emissions)" & metabolic_flows$Flow=="exports" & metabolic_flows$resource=="gasNatural", "value"] <- 0

metabolic_flows[metabolic_flows$scenario=="Wildcard case (short)" & metabolic_flows$Flow=="exports" & metabolic_flows$resource=="waterNonPotable", "value"] <- 0

metabolic_flows[metabolic_flows$scenario=="Wildcard case (medium)" & metabolic_flows$Flow=="exports" & metabolic_flows$resource=="waterNonPotable", "value"] <- 0

metabolic_flows[metabolic_flows$scenario=="Wildcard case (long)" & metabolic_flows$Flow=="exports" & metabolic_flows$resource=="waterNonPotable", "value"] <- 0

metabolic_flows[metabolic_flows$scenario=="Design case (min. emissions)" & metabolic_flows$Flow=="exports" & metabolic_flows$resource=="water", "value"] <- 0

## Remove zero-valued entries
metabolic_flows <- filter(metabolic_flows, value!=0)

## Order the scenario names
metabolic_flows <- transform(metabolic_flows,
		 scenario=factor(scenario,
		   levels=c("Grid case (min. cost)",
			    "Design case (min. cost)", 
			    "Design case (min. emissions)", 
			    "Design case (min. waste)", 
			    "Design case (min. water)", 
			    "Wildcard case (current)", 
			    "Wildcard case (medium)", 
			    "Wildcard case (long)"),
		    ordered=TRUE))


## Rename the aggregate flows
metabolic_flows$Flow <- as.character(metabolic_flows$Flow)
metabolic_flows[metabolic_flows$Flow=="imports", "Flow"] <- "Aggregate metabolic inputs to the SPC site"
metabolic_flows[metabolic_flows$Flow=="exports", "Flow"] <- "Aggregate metabolic outputs from the SPC site"

## Rename the resources
metabolic_flows$resource <- as.character(metabolic_flows$resource)
metabolic_flows[metabolic_flows$resource=="algaeDry", "resource"] <- "Algae [kg/s]"
metabolic_flows[metabolic_flows$resource=="ash", "resource"] <- "Ash [kg/s]"
metabolic_flows[metabolic_flows$resource=="biomass", "resource"] <- "Biomass [kg/s]"
metabolic_flows[metabolic_flows$resource=="CO2", "resource"] <- "CO2 [kg/s]"
metabolic_flows[metabolic_flows$resource=="coal", "resource"] <- "Coal [kg/s]"
metabolic_flows[metabolic_flows$resource=="cool", "resource"] <- "Cooling [MW]"
metabolic_flows[metabolic_flows$resource=="digestate", "resource"] <- "Digestate [kg/s]"
metabolic_flows[metabolic_flows$resource=="elec", "resource"] <- "Electricity [MW]"
metabolic_flows[metabolic_flows$resource=="gasNatural", "resource"] <- "Natural gas [kg/s]"
metabolic_flows[metabolic_flows$resource=="gasoline", "resource"] <- "Gasoline [kg/s]"
metabolic_flows[metabolic_flows$resource=="groundWater", "resource"] <- "Groundwater [kg/s]"
metabolic_flows[metabolic_flows$resource=="heat", "resource"] <- "Heat [MW]"
metabolic_flows[metabolic_flows$resource=="methane", "resource"] <- "Methane [kg/s]"
metabolic_flows[metabolic_flows$resource=="waste", "resource"] <- "Solid waste [kg/s]"
metabolic_flows[metabolic_flows$resource=="wastewater", "resource"] <- "Wastewater [kg/s]"
metabolic_flows[metabolic_flows$resource=="water", "resource"] <- "Water [kg/s]"
metabolic_flows[metabolic_flows$resource=="water_pure", "resource"] <- "Water (purified) [kg/s]"
metabolic_flows[metabolic_flows$resource=="waterNonPotable", "resource"] <- "Water (non-potable) [kg/s]"
metabolic_flows[metabolic_flows$resource=="waterPotable", "resource"] <- "Water (potable) [kg/s]"

## Rename the seasons
metabolic_flows$season <- as.character(metabolic_flows$season)
metabolic_flows[metabolic_flows$season=="sum", "season"] <- "Summer"
metabolic_flows[metabolic_flows$season=="wint", "season"] <- "Winter"
metabolic_flows[metabolic_flows$season=="shoulder", "season"] <- "Shoulder"

## Remove the minimum water scenario
metabolic_flows <- filter(metabolic_flows, scenario!="Design case (min. water)")

plot_metabolic_flows <- ggplot(metabolic_flows, aes(resource, scenario)) +
  geom_point(aes(colour=season, size=value), position=position_dodge(width=0.6)) +
  facet_wrap(~Flow, ncol=1) +
  labs(colour="Season") +
  labs(size="Flow rate value") +
  theme_bw() +
  theme(axis.text.x=element_text(hjust=1, angle=30, size=6.5),
  	axis.text.y=element_text(hjust=1, angle=30, size=6.5),
	axis.title=element_blank())
plot_metabolic_flows
```


```{r summarise_metabolisms, fig.height=7, fig.width=5.5, fig.cap="Making more processes available results in the model choosing more management processes and a more diverse mix of aggregate metabolic flows into and out of the SPC site.\\label{fig:metabolism_summary}"}
## Summarise numbers of aggregate metabolic flows

flows_summary <- metabolic_flows %>% distinct(scenario, resource) %>% select(scenario, resource) %>% group_by(scenario) %>% summarise(Value = n())
flows_summary$variable <- "Number of resources in aggregate metabolic flows"

## Summarise numbers of processes
process_mix <- read.csv("06_case-study/process_mix.csv")
process_mix <- filter(process_mix, number>0 & rate>0)

process_mix$season <- as.character(process_mix$season)
process_mix[process_mix$season=="sum", "season"] <- "Summer"
process_mix[process_mix$season=="wint", "season"] <- "Winter"
process_mix[process_mix$season=="shoulder", "season"] <- "Shoulder"

processes_by_scenario <- process_mix %>% distinct(scenario, process) %>% select(scenario, process) %>% group_by(scenario) 

process_summary <- processes_by_scenario %>% summarise(Value = n())

process_summary$variable <- "Number of resource management processes used"


## Combine data
count_summary <- rbind(flows_summary, process_summary)

plot_count_summary <- ggplot(count_summary, aes(Value, scenario)) +
  geom_point() +
  facet_wrap(~variable, ncol=1, scales="free") +
  theme_bw() +
  theme(axis.title=element_blank())
plot_count_summary

## Processes common to each wildcard scenario
wildcard_common <- processes_by_scenario %>% group_by(process) %>% summarise(count = n()) %>% filter(count==3)



```

<!--
```{r process_mix, fig.height=7, fig.width=6.5, results="asis"}

process_mix <- read.csv("06_case-study/process_mix.csv")

## Remove zero-valued entries
process_mix <- filter(process_mix, rate!=0)

## Calculate total capacity (rate * number)

process_mix$total_capacity <- process_mix$rate * process_mix$number

## Order the scenario names
process_mix <- transform(process_mix,
		 scenario=factor(scenario,
		   levels=c("Grid case (min. cost)",
			    "Design case (min. cost)", 
			    "Design case (min. emissions)", 
			    "Design case (min. waste)", 
			    "Design case (min. water)", 
			    "Wildcard case (current)", 
			    "Wildcard case (medium)", 
			    "Wildcard case (long)"),
		    ordered=TRUE))



plot_process_mix <- ggplot(process_mix, aes(zone, process)) +
  geom_tile(fill="white", colour="black") +
  geom_text(aes(label=paste("R=", rate, "\n", "N=", number)), size=2) +
  facet_wrap(~scenario, ncol=3) +
  theme_bw() +
  theme(axis.text.x=element_text(hjust=1, angle=30),
	axis.title=element_blank())
plot_process_mix

```
-->

The network of processes for each scenario are visualised in Figures \ref{fig:designCase_minCost} to \ref{fig:wildcard_long}. These are SNA-style node-link graphs (undirected) in which processes that transfer resources one to another are connected by lines. The proximity of any pair of linked processes is proportional to the quantities of resources transferred. From this, it follows that the more central a process is to the plot, the more its integrated into the network because it tends to be linked to more other processes. Conversely, the closer a process is to the fringe of a plot, the less other processes are dependent on it. The processes have been coloured according to the management sector to which they belong[^sna-process-type]; this helps visualise the intersectoral interactions and synergies. Inputs, outputs and demands are also represented; thus if an imported resource is used in any particular process, then there will be a line connecting imports and said process (likewise for exports).

[^sna-process-type]: This is determined by the 'main' output of each process.

In all scenarios, energy conversion processes are dominant, but there are nevertheless intersectoral interactions (such as the energy demands in water and wastewater treatment), and synergies (such as heat generated by the watersource heatpump in the Design Case scenarios -- Figures \ref{fig:designCase_minCost}--\ref{fig:designCase_minWater}. In each scenario, the system middle (i.e. the network of conversion processes and resource flows) differ, according to the design objective and available processes.

\begin{figure}[h!]
	\centering
	\includegraphics[width=0.75\textwidth]{06_case-study/SNA_designCase_minCost.pdf} 
	\caption{Process network for the Design case (minimum cost) scenario.} \label{fig:designCase_minCost}
\end{figure}

\begin{figure}[h!]
	\centering
	\includegraphics[width=0.75\textwidth]{06_case-study/SNA_designCase_minEmissions.pdf} 
	\caption{Process network for the Design case (minimum emissions) scenario.} \label{fig:designCase_minEmissions}
\end{figure}

\begin{figure}[h!]
	\centering
	\includegraphics[width=0.75\textwidth]{06_case-study/SNA_designCase_minWaste.pdf} 
	\caption{Process network for the Design case (minimum waste) scenario.} \label{fig:designCase_minWaste}
\end{figure}

<!--
\begin{figure}[h!]
	\centering
	\includegraphics[width=0.75\textwidth]{06_case-study/SNA_designCase_minWater.pdf} 
	\caption{Process network for the Design case (minimum water) scenario.} \label{fig:designCase_minWater}
\end{figure}
-->

\begin{figure}[h!]
	\centering
	\includegraphics[width=0.75\textwidth]{06_case-study/SNA_wildcard_current_minCost.pdf} 
	\caption{Process network for the Wildcard case (current) scenario.} \label{fig:wildcard_current}
\end{figure}

\begin{figure}[h!]
	\centering
	\includegraphics[width=0.75\textwidth]{06_case-study/SNA_wildcard_medium_minCost.pdf} 
	\caption{Process network for the Wildcard case (medium) scenario.} \label{fig:wildcard_medium}
\end{figure}

\begin{figure}[h!]
	\centering
	\includegraphics[width=0.75\textwidth]{06_case-study/SNA_wildcard_long_minCost.pdf} 
	\caption{Process network for the Wildcard case (long) scenario.} \label{fig:wildcard_long}
\end{figure}

#### Design case scenarios
<!--
Relative to the Grid Case, the import requirements of the design scenarios are generally lower (slightly lower electricity and gas in general, and much lower summer electricity because of the use of absorption cooling rather than electrically-powered HVAC systems). There is also a different set of water imports, i.e. water for treatment on site, rather than water to arrive on site pretreated.
-->
 
The Design Case scenarios have up to twelve unique processes available to use. Each scenario has chosen a common set of seven processes: (1) water treatment plants, (2) wastewater treatment plants, (3) an anaerobic digestion facility (which generates gas from the organic fraction of waste), (4) ground-source heat pumps, (5) water-source heatpumps, and (6) absorption chillers, (7) heat exchangers (to deliver hot and cold water through a district heating network), and (8) electrically-powered HVAC systems (to provide cooling).

As well as the scenarios having processes in common, their different objectives drive differences in the mix of conversion processes PRaQ selects for the system's middle, affecting the aggregate metabolic flows into and out of the site at the top of the system. These differences are summarised in Table \label{tab:design-case-differences}, and further explained below.

\begin{table}[]
\centering
\caption{A summary of differences in conversion process mix and aggregate metabolic flows between the Design Case scenarios.}
\label{tab:design-case-differences}
\begin{tabular}{lccccp{4cm}}
\toprule
\multirow{2}{*}{Scenario} & \multicolumn{4}{c}{Conversion processes not common to all Design Case scenarios}                        & \multirow{2}{*}{Comment on site's \\ aggregate metabolic flows}                       \\
\cmidrule{2-5}
                          & CHP        & Boiler     & HVAC (cooling) & Absorption heating &                                                                                    \\
\midrule
Minimum cost              & \checkmark &            & \checkmark     & \checkmark         & Removes need for electricity imports, lowers gas imports, and lowers water imports \\
Minimum emissions         &            &            &                &                    & Greater electricity imports than the minimum cost scenario                         \\
Minimum waste             & \checkmark & \checkmark & \checkmark     & \checkmark         & No output of organic waste or wastewater                                          \\
\bottomrule
\end{tabular}
\end{table}

The minimum cost scenario keeps costs down by importing less electricity, natural gas and water than some of the other scenarios. Importing no electricity means the site generates its own through CHP. Importing less gas means that PRaQ does not pick any gas-fuelled boilers, which means that heating is generated by electrically-powered HVAC systems, rather than district heating networks (which require water, hence the reduction in water imports).

For the Minimum Emissions scenario, PRaQ does not choose CHP or domestic gas-fuelled boilers (both of which burn fossil fuels), which means this scenario achieves zero 'Scope 1' emissions. Instead, the system opts to import electricity to meet demand, and also to power heat pumps (for heating and cooling) and HVAC technologies (for cooling), given that -- unlike in the other scenarios -- CHP cannot be used to provide heat.

The Minimum Waste scenario minimises the site's waste output by sending organic waste to feed anaerobic fermentation. This generates natural gas which supplies the both CHP and boiler (unlike for the above two scenarios). In addition, all the wastewater generated by the site is treated (hence more potable water than the site needs is produced). This scenario also gives an opportunity to investigate seasonal variation, because while the system imports electricity for most of the year, it does not in the summer. This ultimately relates the demand for heating and cooling, which is met via: heat entering the district heating network, and electricity powering HVAC systems. The heat is produced by the CHP, and the electricity is generated by the CHP and supplemented from imports. But these supplementary imports are not required in the shoulder season, which has a lower overall total demand for heating and cooling than the rest of the year (as Figure \ref{fig:site-demands} shows, there is zero cooling demand, and less heating demand than the winter). Thus, in summer, the additional use of anaerobic fermentation compared to the other Design case scenarios produces enough electricity to meet cooling demand.

These results demonstrate that:

- aggregate metabolic flows are indeed governed by the system middle
- intersectoral interactions and synergies
- and hence objectives to change the aggregate metabolic flows will affect the optimal system middle
- the place of modelling in determining this


<!--
Note also that minimum waste and minimum water design the same system, though they operate slightly differently, for example, AD plays a greater role in the former case (resulting in exports of natural gas from the site). It also exports greater amounts of treated water, because it has not had constraints on how much untreated water can be imported.
-->


#### Wildcard scenarios

The wildcard scenarios each have the same objective of cost minimisation, and share 11 processes types in common[^wildcard-common]. Broadly, the networks are based around distributed energy systems adopting a diverse mix of technologies. The networks exhibit intersectoral links, such as waste gasification (waste-energy synergy), wastewater reuse projects (waste-water synergy), and groundwater pumping (energy-waste trade-off). As well as processes in common¸ there is variation in both the overall metabolic flows, and the process mix. The systems are more complicated than the Design cases, so not everything can be explained here, but some examples make the point that the system's metabolism relates to its process mix.

[^wildcard-common]: The number 11 partly depends on how processes are categorised into types. The types in common are: central heating, CHP (gas-, biomass- and hydrogen-fuelled), air conditioning, evaporative cooling, absorption cooling, hydrogen generation¸ waste gasification, groundwater pumping, heat exchanger networks, water treatment, and wastewater reuse treatment.

With regards to the aggregate inflows, inputs of fossil fuels (coal and gasoline) are a notable variation: the current scenario imports them in all three seasons, whereas the medium-term scenario imports them in the winter only, and the longterm scenario imports them in winter and summer. All three scenarios use coal to fuel the process which converts water to hydrogen; this hydrogen and the imported gasoline are used in heat-producing processes which then meet heating demand and cooling demand (via heat exchangers). But the mix of processes which can provide heat is such that they do not all need gasoline or hydrogen, hence there are times when gasoline and coal imports can be reduced.

Another difference in aggregate inflows is for non-potable water which is greater in the Medium-term long-term scenario (in the shoulder and summer seasons) than for the other two scenarios. The medium-term scenario has more processes which can treat water for recreational use, so can meet this demand via greater import quantities of non-potable water. This results in lower imports of recreational water in the current scenario, when compared to the medium-term scenario. However, the quantities of recreational water the long-term scenario imports compared to the medium is about the same. This is because the long-term scenario needs to import more water to feed the hydrogen-generating process (mentioned above).

Other differences include the longterm scenario's summer inflow of algae to feed a biodiesel generation process. Studying the aggregate outflows, there are further variations, in both the type and quantity of resources, such as the outflow of ash and methane in the longterm scenario, due to the presence of a coal-fuelled powerplant (producing ash as a waste) and the biodiesel generation mentioned above (producing methane as a by-product). Finally, there are differences at a seasonal level, where solid waste output is reduced to zero in medium-term summer, and the longterm summer and shoulder. 

To summarise the, the wildcard scenarios take advantage of the availability of more conversion processes in order to meet the objective of cost minimisation and result in systems -- which while complex -- still shows the that aggregate metabolic flows into and out of an area are sensitive to the process mix in the middle of a system, where there are all sorts of knock-on effects, between resource management sectors.

<!--
and digestate (medium and longterm), and electricity (current only). [TODO: explain these differences with reference to the networks.] 
-->


<!--
### Other measures

It follows from this that an area's optimal networks are sensitive to the objective, seen also when different objectives are applied to the same process mix (e.g. 2a and 2b [TODO: update if necessary]). However, what is the effect of PRaQ's optimisation on other metrics?

[TODO: comment on the mix of technology sizes in various scenarios.]

[TODO: comment on which technogies are most relied upon in each system.]

[TODO: comment on transportation reliance (e.g. central import + distribution, or central import and conversion, etc.?]

[TODO: comment on coversion/transportation mix effect on (capital) costs?]

#### System costs

System cost is calculated as the sum of the processes (conversion and transport) and resource imports. These costs are calculated on an annual basis, assuming infrastructure has a ten year lifespan. This can be done using Equation \ref{eq:objective_cost}, $C = \gamma^R C^R + \gamma^P C^P + \gamma^{\tau} C^{\tau}$ with $\gamma^*$ taking values of 1, 0.1, and 0.1, respectively. Figure \ref{fig:system-costs} displays the system cost for those scenarios whose objective is to minimise cost (1, 2a, and 3a-c).

```{r costs, fig.height=5, fig.cap="fig:costs", results="asis"}

## Presentation costs
headlines$metrics <- as.character(headlines$metrics)
headlines[headlines$metrics=="headline_cost", "metrics"] <- "Cost [USD/year]"
headlines[headlines$metrics=="headline_emissions", "metrics"] <- "Emissions [million tons/year]"
headlines[headlines$metrics=="headline_waste", "metrics"] <- "Waste [million tons/year]"
headlines[headlines$metrics=="headline_water", "metrics"] <- "Water [million tons/year]"
system_costs <- filter(headlines, scenario %in% c("Grid case (min. cost)",
						  "Design case (min. cost)",
						  "Wildcard case (current)",
						  "Wildcard case (medium)",
						  "Wildcard case (long)"))

system_costs <- filter(system_costs, metrics=="Cost [USD/year]")

system_costs <- mutate(system_costs, values=values/1e6)

#plot_system_costs <- ggplot(system_costs, aes(scenario, values)) +
#  geom_point() +
#  xlab("Scenario") +
#  ylab("Annualised cost [millions USD]") +
#  theme_bw() +
#  theme(axis.text.x = element_text(hjust=1, angle=30))
#plot_system_costs
```

```{r component-costs, fig.height=5, fig.cap="System costs for scenarios where the objective function was to minimise cost.\\label{fig:system-costs}", results="asis"}
component_costs <- read.csv("06_case-study/component-costs.csv")
component_costs <- melt(component_costs, variable.name="Component")

## Presentation system component names
component_costs$"Component" <- as.character(component_costs$"Component")
component_costs[component_costs$"Component"=="Conversion.processes", "Component"] <- "Conversion processes"
component_costs[component_costs$"Component"=="Transport.processes", "Component"] <- "Transport processes"

## Presentation scenario names
component_costs$Scenario <- as.character(component_costs$Scenario)
component_costs[component_costs$Scenario=="gridCase_minCost", "Scenario"] <- "Grid case (min. cost)"
component_costs[component_costs$Scenario=="designCase_minCost", "Scenario"] <- "Design case (min. cost)"
component_costs[component_costs$Scenario=="designCase_minEmissions", "Scenario"] <- "Design case (min. emissions)"
component_costs[component_costs$Scenario=="designCase_minWaste", "Scenario"] <- "Design case (min. waste)"
component_costs[component_costs$Scenario=="designCase_minWater", "Scenario"] <- "Design case (min. water)"
component_costs[component_costs$Scenario=="wildcard_current_minCost", "Scenario"] <- "Wildcard case (current)"
component_costs[component_costs$Scenario=="wildcard_medium_minCost", "Scenario"] <- "Wildcard case (medium)"
component_costs[component_costs$Scenario=="wildcard_long_minCost", "Scenario"] <- "Wildcard case (long)"

## Order the scenario names
component_costs <- transform(component_costs,
		 Scenario=factor(Scenario,
		   levels=c("Grid case (min. cost)",
			    "Design case (min. cost)", 
			    "Design case (min. emissions)", 
			    "Design case (min. waste)", 
			    "Design case (min. water)", 
			    "Wildcard case (current)", 
			    "Wildcard case (medium)", 
			    "Wildcard case (long)"),
		    ordered=TRUE),
		Component=factor(Component,
				levels=c("Conversion processes",
					"Transport processes",
				       "Resources"),
			 ordered=TRUE))	 
			     
component_costs <- filter(component_costs, Scenario %in% c("Grid case (min. cost)",
						  "Design case (min. cost)",
						  "Wildcard case (current)",
						  "Wildcard case (medium)",
						  "Wildcard case (long)"))

component_costs_outlierRemoved <- filter(component_costs, Scenario!="Grid case (min. cost)")
component_costs$chart <- "System costs"
component_costs_outlierRemoved$chart <- "System costs (Grid case removed)"
component_costs <- rbind(component_costs, component_costs_outlierRemoved)

plot_component_costs <- ggplot(component_costs, aes(Scenario, value/1e6, fill=Component, order=Component)) +
  geom_bar(stat="identity") +
  facet_wrap(~ chart, scales="free") +
  labs(fill = "System component") +
  xlab("Scenario") +
  ylab("Annualised cost [millions USD]") +
  theme_bw() +
  theme(axis.text.x = element_text(hjust=1, angle=30))
plot_component_costs
```

The grid case is fixed such that its costs consist entirely of resources, and is very expensive because of the premium for importing a resource. However, the design case and wildcard case show much lower costs, with the wildcard cases coming out the cheapest, because of having a larger set of conversion process to choose from.

<!--
#### Other headline results

Emissions, water footprint and waste output are calculated on an annual basis, using the general equation [TODO: write and reference an emissions equation], with the following conditions:

- $r = \mbox{\CO2}$
- $r \in S^{water}$
- $r \in S^{waste}$

(Provide footnotes to define the water and waste sets.)

The headline results are given in Figure \ref{fig:headlines}. The results show:

- That when cost is the minimum objective -- the case for all scenarios with the exception of three of the design cases -- that low costs can indeed be achieved.
- Looking at each of the design cases, they each successfully minimise the quantity of interest to zero, and in fact manage to do while other quantities go to zero.
- However there is an exception to this, which reveals a clear tradeoff: for example, that minimum waste design case results in a large water consumption.
- The wildcard cases improve performance the longer the more processes they consider.
- Second, we consider each system's emissions from the processes (though it is beyond the scope of this study to trace emissions up the supply chain) (Figure [TODO: cross-ref]).
-->

<!--
($\sum_{pz} C^P_p N^P_p + \sum{\tau zz'} C^{\tau}_{\tau} \delta_{\tau zz'} l_zz'$, emissions, waste output and water footprint.
-->

<!--
```{r other-headlines, fig.height=5, fig.cap="fig:costs", results="asis"}
headlines <- filter(headlines, metrics!="Cost [USD/year]")

## Just for the design case

headlines <- filter(headlines, scenario %in% c("Design case (min. cost)",
					       "Design case (min. emissions)",
					       "Design case (min. water)",
					       "Design case (min. waste)"))

plot_headlines <- ggplot(headlines, aes(scenario, values/1e9)) +
  geom_point() +
  facet_wrap(~metrics, ncol=1, scales="free_y") +
  theme_bw() +
  theme(axis.text.x = element_text(hjust=1, angle=30))
plot_headlines
```
-->

### System designs and grey-box metrics

The aggregate metabolic flows and costs considered above are black-box metrics \ref{sec:black-grey-box}. The results show how these metrics or metabolic flows are affected by the mix of management processes (as hypothesised throughout this thesis). However, Chapter 3 showed that the so-called grey-box metrics of exergy analysis and ENA can further understanding an area's use of resources, by delving into the details of process mixes and their governance.

#### Exergy analysis

Exergy analysis was shown to provide a process-based engineering perspective on urban resource efficiency in response to the challenge of the MRTP (namely, the fact that a city sustains its populations using multiple resource types). It does this in three particular ways: going to the process level (rather than the system level) to understand process efficiency; understanding how resources are deployed among the processes; and highlighting where contextual allowances should be made when analysing urban resource efficiency \ref{sec:app-grey-box-metrics}.

Here, exergy analysis is carried out for each scenario, using a simplified version of the method described in Section \ref{sec:methods-grey-box}. In this simplification, there is no need to distribute the flows between the processes within the city (the second step), on the understanding that the PRaQ method accounts any process products unused by other processes to become system outputs (exports). This means system exergy efficiency can be calculated at the whole-system level (rather than deriving system-level efficiency from the bottom up, process by process). Thus exergy efficiency $\eta_{ex}=\alpha^{prod}_{ex}/\alpha^{in}_{ex}$ (Equation \eqref{eq:ex-eff}) can be calculated without using Equations \eqref{eq:ex-eff-in} and \eqref{eq:ex-eff-prod}, where $\alpha^{prod}_{ex}$ are the system demands, and $\alpha^{in}_{ex}$ are the site's aggregate metabolic in flows. The results of exergy analysis for each scenario are given in Table \ref{tab:SPC-exergy} (data and calculations provided in Appendix [TODO: cross-ref]). 

\footnote{The simplification of Equations \eqref{eq:ex-eff-in} and \eqref{eq:ex-eff-prod} can be formalised as:

\begin{align}
\begin{split}
\alpha^{in}_{ex}&=\sum_{p \in P}  \sum_{i \in R^i}  Ex^{in}_{p,i} \\
&= \sum_{i \in R^i} Ex_i 
\label{eq:SPC-ex-in}
\end{split}
\end{align}

\begin{align}
\alpha^{prod}_{ex}&= \sum_{j \in D^j} Ex_j
\label{eq:SPC-ex-out}
\end{align}

where $D^j$ is the set of a site's resource demands, and $Ex_{*}$ represent the exergy value of a resource (for example the chemical exergy of a fossil fuel, or the exergy of heating).}

```{r exergy, fig.height=5, fig.cap="fig:exergy", results="asis"}

## Exergy efficiency analysis

library(xtable)
exergy <- read.csv("06_case-study/exergy.csv")
exergy <- exergy[ ,-2]

#ex_prod <- exergy$prod[1]
#
### Presentation scenario names
#exergy$scenario <- as.character(exergy$scenario)
#exergy[exergy$scenario=="gridCase_minCost", "scenario"] <- "Grid case (min. cost)"
#exergy[exergy$scenario=="designCase_minCost", "scenario"] <- "Design case (min. cost)"
#exergy[exergy$scenario=="designCase_minEmissions", "scenario"] <- "Design case (min. emissions)"
#exergy[exergy$scenario=="designCase_minWaste", "scenario"] <- "Design case (min. waste)"
#exergy[exergy$scenario=="designCase_minWater", "scenario"] <- "Design case (min. water)"
#exergy[exergy$scenario=="wildcard_current_minCost", "scenario"] <- "Wildcard case (current)"
#exergy[exergy$scenario=="wildcard_medium_minCost", "scenario"] <- "Wildcard case (medium)"
#exergy[exergy$scenario=="wildcard_long_minCost", "scenario"] <- "Wildcard case (long)"

#exergy <- select(exergy, scenario, in., waste, irrev, eff)
names(exergy) <- c("Scenario", "$\\alpha^{in}_{ex}$", "$\\eta_{ex}$ [per cent]")

tab.exergy.tex <- xtable(exergy,
			  caption="Results of exergy analysis for SPC scenarios. All $\\alpha^{in}_{ex}$ values in MW; $\\alpha^{in}_{ex} = 47$ MW for each scenario.\\label{tab:SPC-exergy}",
			  align="llll")

print(tab.exergy.tex,
##      size='\\small',
      table.placement='htbp!',
      include.rownames=FALSE,
      sanitize.text.function=identity,
      comment = FALSE)
```


The results show that [TODO: describe results]

- The Grid case has no waste exergy, because there are no processes on site:
	- i.e. all exergy losses would be accounted for offsite 
	- there is a small exergy loss in terms of wastewater generated by the site, however the exergy value of this is negligable [TODO: recalculate with physical exergy] 
- Exergy wastes could be considered products rather than wastes if they were sold (e.g. the large electricity and heating exports from the design case). Hence the in efficiency of these cases.
- Should focus on non-water exports or selling other exports to increase exergy efficiency
- While water itself has negligable effects on exergy, the type of water imported may have indirect exergy impacts, due to treatment processes, etc.

- shows that exergy efficiency changes with system mix
- and possibly increases with more processes
- note the import quantities are much lower, so exergy efficiency greater
- Design case results suggest that optimising for some objectives may not result in the most exergy-efficient system:
	- there is a sacrifice -- when minimising emisisons/waste, there has to be lots of waste-age in other areas! Trade-off!
  	- suggests system cost efficiency correlates with exergy efficiency

#### Ecological network analysis

The other grey-box metric considered in this thesis is ecological network analysis (ENA). Chapter 3 showed this approach could reveal how city's economic sectors work together. The results of this type of analysis are important, because they indicate to planners the extent to which the different management parties rely on one another, and hence where they need to cooperate, and where there are risks/vulnerabilities if there is no high-level understanding of intersectoral dependency (Section \ref{sec:app-grey-box-metrics}). Again, using the method outlined in Section \ref{sec:methods-grey-box}, the interdependencies of management sectors can be quantified in the integral utility matrix, whose elements quantify the combined direct and indirect exergy contributions between any pair of compartments.

- From this, the overall degree of system integration 
- More processes = more integration
- Comment on implications


```{r ena, fig.height=5, fig.cap="fig:ena", results="asis"}

ena <- read.csv("06_case-study/ENA.csv")

## Presentation scenario names
ena$scenario <- as.character(ena$scenario)
ena[ena$scenario=="gridCase_minCost", "scenario"] <- "Grid case (min. cost)"
ena[ena$scenario=="designCase_minCost", "scenario"] <- "Design case (min. cost)"
ena[ena$scenario=="designCase_minEmissions", "scenario"] <- "Design case (min. emissions)"
ena[ena$scenario=="designCase_minWaste", "scenario"] <- "Design case (min. waste)"
ena[ena$scenario=="designCase_minWater", "scenario"] <- "Design case (min. water)"
ena[ena$scenario=="wildcard_current_minCost", "scenario"] <- "Wildcard case (current)"
ena[ena$scenario=="wildcard_medium_minCost", "scenario"] <- "Wildcard case (medium)"
ena[ena$scenario=="wildcard_long_minCost", "scenario"] <- "Wildcard case (long)"

names(ena) <- c("Scenario", "Direct", "Utility")

ena <- filter(ena, Scenario!="Design case (min. water)")

tab.ena.tex <- xtable(ena,
			  caption="Results of ENA for SPC scenarios. \\label{tab:SPC-ENA}",
			  align="llll")

print(tab.ena.tex,
##      size='\\small',
      table.placement='htbp!',
      include.rownames=FALSE,
      sanitize.text.function=identity,
      comment = FALSE)
```

```{r ena-matrices, fig.height=7, fig.cap="fig:ena", results="asis"}

ena_matrices <- read.csv("06_case-study/ena-matrices.csv")


ena_matrices <- transform(ena_matrices,
		       Sign=factor(Sign, levels=c(-1,0,1),
				    labels=c("-","0","+")))

## Presentation scenario names
ena_matrices$Scenario <- as.character(ena_matrices$Scenario)
ena_matrices[ena_matrices$Scenario=="designCase_minCost", "Scenario"] <- "Design case (min. cost)"
ena_matrices[ena_matrices$Scenario=="designCase_minEmissions", "Scenario"] <- "Design case (min. emissions)"
ena_matrices[ena_matrices$Scenario=="designCase_minWaste", "Scenario"] <- "Design case (min. waste)"
ena_matrices[ena_matrices$Scenario=="designCase_minWater", "Scenario"] <- "Design case (min. water)"
ena_matrices[ena_matrices$Scenario=="wildcard_current_minCost", "Scenario"] <- "Wildcard case (current)"
ena_matrices[ena_matrices$Scenario=="wildcard_medium_minCost", "Scenario"] <- "Wildcard case (medium)"
ena_matrices[ena_matrices$Scenario=="wildcard_long_minCost", "Scenario"] <- "Wildcard case (long)"

plot_ENA <- ggplot(ena_matrices, aes(From, To)) +
  geom_tile(fill=NA, color="black", na.value=NA) +
  geom_text(aes(label=Sign), size=3) +
  facet_grid(Scenario~Matrix) +
  theme_bw() +
  theme(axis.text.x = element_text(angle=30, hjust=1))
plot_ENA
```

### Summary

[TODO: Amalgamate or reorder the subsection and the next section]

This chapter has demonstrated how to apply the PRaQ model to a site about which information regarding its seasonally and spatially demands for goods and services to plan 'highly integrated' resource management systems. Alongside the PRaQ modelling itself, this chapter has described and applied a rule-of-thumb method to estimate the costs of processes, taking into account economies of scale, even for conversion process which do not yet exist.

Application of PRaQ to the SPC site show the sensitivity of integrated systems to the objective (the design-case scenarios), as well as the preference of integrated systems to choose a large number of varied processes, and also make use of the available transport connections, to decentralise resource management (wildcard scenarios) [TODO: check this point on decentralisation]. Note however that the model is nevertheless discerning: given 300 [TODO: accurate number] processes to choose from, it selects only [TODO: number] for the wildcard scenarios. Similarly, out of N possible transport options [TODO: footnote giving calculations: available connections  transport types for each]. Thus the PRaQ model successfully and intelligently optimizes the process mix.

Finally, the case study has shown how grey-box metrics can provide insight on the make-up of highly integrated systems produced by the PRaQ model, by quantifying both the overall system efficiency (exergy analysis), and the interdependencies between the management sectors of an integrated system (ENA). [TODO: Add to this paragraph.] 

## Discussion and conclusions
<!--
Paragraph ideas from JK's MILP paper
# Conclusions

- "There have been many models developed...however..."
- "In this paper we..."
- "Another feature of the model..."
- "The model was illustrated using..."
- "There are a number of future directions for the model..."
-->

The results of the modelling show that the PRaQ model is helpful to the SPC planners, justifying their decision to integrate resource management systems. The modelling of the design-case scenarios show the SPC's plans to use the energy island and water reuse project are an improvement over direct imports of resources and exports of wastes , but the wildcard modelling also challenges the planners to consider a more sophisticated, assorted and decentralised network of processes which uses a varied schedule of resource imports and exports

This complex results from the wildcard scenarios are themselves a demonstration of the power of modelling for the SPC, as it allows their decision making to take into account the ever-increasing numbers of technologies to manage the variety of energy, water, and waste resources (with many more still under development). 

The results themselves provide an interesting area of discussion, with the design-case scenarios showing the sensitivity of the design to objective functions, especially with respect to the schedule of resource outputs, and process mix. The SPC therefore need to be clear on their design objectives when applying PRaQ.

In addition to the black-box metrics and inspection of the process mix, the SPC should can get insight from the grey-box metrics. The exergy analysis reveals how well resources are deployed among the system, and how efficient the system is as a whole (by providing a single-metric, $\eta_{ex}$ under which energy, water, and waste efficiency can be quantified). The ENA will reveal how much interdependency the designed systems contain, and hence the degree to which management sectors need to work together to take advantage of the opportunities as well as manage risks. [TODO: add specifics from the case studies in relation to these.]

### Further work

While useful to the SPC planners, as is always the case with modelling, there are some limitations and opportunities to improve the results. Firstly, there are two improvements which can be made to the model's input data. The first concerns the choice of processes to include in the modelling. It maybe possible to rule out some processes as not available or feasible for the SPC and/or to decide that the complex wildcard output as a whole is simply infeasible. On the other hand, the SPC decision makers may know of processes not currently in the library [TODO: better term] which could be included. This both produces more realistic outputs, and speeds up the modelling (if the number of possibilities has been reduced). Once the process availability has been refined, then the process and resource costs can be improved, from their current rough estimates. The SPC planners may like to use RMB costs which take into account local prices, and exchanges rates. 

Having performed PRaQ modelling with improved input data, the next stage could be to start looking into the operational activity of a system. For the sake of exploratory early-stage planning, this case study has aggregated yearly demand to a single per-second value, however, in reality the process operation rates, inputs and outputs will vary throughout the day. As noted in Section [TODO: cross-ref], increasing temporal resolution increases computation time, so this sort of modelling should happen after a technology mix has been choses, such that the technology choice variables can be fixed [TODO: footnote on how GAMS does this]. The simplest way to consider operation is to split demand into two periods, average and peak, though finer resolutions could also be chosen. By taking into account demand variation within a day, it will be possible to more appropriately size the system's conversion processes.

A third type of further work is to alter the objective function used by PRaQ. There are many ways to do this, even under the condition it must be formulated as a linear equation. Examples include incorporating revenue from the selling of exports (e.g. electricity in some of the design cases and wildcard cases) (this would also increase exergy efficiency as waste exergies from process $p$, $Ex_p^{waste}$, come to be defined as useful products, $Ex_p^{prod}$. Other alterations to the objective could be to include environmental taxes on carbon dioxide emissions.

Fourthly, in parallel to the above three improvements, the SPC planners should apply sensitivity analysis to the modelling. In general, this studies the sensitivity of the model's output (e.g. technology choice and aggregate metabolic flows) in response to changes in the input data. This could study the effects of: changing prices on processes and resources; changing demands; and changing objective functions. (This third type has already been seen in this chapter, within the four design-case scenarios.) There are many input parameters whose values can be changed, and modelling results can be due to the interaction of these parameters, thus this should be done using carefully chosen parameters, perhaps at a high level (e.g. an overall change in prices overall, rather than individually changes each process's price).


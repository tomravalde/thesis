# Case study: a Chinese urban development

\begin{tcolorbox}

An early version of the work in this chapter was published as: 
Tom Ravalde, James Keirstead, Integrated Resource Planning for a Chinese Urban Development, \emph{International Symposium for Next Generation Infrastrucutre Conference Proceedings}, doi: \url{http://discovery.ucl.ac.uk/1469209/}.

\end{tcolorbox}

[TODO: complete] 

[TODO: Add note on published aspects of this work (e.g. conference paper)?]

```{r Setup, include=FALSE, results="hide", warning=FALSE}
library(knitr)
opts_chunk$set(fig.path = "figures/", dev=c("cairo_pdf"), fig.pos='htbp', fig.width=5, fig.height=3.5, dpi=700, fig.show='hold', fig.lp="fig:", cache=FALSE, par=TRUE, echo=FALSE, results="hide", message=FALSE, warning=FALSE)

library(extrafont)
font_import(pattern="LinBiolinum")

library(ggplot2)
```
<!--
Sections in JK's MILP paper

# Case study

- proposed eco-town development (ambitions)
- site characteristics
- zonal demands
- timings
- figrues with data

## Resources and technologies
## Objective function
## Results
-->


This thesis has argued for the need for an optimisation model which can help plan urban energy, water and waste infrastructure, in combination, with a view to improving the urban metabolism of an area. To that end, the previous chapter introduced the PRaQ model -- a MILP formulation that is generic enough to incorporate multiple resource types, user-friendly to construct, and can be solved without excessive computational effort. The computational implementation of the model is structured to separate code and data, for further ease of use. This chapter now applies this model to a case study, using the library of resource management processes assembled in Chapter 4, and using the metrics of Chapter 3 to assess the systems designed by the model.

This chapter first introduces the case study (Section [TODO:]), before adapting information from the documentation, to construct the model (for example identifying zones, interzonal links, and resource demands) (Section [TODO:]). Following this, Section [TODO: subsection number] introduces several scenarios to which PRaQ is applied. These scenarios will all use the same demand patterns specified in the SPC documentation, but vary in their objectives, and the set of processes available to manage resources. This will allow investigation of both currently proposed system designs, as well as other more ambitious ideas. Finally, this model will present and discuss the modelling results, and thus provide insight to planners and decision makers developing SCP site plans further (Section [TODO:]).

The case study is an ongoing Chinese urban development. The development is led by the Xi'an Shann Gu Power Company (SPC), who historically have provided turbo-machinary services (such as steam turbines, fans and energy recovery units) for the chemical industry, power generation, construction, and other sectors requiring heavy machinery [TODO: cite http://www.shaangu.com/ENGLISH/About.jsp?urltype=tree.TreeTempUrl&wbtreeid=1071]. The SPC are currently implementing plans to redevelop one of their industrial sites and the surrounding region. The wider site is in the Xi'an province of China with an area of 51.03 km$^2$, which includes a short-term construction region of 13 km$^2$ which can accommodates 133,000 people. This short-term construction area has residential, commercial, industrial and recreational functions, roughly represented by Figure \ref{fig:site} [^confidential]. The homes, businesses and industrial functions will all have needs to manage energy, water and waste. Another specific need of interest is in the recreational area, which includes an artifical lake, which the planners hope to source via a water reuse project [SCP-water].

[^confidential]:The documentation regarding the SPC redevelopment plans is confidential and thus certain information (such as the precise site location) cannot be given here. There are six SPC documents (reports and PowerPoint presentations) from which this chapter draws information. In this thesis, these will be cited as 'SCP [X]', where X refers to one of the six papers, namely: 'energy' (details on energy needs and provision), 'water' (details on water needs and provision), 'sewage' (details on wastewater management needs and provision), 'intro' (general details about the SPC site redevelopment), 'site' (specific details about the site), 'demand' (demand data).

\begin{figure}
	\centering
	\begin{spacing}{1.0}
	\sffamily
	\resizebox{0.5\columnwidth}{!}{\input{06_case-study/site.pdf_tex}}
	\end{spacing}
	\caption{A stylized representation of the SCP redevelopment site, adapted from a figure in the SCP documentation. The outer dashed rectangle encloses the full 13 km$^2$ site; the solid rectangles and their bold text labels represent broad regions within the site (e.g. region nine is \textbf{residential}; the unbolded text labels denote zones more specifically (e.g. a hospital within the residential region).}
	\label{fig:site}
\end{figure}

One stated ambition of the SCP site redevelopment is to integrate the energy, water and waste management services in order to maximise energy efficiency, minimise the discharge of waste, and minimise economic costs. Current plans to that end include using heat held within wastewater within a water source sewage pump, and generating biogas from wastewater fermentation. These, and other intersectoral integration possibilities [TODO: better word?] are summarised in Figure [TODO:], which shows part of the resource management infrastructure proposed for the SPC site, indicating the type of intersectoral integration considered by the planners and decision makers involved with the SPC site redevelopment project.

[TODO: adapt Figure below, to show all connections.]

\begin{figure}
	\centering
	\begin{spacing}{1.0}
	\sffamily
	\resizebox{0.5\columnwidth}{!}{\input{06_case-study/site-dimensions.pdf_tex}}
	\end{spacing}
	\caption{A re-representation of the SCP redevelopment site, indicating connections defined for set $nb(z,z')$. All distances are in kilometers. Each region centre connects to the other zones in the region (e.g. \textbf{Factory (south)} $\leftrightarrow$ Assembly) with a connection assumed to be 0.5 km in length.}
	\label{fig:site-connectionss}
\end{figure}

Some proposed system design have been simulated (for example using the TRNSYS[^trnsys] to simulate the energy, system), however this does not include detailed consideration of the water and waste systems. Furthermore, the system design has not been subjected to optimisation modelling. Thus, this case study presents an opportunity to (i) model water and waste systems, alongside the energy system; (ii) to go beyond simulations by applying optimisation modelling; and (iii) to consider not just the current proposed system designs, but also those made possible when the database of Chapter 4 is considered.

[^trnsys]: \url{http://sel.me.wisc.edu/trnsys/index.html}. This program allows users to lay out the components of an energy system (drawn from a library of thermal and electrical energy components), linking them together in a modular fashion, in order to simulate the behaviour of an overall energy system.


Like with the benchmark study (Chapter 5), architecture of the code separates the data and formulation. Everything required to run each scenario is available online, along with the results of the modelling [TODO: provide GitHub link].

<!--
- [SCP-4, slide 17: water, waste and energy jigsawed together]
- [SCP-4, slide 19: Energy island with CHP, CCHP and sewage source heatpump 
- [SCP-4, slide 21: Energy island]
- [SCP-4, slide 22: Energy provision via CHP, CCHP and sewage source heatpump, (as well as traditional and renewable approaches)]
- [SCP-4, slide 25: "Increase energy supply efficiency", "decrease discharge cost" and influence "by cycle reuse", in order to save energy, give social benefits, and economic efficiency]
- [SCP-4, slide 26: Energy island logic diagram, incorporating sewage treatment, water reuse, solid waste treatment, cooling/heating, and solar-PV power]
- [SCP-4, slide 27: Within that, the "Combined water supply and treatment system" has WSHP, rainwater collection, fermentation to produce biogas, sewage plant, water treatment, and water reclamation]
-->

## Model data
<!--
- Data
  	- resources
  		- generic
  		- specific, due to the site, e.g. exergy of heat
  	- processes
  		- generic, from the database
	  	- specfic, due to the site, e.g. rain, leachate = f(rain, evaporation, landfill area)
		- real processes, heat exchangers (and associated water flows)
		- dummy processes (e.g. MSW splitting, waste generalising)
-->

When applying the model to a case study, the first step is to specify the zones and time steps [TODO: better word? slices?] used in the model, which are indexed by $z$ and $t$, respectively. With the zones determined, another a set specifies whether any pair of zones $(z,z')$ are neighbours, defined as any pair of zones which exist in the $nb(z,z')$ set. Following this, the sets of processes and resources available to the model can be specified, indexed by set $p$ and $r$, respectively. Once the resources have been specified, there is enough information to define the two final sets: first, quality attributes which should be defined (specified by a set indexed by $q$); and second, the transport technologies which can transport the resources between zones (indexed by $\tau$).

With the sets specified, their related parameters can be defined. First the distance between between two any two neighbouring zones defines the $l_{zz'}$ parameter (km), while the $span_t$ parameter defines the length of time (days) of each time step lasts. The resource demands can then be specified for each time and location with the $D^{(qty}_{rzt})$ parameter. (As mentioned in Chapter 5, the model code is built so that it will automatically define the $D^{(qual)}_{qzt}$ parameter.) Other parameters will include the limits on imports and exporting resources to particular zones, and the costs of resources and processes [TODO: TBC].

This section gives the key particulars on how the sets and parameters above are defined from the SPC documentation, with further details provided in Appendix [TODO: cross-ref]. The explanations are deliberately comprehensive, reflecting on why certain decisions and assumptions regarding data are made, with the intention of justifying modelling decisions taken here, as well as walking the reader through how one might design a model for a particular case study, and when it would be appropriate to take different decisions. The details are given in the recommended order of how a user might construct a particular case study model, and thus each subsection describes how different components of the formulation (e.g. sets and parameters) relate to each other [TODO: tidy this last part of explanation].

```{r resource-demands, fig.height=5, fig.cap="Resource management demands for the SCP site, according to zone and season. Negative values for (i.e., for wastes and wastewaters) indicate the production of a resource.\\label{fig:site-demands}"}
demands <- read.csv("06_case-study/resource-demands.csv")
demands <- demands[complete.cases(demands$value.conv), ]

#library("dplyr")
#filter(demands, value.conv!=0)

plot_demand <- ggplot(demands, aes(zone, value.conv)) +
#  geom_dotplot(aes(fill=season), binaxis="y", position=position_dodge(width=0.6)) +
  geom_point(aes(colour=season), binaxis="y", position=position_dodge(width=0.6)) +
  facet_wrap(~resource, scales="free_y") +
  xlab("Zone") +
  labs(fill="Season") +
  theme_bw() +
  theme(axis.text.x = element_text(hjust=1, angle=30),
	axis.title.y = element_blank())
plot_demand

```

[TODO: adapt Appendix from supplementary information (shann-gu-case-study/paper/supInf.Rmd)]

### Site layout

Each of the twelve zones shown in Figure \ref{fig:site} (both the three larger regions, and the nine functions they encompass) will be modelled in this case study, and thus each are encoded in the model as zones $z \in Z$, where $|Z|=12$. The parameter which defines site layout is $l_{zz'}$, which specifies the distance between any $z,z'$ pairs belonging to set $nb(z,z')$. All this information for the SPC case study is shown on Figure [TODO:], in which the zones and regions from Figure \ref{fig:site} have been translated into the zones for the model. Note then that in this model, to be a 'neighbour' is not primarily a function of geographical proximity, rather it is one of 'connectedness'.

[TODO: insert a figure which is a zonal representation of the site, marked with interzonal distances.]

Thus to define the site layout, we first assume which pairings belong to set $nb(z,z')$, and then estimate the lengths of these connections. For the SPC site, we will assume that roads are assumed to exist along any connection. Additionally, these connections can optionally include underground pipes and overhead cables, running along the length of the road[^road-cost].

[^road-cost]: As discussed in Section [TODO:], this means that roads have no financial cost in the model, whereas pipes and cables will.

We will assume that the three broader regions will be linked via a connection running north-south through the site. Then we assume that the functions within a particular region are equidistant from the region's centre (with the exception of the energy island which does not belong to a region). This makes the size of set $nb(z,z')$ as $|nb|=12$. With the connections determined, the distances are estimated, based on the site's dimensions. We assume that the region-to-region connections join the regional centroids, thus distances can be measured by scaling distances from the site plans in the SCP documentation. The region-to-function distances will be assumed as [TODO: 0.5] km. In total, there are twelve two-way connections defined, which are given in Table \ref{tab:zonal-connections}.

[TODO: insert a photo of me with a ruler, doing the measurements!]

\begin{table}[]
\centering
\caption{The zonal connections defined for set $nb(z,z')$, and their corresponding lengths $l(z,z')$ used in the SPC case study.}
\label{tab:zonal-connections}

\begin{tabular}{@{}llll@{}}
\toprule
$z$                      & $z'$                     & Dimension on plan {[}cm{]} & Site dimension {[}km{]} \\ \midrule
\textbf{Factory (south)} & \textbf{Factory (north)} & 3.4                        & 0.9                     \\
\textbf{Factory (south)} & Assembly                 & NA                         & 0.5                     \\
\textbf{Factory (south)} & Multifunction district   & NA                         & 0.5                     \\
\textbf{Factory (south)} & Dormitories              & NA                         & 0.5                     \\
\textbf{Factory (south)} & Turbines                 & NA                         & 0.5                     \\
\textbf{Factory (north)} & Technology building      & NA                         & 0.5                     \\
\textbf{Factory (north)} & Quality control          & NA                         & 0.5                     \\
\textbf{Factory (north)} & Energy island            & $4.8+1.3=6.1$              & $1.3+0.4=1.7$           \\
\textbf{Factory (north)} & \textbf{Residential}     & $4.8+3.4=8.2$              & 2.2                     \\
\textbf{Residential}     & School                   & NA                         & 0.5                     \\
\textbf{Residential}     & Hospital                 & NA                         & 0.5                     \\
\textbf{Residential}     & Reserved                 & Assume                     & 1                       \\ \bottomrule
\end{tabular}
\end{table}

The GAMS code for this data is listed in Appendix [TODO:]. 

<!--
Assembly,Factory (south)
Factory (north),Factory
Multifunction district,Factory (north)
Technology building,Factory (north)
Dormitories,Factory (north)
Energy island,Multifunction district
Technology building,Turbines
Quality,factory_blades
school,Residential
school,hospital
school,energyIsland
school,reserved
-->

### Times

The SPC [demand] provides values of energy demands for winter, summer and year round. This model therefore uses three timesteps, specified by $t \in T$, where $|T|=3$, representing the winter, summer, and shoulder seasons. This means that the infrastructure selected by the model would be in place all year round, but could operate differently in each season. Consider the provision of domestic heating provided by district heating as an example: in the winter, the district heating would be delivering heat to homes, and this would have an impact on the operation of heat-generating processes upstream. However, these upstream impacts would not occur in the summer, when district heating does not run. As this phenomenon is applied in relation to other resource demands, the chain of processes emerging from the system interactions could operate differently according to season, in order to optimise the site's metabolism.

Of course, operation might not just vary by season, but could vary for smaller time slices. For example each season could have alternative weekday and weekend resource demand (thus $|T|=3 \mbox{ seasons} \times 2 \mbox{ day types}= 6$), which could further be divided into hourly demands (thus $T=3 \mbox{ seasons} \times 2 \mbox{ day types} \times 24 \mbox{ hours} = 144$). The temporal resolution could become finer still, using minute-by-minute and second-by-second demand patterns. However, the choice of seasonal timesteps has at least three reasons. The pragmatic reason, is that this is how the SPC documentation defines the energy demands. The philosophical [TODO: better word? modelling judgement] reason is that seasonal time slices are appropriate to the exploratory early-stage planning purposes of this model [TODO: cite examples of similar models, e.g. MARKAL etc.] . Finer resolution would be appropriate the further along the design process the modelling is. However, modelling judgement is also the reason why it is inappropriate to aggregate the demand up to a coarser scale (i.e. a year). In such a case, a yearly averaged value of head (to take one example) would overdesign the summer system operation, while undersizing the winter system operation, potentially resulting in a suboptimal system design [TODO: clarify this]. Finally, there is a computational reason. As shown in Chapter 4, if $|T|$ doubles, the number of variables increases by [TODO:], leading to an estimated [TODO: X-fold] increase in computation time. [TODO: note on heirarchical time discretisation, for a more tractable approach, to be explored in future.] These latter two points interact, as the further along the planning process (from explanation to detailed design), it is justifiable to expend more effort (including computational resources), thus a finer temporal resolution may be warranted. Further more, at the more detailed design stages, some decisions will have been made (the location of a particular conversion process, whilst its size remains unknown, for example), thus reducing the number of variables in the model, and thereby making some efficiency savings to the computations.

With this set of times chosen, the length of each timestep is defined as parameter $span(T)$ with the winter, summer, and shoulder seasons having spans of 90 days, 90 days, and 180 days respectively.

### Resource demands

Having determined the seasons and the time steps in the model, it is now possible to define the resource demand parameter $D^{(qty)}_{rzt}$ for each resource $r$. (As mentioned in Chapter 4, the code which constructs a model is designed such that $D^{(qual)}_{rqzt}$ can be defined automatically once $D^{(qty)}_{rzt}$ is known.) The SPC documentation will provides values which can be used in the modelling. However, these values do not necessarily cover all resources $r$, and may not be disaggregated to each zone $z$ and season $t$. Thus, sometimes, assumptions and calculations need to be applied in order to translate a documented value into a set of values which can be used in the modelling. The details of these adjustments are provided in Appendix [TODO:].

The resource demands used in the SPC model are summarised in Figure \ref{fig:site-demands}, showing the seasonal demand for energy (electricity, heating, and cooling), water (potable, and reclaimed), and waste management (wastewater, nonorganic solid waste, and organic solid waste). The precise numeric values used in the model are provided in Appendix [TODO:]. 

Resource demands are defined as rates, i.e. on a per-second basis (kg/s or MW). This is a common way to express energy quantities, which makes sense given that energy is most commonly demanded on such a basis[^energy-rate]. This makes resource quantities in the model consistent with how the model defines process behaviour, where the process rate is defined on a per-second basis, and thus no adjustment multipliers need to be added into the equations. Thus by using rates, whatever the temporal resolution of a model (see the options discussed in Section [TODO:], above), the formulation need not substantially change[^rates-objective].

[^energy-rate]: This is in contrast to waste management services (to give one example) in which waste may be collected at regular intervals (e.g. weekly), and set to a particular processing unit once a certain threshold (e.g. tons) has been met. Nevertheless, for usability, there should be consistency between the definition of energy and mass quantities. One way to capture the non-rate properties of many material-based processes (and indeed, some energy-based processes, such as [TODO:]) would be to introduce storage processes into the model. This may be the subject of future developments, as discussed in Section [TODO:]. 

[^rates-objective]: The objective function formulation may need to consider the temporal resolution of the model. For example, if the objective function calculates system costs over a year, then an appropriate multiplication factor will need to be applied to each time period. This can by achieved with the appropriate definitions of the $span(t)$ parameter.

### Other resources

The resource demands discussed above will define some of the $r$ items in set $R$, but to complete this set requires the resources which used in the network of conversion processes to meet demand. In total, there are [TODO: 63?] resources, including everything from algae to wood.

Each resources has at least one associated quality $q$ (belonging to set $Q$), and attributed to the resource using the $X_{rq}$ and $\delta^R_{rq}$ parameters. The qualities used in this case study are *mass* and *energy*. Most resources are only attributed with one of these (e.g. algae possesses mass, and heat possesses energy), though some resources are attributed with both mass and energy (e.g. ground water). The full list of resources and their associated qualities can be found in Appendix [TODO:].

Costs are also associated with resources for use in the objective function. These are based on [TODO:], and are given in Table [TODO:]. 

With the resources, zones and times determined (indixed by $r$, $z$, $t$, respectively), the parameters which impose limits on how many zones can import and export particular resources ($N^I_r$, $N^E_r$), and the maximum allowable imports of a resource in a season ($I^{max}_{rt}$, $E^{max}_{rt}$) can be specified. These values are shown in Table [TODO:], below. 

[TODO: insert table of resource/zone import constraints. Many are the same, so only need to include the exceptions.]

### Conversion processes

The resource conversion processes used in the model will be taken from the open-source database of urban metabolism processes outlined in @Ravalde2015b[^process-data], or the Shann Gu documentation. Each process definition also includes its capacity (i.e. the maximum MJ/s or kg/s which can be converted). This database provides the values to define process behaviour data (namely the coefficients which define the input and output resource quantities with $k_{pr}$, and maximum process rates $F^{max}_p$). The size of the process set $P$ will vary for each scenario (with are detailed in Section [TODO:] below).

In addition to these parameters, each process needs to have a cost for use in the objective function [TODO:]. We attempt to estimate process costs here, but note the difficulties in doing this. Aside from the shear number of processes in the database ([TODO: N] in total), several factors make this tricky. First and foremost, the process database includes future processes which have not yet penetrated into the market, thus there is no values to be used. Secondly, currency exchange rates and purchasing power parities around the world make it difficult to attribute a cost to a process with any degree of certainty. For this reason, our costing is approximate.

The broad approach to estimating process costs is to assemble a database of 'process types' ($PT$), with each $PT$ forming [TODO: better word] a category to which processes from the database -- 'database processes' ($DP$) -- are assigned. As an example, *'biogas-fuelled CHP'* is defined as a $PT$, which includes [TODO: find data, and list examples]. For each $PT$, unit costs (USD/MW or USD/kg/s) is obtained from the literature (this may require some assumptions and adjustments to numbers from the literature, of which details are given in Appendix [TODO:]). One guiding principle of the process cost estimation are that economies of scale should be applied[^scale-economy]. For this to be captured in the model, each $PT$ has both lowerbound and upperbound unit costs, obtained from the literature (and adjusted according to necessary assumptions). Thus, the total cost (USD) of any particular $DP$ with a given capacity (MW or kgs/s) can be calculated from:

[^scale-economy]: For example, if a system demand requires 10 MW, then it should be cheaper to meet that demand with two 5 MW plants than 10 1 MW plants, of the same type.

$$
\begin{align}
\mbox{DP Total Cost} = \mbox{PT Unit Cost}^* \times \mbox{DP capacity},
\end{align}
$$

where $^*$ is wildcard notion to indicate either a lowerbound or an upperbound cost ($Cost^{LB}$ and $Cost^{UB}$, respectively). In this way, lowerbound costs are applied to larger instances of a process, and the latter applied to a smaller instance.

This method estimates costs for conversion processes which do not yet exist in the market by For processes which do not yet exist by assigning these $DP$s [TODO: e.g. <example>], to a $PC$ which has a similar main resource in its conversion (either as a main input output)[^main]. This method is broadly conservative in its approach, on the assumption that new processes will not penetrate the market unless they deliver a particular service at lower cost than a more traditional means of conversion[^cost-estimation].

[^main]: Recall from Chapter [TODO: chapter and section reference] the idea of a 'main' resource being the (e.g. electricity output for a powerplant, or wastewater input to a treatment facility), and always has a value of $k_{pr}=\pm 1$.

[^cost-estimation]: Though this may be countered by the fact that a novel process may be more expensive than older methods due to other benefits (e.g environmental benefits). However, this thesis can only hope to be approximate with the cost of conversion processes, and indeed, such estimations warrant their own separate research focus [TODO: https://www.rand.org/content/dam/rand/pubs/reports/2006/R2481.pdf, https://core.ac.uk/download/files/23/140606.pdf].

In summary, the database assembled in Chapter [TODO:] will provide the conversion processes which can be considered in the SPC case study (using various subsets according to different modelling scenarios, as outlined in Section [TODO:] below, defining model parameters $k_{prq}$ and $F^{max}_p$. Added to these processes have been estimated costs (defining model parameters $c^P_p$), which enable to model to take account of economies of scale, and the cost of processes which do not yet exist. The result is that the SPC modelling has up to [TODO:] conversion processes from which to design an integrated resource management system, for which a rough cost can be obtained. 

### Transport processes

The selection of transport processes to define set [TODO: design a symbol which isn't T for this]  for the SPC case study are based on the resources being considered, many of which can be transported between zones via various infrastructure (with some exceptions such as heat[^heat-transport]). To transport these resources, there are three types of transport infrastucuture: roads, alongwhich vehicles can transport everything from municipal solid waste, to gases and liquids carried by tankers; pipes, which transport water and gases; and cables, to carry electricity. As explained in the Section [TODO:], the roads are assumed to already exist to connect neighbouring zones ($nb(z,z')$), whilst underground pipes and overhead cables can be optionally added by the optimisation model, if and where necessary.

[^heat-transport]: Though whilst heat itself cannot be transported, it can be carried by water, e.g. in a district heating network.

Regarding the behaviour of transport processes, the origin-to-destination input and output coefficients, $k^*_{\tau rq}$ should obviously include the resource carried (e.g. water through a pipe). In addition to this, transport processes may need 'auxilliary' resources, namely the source of the energy used to carry that resource along the length of a connection (e.g. electrical energy to pump water along a pipe), as well as any by-products, wastes, and emissions from the process. While it is taken for granted that the carried resource entirely leaves to origin zone, and arrives in the destination zone (perhaps less some losses, such as electrical losses along a cable), it needs to be determined how wastes, by-products and emissions are shared between zones. The details on transport process behaviour for the three main types of technologies considerations are now described, with specific values of $k^*_{\tau rq}$ given in Table \ref{tab:transp-coeffs}. 

\begin{description}

\item[Cable] This is the simplest transport process type since the resource carried, and the resource which provides the carrying energy are one and the same, namely electricity, thus only a single $r$ value is necessary here. Electrical cables do incurr losses of between 3--7\% over 1,000 km distances [TODO: cite \url{http://iea-etsap.org/web/Highlights%20PDF/E12_el-t&d_KV_Apr2014_GSOK%201.pdf}], however, given the interzonal distances for the SPC site are all under [TODO: N] km, losses are considered negligable. Thus cables can be defined simply with $k^{\alpha}_{\tau rq}=1$, $k^{\alpha'}_{\tau rq}=-1$, and $k^{\beta}_{\tau rq}=0$, when $\tau=\mbox{cable}$ and $r=\mbox{elec.}$ [TODO: tidy].

\item[pipes] These carry a resource (e.g. $r=\mbox{water}$) as well as pumping energy. As hydraulic calculations given in Appendix [TODO:] show, for water in a pipe of no slope, this can be roughly calculated as approximately $0.0054l_{zz'}$ to overcome friction between the water and the pipe, on the assumption that the volume flowrate is around $1 m^3/s$\footnote{At this value, the nonlinearities in the relationship between transport mass and volume can be ignored [TODO: better phrasing?]}. It is assumed that all this electricity is provided in the zone of the water's origin, thus [TODO: summarise $k$ values] . For gases it is assumed that friction is lower enough so as to make the energy requirements negligable for the distances in the SPC site.

\item[vehicles] Other resources are carried by vehicles along the road network. As well as the carried resource (e.g. $r=\mbox{biomass}$. The source of carrier energy is $r=\mbox{gasoline}$, which is provided entirely by the source zone. As well as this, \CO2 emissions are emitted, with these being shared equally between the origin and destination zones. Calculations in Appendix [TODO:] derive $k$ values as [TODO: complete].

\end{description}

\input{06_case-study/tab-transp-coeffs.tex}

For process rates, $F^{transp}_{\tau zzt}$, [TODO: complete] 

As with the conversion processes, transport processes each need to have an associated cost, $c^T_{\tau}$. As the roads already exist, these are not costed in our model, as they would have the same cost, whatever the system designed by the model. The cost for the pipes and roads are defined per kilometer, and the values and sources for these calculations are provided in Appendix [TODO:] .

[TODO: clarify if it's possible for the model to charge per vehicle, for the road transport infrastructure]

### Summary

This section has provided the data used to define the model's parameters while showing how various parts of the model relate to each other, and in doing-so has provided a guide on how one might construct the PRaQ model for a particular case study. 

Now, this chapter turns to outline the [TODO: N] scenarios that our model will test. 

## Application to model scenarios

We study [TODO: number] scenarios using different subsets of the processes, to suggest how different networks of processes can satisfy demand under varying circumstances (following the methodology of @Keirstead2012). For some scenarios, we model sub-scenarios, where we use different objective functions, or introduce an additional constraint to illustrate Pareto optimality. The scenarios are:

1. *Base case.* This assumes that electricity, fuels and water are imported to the site as needed (with wastewater treated on site), thus there is no attempt to take advantage of synergies. As such, this scenario provides baseline results.
2. *Design case.* The Shann Gu site developers intend to take advantage of intersectoral synergies to minimise resource consumption. This scenario considers the processes suggested in the Shann Gu documentation, including combined heat and power (CHP), a wastewater source heatpump combined with a district heating network. We consider how the process choice changes, with different objecitves:
	a. Minimise cost
	b. Minimise emissions
	c. Minimise waste
	d. Minimise freshwater consumption
3. *Wildcard case.* This scenario allows any process from the database compiled by @Ravalde2016 to be incorporated into the site's resource management network. This database includes both existing and still-to-be-implemented management processes, so we consider the following sub-scenarios, at minimum cost:
   	a. Currently available processes
   	b. Medium-term available technologies
   	c. Long-term available technologies

Scenario 3a [TODO: update if necessary] is the largest, and thus indicates the computational effort required to solve the problems, having [TODO: number] single variables, [TODO: number] discrete variables, [TODO: number] binary variables, [TODO: number] equations [TODO: etc.].

These scenarios are fairly simple, and illustrate the sensitivity of a network to fairly broad considerations (technology availability, and simple objective functions). Detailed design problems should be more narrowly focussed, by applying sensitivity analysis to understand how a system design responds to changes in efficiency (reducing demand), market value of imported and exported goods, and other factors. [TODO: reproduce Saltelli et al. citation from @Keirstead2012??].
<!--
OTHER SCENARIO VARIATIONS
- DSM
- min-cost
- min emissions
- cost/emissions pareto
- export revenue (e.g. hydrogen economy)
- Exergy verses other objectives (cost, carbon footprint, water footprint, waste output)
- min cost -- DSM
- min cost -- phased planning
- min water
- min landfill
- min cost/targets of individual sectors (energy, water, waste), or differently weight them?
-->

Each scenario is run by GAMS, which outputs the results into a set of CSV files, which are then analysed and plotted using R. The following subsections visualise and describe the results, before the next section discusses their relevance in view of this chapter's aims. With some systems so large (over [TODO: number]) process types, space limitations prevent us from display all information of interest (e.g. the quantity of any particular technology). However however, the Supplementary Information includes all results in CSV format.

```{r headlines, fig.height=5, fig.cap="fig:headlines", results="asis"}

headlines <- read.csv("06_case-study/headlines.csv")

## Presentation scenario names
headlines$scenario <- as.character(headlines$scenario)
headlines[headlines$scenario=="gridCase_minCost", "scenario"] <- "Grid case (min. cost)"
headlines[headlines$scenario=="designCase_minCost", "scenario"] <- "Design case (min. cost)"
headlines[headlines$scenario=="designCase_minEmissions", "scenario"] <- "Design case (min. emissions)"
headlines[headlines$scenario=="designCase_minWaste", "scenario"] <- "Design case (min. waste)"
headlines[headlines$scenario=="designCase_minWater", "scenario"] <- "Design case (min. water)"
headlines[headlines$scenario=="wildcard_current_minCost", "scenario"] <- "Wildcard case (current)"
headlines[headlines$scenario=="wildcard_medium_minCost", "scenario"] <- "Wildcard case (medium)"
headlines[headlines$scenario=="wildcard_long_minCost", "scenario"] <- "Wildcard case (long)"

## Order the scenario names
headlines <- transform(headlines,
		 scenario=factor(scenario,
		   levels=c("Grid case (min. cost)",
			    "Design case (min. cost)", 
			    "Design case (min. emissions)", 
			    "Design case (min. waste)", 
			    "Design case (min. water)", 
			    "Wildcard case (current)", 
			    "Wildcard case (medium)", 
			    "Wildcard case (long)"),
		    ordered=TRUE))

```

### Metabolic flows and system designs

The first results of interest to this thesis are the SPC site's aggregate metabolic inputs and outputs, and the mix of processes selected by PRaQ which result in their flows. These results begin to answer this thesis' interest in the link between a system's 'middle', and the overall metabolic flows into and out of a system. These results are presented and discussed generally, before scenarios are considered on an individual basis, and in comparison to each other.

Metabolic inputs and outputs for each scenario are displayed in Figure \ref{fig:metabolic-flows}. Note that in general, the more processes available to the system, the more diverse the schedule of resource inputs and outputs [TODO: could put numbers here, perhaps tabulate: scenario, inputs, outputs, total]. Note also that there can be seasonal variation for a single resource type, such as for electricity output in the design case.

```{r metabolic_flows, fig.height=7, fig.cap="fig:Metabolic flows into and out of the SPC site.\\label{fig:metabolic-flows}", fig.width=6.5, results="asis"}

## Another arbitrary edit

metabolic_flows <- read.csv("06_case-study/metabolic_flows.csv")

## Reshape imports and exports into the same column
metabolic_flows <- melt(metabolic_flows, variable.name="Flow")

## Remove zero-valued entries
metabolic_flows <- filter(metabolic_flows, value!=0)


## Order the scenario names
metabolic_flows <- transform(metabolic_flows,
		 scenario=factor(scenario,
		   levels=c("Grid case (min. cost)",
			    "Design case (min. cost)", 
			    "Design case (min. emissions)", 
			    "Design case (min. waste)", 
			    "Design case (min. water)", 
			    "Wildcard case (current)", 
			    "Wildcard case (medium)", 
			    "Wildcard case (long)"),
		    ordered=TRUE))

## Rename the flows
metabolic_flows$Flow <- as.character(metabolic_flows$Flow)
metabolic_flows[metabolic_flows$Flow=="imports", "Flow"] <- "Inputs"
metabolic_flows[metabolic_flows$Flow=="exports", "Flow"] <- "Outputs"

## TODO: RENAME AND REORDER THE RESOURCES

plot_metabolic_flows <- ggplot(metabolic_flows, aes(resource, scenario)) +
  geom_point(aes(colour=season, size=value), position=position_dodge(width=0.6)) +
  facet_wrap(~Flow, ncol=1) +
  theme_bw() +
  theme(axis.text.x=element_text(hjust=1, angle=30),
	axis.title=element_blank())
plot_metabolic_flows

### Give exports a negative value
#metabolic_flows[metabolic_flows$Flow=="exports", "value"] <- -1 * metabolic_flows[metabolic_flows$Flow=="exports", "value"]

#plot_metabolic_flows <- ggplot(metabolic_flows, aes(resource, value)) +
#  geom_point(aes(colour=season), position=position_dodge(width=0.6), stat="identity") +
#  facet_wrap(~scenario, ncol=1) +
#  theme_bw() +
#  theme(axis.text.x=element_text(hjust=1, angle=30),
#	axis.title=element_blank())
#plot_metabolic_flows

```
<!--
```{r process_mix, fig.height=7, fig.width=6.5, results="asis"}

process_mix <- read.csv("06_case-study/process_mix.csv")

## Remove zero-valued entries
process_mix <- filter(process_mix, rate!=0)

## Calculate total capacity (rate * number)

process_mix$total_capacity <- process_mix$rate * process_mix$number

## Order the scenario names
process_mix <- transform(process_mix,
		 scenario=factor(scenario,
		   levels=c("Grid case (min. cost)",
			    "Design case (min. cost)", 
			    "Design case (min. emissions)", 
			    "Design case (min. waste)", 
			    "Design case (min. water)", 
			    "Wildcard case (current)", 
			    "Wildcard case (medium)", 
			    "Wildcard case (long)"),
		    ordered=TRUE))



plot_process_mix <- ggplot(process_mix, aes(zone, process)) +
  geom_tile(fill="white", colour="black") +
  geom_text(aes(label=paste("R=", rate, "\n", "N=", number)), size=2) +
  facet_wrap(~scenario, ncol=3) +
  theme_bw() +
  theme(axis.text.x=element_text(hjust=1, angle=30),
	axis.title=element_blank())
plot_process_mix

```
-->

The network of processes for each scenario are visualised in Figures \ref{fig:designCase_minCost} to \ref{fig:wildcard_long}. These are SNA-style node-link graphs (undirected) in which processes which transfer resources one to another are joined by lines. The proximity of any pair of linked processes is proportional to the quantities of resources transferred. From this, it follows that the more central a process is to the plot, the more its integrated into the network because it tends to be linked to more other processes. Conversely, the closer a process is to the fringe of a plot, the less other processes dependent on this. The processes have been coloured according to the management sector to which they belong[^sna-process-type]; this helps visualise the intersectoral interactions and synergies. Inputs, outputs and demands are also represented; thus if an imported resource is used in any particular process, then there will be a line connecting imports and said process (likewise for exports).

[^sna-process-type]: This is determined by the 'main' output of each process, as discussed in Section [TODO: cross-ref Chapter 4].

Note that for all scenarios, energy conversion processes are dominant, but there is nevertheless interactions and synergies between processes within and across sectors. Note also that in general, that the more processes available to a scenario, the more that tend to be used [TODO: quantify any proportionality here].

networks have cost (10), emissions (8), waste (12), and water (12) processes respectively, and all have the following eight management processes common to them:

	- AD
	- WWTP
	- WTP
	- CHP
	- GSHP
	- HVAC (cooling)
	- Heat ex. (col)
	- Absorp. chill

In addition to the common processes:

- min cost

	- HVAC heating
	- Absorp. (heat)

- emissions -- no extra, i.e. the common eight

- waste and water:

  	- boiler
  	- WSHP
  	- HVAC heating
	- Absorp heat


\begin{figure}[h!]
	\centering
	\includegraphics[width=0.75\textwidth]{06_case-study/SNA_designCase_minCost.pdf} 
	\caption{Process network for the Design case (minimum cost) scenario.} \label{fig:designCase_minCost}
\end{figure}

\begin{figure}[h!]
	\centering
	\includegraphics[width=0.75\textwidth]{06_case-study/SNA_designCase_minEmissions.pdf} 
	\caption{Process network for the Design case (minimum emissions) scenario.} \label{fig:designCase_minEmissions}
\end{figure}

\begin{figure}[h!]
	\centering
	\includegraphics[width=0.75\textwidth]{06_case-study/SNA_designCase_minWaste.pdf} 
	\caption{Process network for the Design case (minimum waste) scenario.} \label{fig:designCase_minWaste}
\end{figure}

\begin{figure}[h!]
	\centering
	\includegraphics[width=0.75\textwidth]{06_case-study/SNA_designCase_minWater.pdf} 
	\caption{Process network for the Design case (minimum water) scenario.} \label{fig:designCase_minWater}
\end{figure}

\begin{figure}[h!]
	\centering
	\includegraphics[width=0.75\textwidth]{06_case-study/SNA_wildcard_current_minCost.pdf} 
	\caption{Process network for the Wildcard case (current) scenario.} \label{fig:wildcard_current}
\end{figure}

\begin{figure}[h!]
	\centering
	\includegraphics[width=0.75\textwidth]{06_case-study/SNA_wildcard_medium_minCost.pdf} 
	\caption{Process network for the Wildcard case (medium) scenario.} \label{fig:wildcard_medium}
\end{figure}

\begin{figure}[h!]
	\centering
	\includegraphics[width=0.75\textwidth]{06_case-study/SNA_wildcard_long_minCost.pdf} 
	\caption{Process network for the Wildcard case (long) scenario.} \label{fig:wildcard_long}
\end{figure}

- For the design case scenarios, integration is lacking for the minimum cost case -- imports tend to go straight to end-use (e.g. electricity, natural gas, and water). But for the other cases, i.e. where an objective is applied to a *resource*, integration does happen
- Design case (minimum emissions): does not find synergies, so much, but rather shows how processes can be connected in a chain
- Design case scenarios: majority of integration is within the energy sector (as expected, according to the SPC energy island strategy), though some is intersectoral (e.g. anaerobic digestion producing gas for use in the boilers)
- There is genuine sensitivity to the objective: i.e. the AD/boiler synergies does not exist int the minimum water design case scenario (though the energy island does work well).  When different objectives are applied to the same technology choice (e.g. 2a and 2b [TODO: update if necessary]), we observe the sensitivity of the technology mix in the network [TODO: can this be quantified by some metric?].
- The wildcard scenarios take advantage of the availability of more processes, showing that systems take advantage of the full range of available conversion processes, with more being used to minimise the objective as much as possible.
- Broadly, the networks are based around distributed energy systems with a diverse range of technologies, it's energy processes dominate the wildcard network, both in terms of presence, and in their own synergies. Nevertheless, there are still intersectoral links [TODO: provide examples] 

[TODO: comment on the mix of technology sizes in various scenarios.]
[TODO: comment on which technogies are most relied upon in each system.]
[TODO: comment on transportation reliance (e.g. central import + distribution, or central import and conversion, etc.?]
[TODO: comment on coversion/transportation mix effect on (capital) costs?]

Design case (all)




- Only minor differences in the imports schedule (e.g. no summer import of electricity in the min waste scenario, due to 
  Also note an excess use of AD, hence exports of natural gas

Note that minimum waste and minimum water design the same system (though operated slightly differently, as evidenced by the exports of potable water and excess natural gas (from AD) in the minimum waste scenario.

- differences in the amount of imported natural gas between minimum waste/minimum emissions

Design case (min cost)

- Only water wastes, so no exergy waste
- Lower import requirements that Grid case (slightly lower elec, and gas, and much lower summer elec, due to absorption cooling, rather than electrically-powered HVAC). Different set of water imports (not actually affecting exergy flows)

Design case (min emissions)

Avoids CO2 emitting processes (NOTE not CO2 from CHP!!)

General observations:

- Results would suggest that optimising for some objectives may not result in the most efficient system, as defined by exergy
- Exergy wastes could be considered products rather than wastes if they were sold (e.g. the large electricity and heating exports from the design case). Hence the in efficiency of these cases.
- Should focus on non-water exports or selling other exports to increase exergy efficiency
- While water itself has negligable effects on exergy, the type of water imported may have indirect exergy impacts, due to treatment processes, etc.


### System costs

System cost is calculated as the sum of the processes (conversion and transport) and resource imports. These costs are calculated on an annual basis, assuming infrastructure has a ten year lifespan. This can be done using Equation \ref{eq:objective_cost}, $C = \gamma^R C^R + \gamma^P C^P + \gamma^{\tau} C^{\tau}$ with $\gamma^*$ taking values of 1, 0.1, and 0.1, respectively. Figure \ref{fig:system-costs} displays the system cost for those scenarios whose objective is to minimise cost (1, 2a, and 3a-c).

```{r costs, fig.height=5, fig.cap="fig:costs", results="asis"}

## Presentation costs
headlines$metrics <- as.character(headlines$metrics)
headlines[headlines$metrics=="headline_cost", "metrics"] <- "Cost [USD/year]"
headlines[headlines$metrics=="headline_emissions", "metrics"] <- "Emissions [million tons/year]"
headlines[headlines$metrics=="headline_waste", "metrics"] <- "Waste [million tons/year]"
headlines[headlines$metrics=="headline_water", "metrics"] <- "Water [million tons/year]"
system_costs <- filter(headlines, scenario %in% c("Grid case (min. cost)",
						  "Design case (min. cost)",
						  "Wildcard case (current)",
						  "Wildcard case (medium)",
						  "Wildcard case (long)"))

system_costs <- filter(system_costs, metrics=="Cost [USD/year]")

system_costs <- mutate(system_costs, values=values/1e6)

#plot_system_costs <- ggplot(system_costs, aes(scenario, values)) +
#  geom_point() +
#  xlab("Scenario") +
#  ylab("Annualised cost [millions USD]") +
#  theme_bw() +
#  theme(axis.text.x = element_text(hjust=1, angle=30))
#plot_system_costs
```

```{r component-costs, fig.height=5, fig.cap="System costs for scenarios where the objective function was to minimise cost.\\label{fig:system-costs}", results="asis"}
component_costs <- read.csv("06_case-study/component-costs.csv")
component_costs <- melt(component_costs, variable.name="Component")

## Presentation system component names
component_costs$"Component" <- as.character(component_costs$"Component")
component_costs[component_costs$"Component"=="Conversion.processes", "Component"] <- "Conversion processes"
component_costs[component_costs$"Component"=="Transport.processes", "Component"] <- "Transport processes"

## Presentation scenario names
component_costs$Scenario <- as.character(component_costs$Scenario)
component_costs[component_costs$Scenario=="gridCase_minCost", "Scenario"] <- "Grid case (min. cost)"
component_costs[component_costs$Scenario=="designCase_minCost", "Scenario"] <- "Design case (min. cost)"
component_costs[component_costs$Scenario=="designCase_minEmissions", "Scenario"] <- "Design case (min. emissions)"
component_costs[component_costs$Scenario=="designCase_minWaste", "Scenario"] <- "Design case (min. waste)"
component_costs[component_costs$Scenario=="designCase_minWater", "Scenario"] <- "Design case (min. water)"
component_costs[component_costs$Scenario=="wildcard_current_minCost", "Scenario"] <- "Wildcard case (current)"
component_costs[component_costs$Scenario=="wildcard_medium_minCost", "Scenario"] <- "Wildcard case (medium)"
component_costs[component_costs$Scenario=="wildcard_long_minCost", "Scenario"] <- "Wildcard case (long)"

## Order the scenario names
component_costs <- transform(component_costs,
		 Scenario=factor(Scenario,
		   levels=c("Grid case (min. cost)",
			    "Design case (min. cost)", 
			    "Design case (min. emissions)", 
			    "Design case (min. waste)", 
			    "Design case (min. water)", 
			    "Wildcard case (current)", 
			    "Wildcard case (medium)", 
			    "Wildcard case (long)"),
		    ordered=TRUE),
		Component=factor(Component,
				levels=c("Conversion processes",
					"Transport processes",
				       "Resources"),
			 ordered=TRUE))	 
			     
component_costs <- filter(component_costs, Scenario %in% c("Grid case (min. cost)",
						  "Design case (min. cost)",
						  "Wildcard case (current)",
						  "Wildcard case (medium)",
						  "Wildcard case (long)"))

plot_component_costs <- ggplot(component_costs, aes(Scenario, value/1e6, fill=Component)) +
  geom_bar(stat="identity") +
  xlab("Scenario") +
  ylab("Annualised cost [millions USD]") +
  theme_bw() +
  theme(axis.text.x = element_text(hjust=1, angle=30))
plot_component_costs
```

Note that the design case is an order of magnitude higher in cost, but increasing the number of processes avaialble brings the process down to the same order as the grid case.

### Other headline results

Emissions, water footprint and waste output are calculated on an annual basis, using the general equation [TODO: write and reference an emissions equation], with the following conditions:

- $r = \mbox{\CO2}$
- $r \in S^{water}$
- $r \in S^{waste}$

(Provide footnotes to define the water and waste sets.)

The headline results are given in Figure \ref{fig:headlines}. The results show:

- That when cost is the minimum objective -- the case for all scenarios with the exception of three of the design cases -- that low costs can indeed be achieved.
- Looking at each of the design cases, they each successfully minimise the quantity of interest to zero, and in fact manage to do while other quantities go to zero.
- However there is an exception to this, which reveals a clear tradeoff: for example, that minimum waste design case results in a large water consumption.
- The wildcard cases improve performance the longer the more processes they consider.
- Second, we consider each system's emissions from the processes (though it is beyond the scope of this study to trace emissions up the supply chain) (Figure [TODO: cross-ref]).

<!--
($\sum_{pz} C^P_p N^P_p + \sum{\tau zz'} C^{\tau}_{\tau} \delta_{\tau zz'} l_zz'$, emissions, waste output and water footprint.
-->

```{r other-headlines, fig.height=5, fig.cap="fig:costs", results="asis"}
headlines <- filter(headlines, metrics!="Cost [USD/year]")

## Just for the design case

headlines <- filter(headlines, scenario %in% c("Design case (min. cost)",
					       "Design case (min. emissions)",
					       "Design case (min. water)",
					       "Design case (min. waste)"))

plot_headlines <- ggplot(headlines, aes(scenario, values/1e9)) +
  geom_point() +
  facet_wrap(~metrics, ncol=1, scales="free_y") +
  theme_bw() +
  theme(axis.text.x = element_text(hjust=1, angle=30))
plot_headlines
```


### Transport infrastructure

Finally, we consider the transport network in each scenario. [TODO: decide which type of plot to include, notate what they show, and highlight points of note.] 

[TODO: plots]

Show that plots reveal more transport connections for the wildcard case.

### Exergy analysis


The [TODO: N] subsections above could be considered black-box metrics. In this section and the next, 

Perform a simplified version of the method outlined in Section [TODO: cite Grey-box metrics subsection of Chapter 3], in which there is no need to distribute the flows between the processes within the city, on the understanding that in the model, any process products unused within other processes will become system outputs (exports), thus exergy analysis can be peformed on a whole-system level on a black-box, with the internal 'grey box' analysis implicit to it:

- $Ex^{prod}$ are any demands (exogenously defined)
- $Ex^{waste}$ are any resources which find themselves amongst the 'outputs' ('exports'), and have thus, not become inputs to any processes before crossing out of the urban boundary

Thus, a simplified way to calculate the exergetic inputs to the SPC site, $\alpha^{in}_{ex}$ is by the following simplification to Equation [TODO:cross-ref Equation (3.5a)]. 

```{r exergy, fig.height=5, fig.cap="fig:exergy", results="asis"}

## Arbitrary edit

library(xtable)
exergy <- read.csv("06_case-study/exergy.csv")

ex_prod <- exergy$prod[1]

## Presentation scenario names
exergy$scenario <- as.character(exergy$scenario)
exergy[exergy$scenario=="gridCase_minCost", "scenario"] <- "Grid case (min. cost)"
exergy[exergy$scenario=="designCase_minCost", "scenario"] <- "Design case (min. cost)"
exergy[exergy$scenario=="designCase_minEmissions", "scenario"] <- "Design case (min. emissions)"
exergy[exergy$scenario=="designCase_minWaste", "scenario"] <- "Design case (min. waste)"
exergy[exergy$scenario=="designCase_minWater", "scenario"] <- "Design case (min. water)"
exergy[exergy$scenario=="wildcard_current_minCost", "scenario"] <- "Wildcard case (current)"
exergy[exergy$scenario=="wildcard_medium_minCost", "scenario"] <- "Wildcard case (medium)"
exergy[exergy$scenario=="wildcard_long_minCost", "scenario"] <- "Wildcard case (long)"

exergy <- select(exergy, scenario, in., waste, irrev, eff)
names(exergy) <- c("Scenario", "$\\alpha^{in}_{ex}$", "$\\alpha^{waste}_{ex}$", "$\\alpha^{irrev}_{ex}$", "$\\eta_{ex}$ [per cent]")

tab.exergy.tex <- xtable(exergy,
			  caption="Results of exergy analysis for SPC scenarios. All $\\alpha^*_{ex}$ values in MW. \\label{tab:SPC-exergy}",
			  align="llllll")

print(tab.exergy.tex,
##      size='\\small',
      table.placement='htbp!',
      include.rownames=FALSE,
      sanitize.text.function=identity,
      comment = FALSE)
```

\begin{align}
\alpha^{in}_{ex}&=\sum_{p \in P}  \sum_{i \in R^i}  Ex^{in}_{p,i} \\
&= \sum_{i \in R^i} Ex_i 
\label{eq:SPC-ex-in}
\end{align}

Similarly, calculation of the site's exergetic outputs $\alpha^{prod}_{ex}$, simplifies Equation [TODO:cross-ref Equation (3.5b)] to

\begin{align}
\alpha^{prod}_{ex}&= \sum_{j \in R^j} Ex_j
\label{eq:SPC-ex-out}
\end{align}

where $Ex_{j \or i}$ represent the exergy value of a resource (for example the chemical exergy of a fossil fuel, or the exergy of heating, recalling that the reference environmental exergy is considered in this). Because each scenario has the same set of demands, $\alpha_{ex}^{prod}=$ `r ex_prod` for all scenarios. Exergy calculations are performed for all scenarios, and the results are given in Table \ref{tab:SPC-exergy} (data and calculations provided in Appendix [TODO: cross-ref]).

[TODO: describe results]

The Grid case has no waste exergy, because there are no processes on site:

- i.e. all exergy losses would be accounted for offsite 
- there is a small exergy loss in terms of wastewater generated by the site, however the exergy value of this is negligable [TODO: recalculate with physical exergy] 

### Ecological network analysis

Chapter 3 also showed how to quantify how well cities work together as *sectors* (rather than just individual processes), using the methods of ecological network analysis.

The results of this type of analysis are important, because they indicate to planners the extent to which the different *management* parties need to cooperate to implement such a system, as well as where there are risks/vulnerabilities in the system if there is no cooperation.

Again, using the method outlined in Section [TODO: cite Grey-box metrics subsection of Chapter 3], the interdependencies of management sectors can be quantified [TODO: complete method].

```{r ena, fig.height=5, fig.cap="fig:ena", results="asis"}

ena <- read.csv("06_case-study/ENA.csv")

## Presentation scenario names
ena$scenario <- as.character(ena$scenario)
ena[ena$scenario=="gridCase_minCost", "scenario"] <- "Grid case (min. cost)"
ena[ena$scenario=="designCase_minCost", "scenario"] <- "Design case (min. cost)"
ena[ena$scenario=="designCase_minEmissions", "scenario"] <- "Design case (min. emissions)"
ena[ena$scenario=="designCase_minWaste", "scenario"] <- "Design case (min. waste)"
ena[ena$scenario=="designCase_minWater", "scenario"] <- "Design case (min. water)"
ena[ena$scenario=="wildcard_current_minCost", "scenario"] <- "Wildcard case (current)"
ena[ena$scenario=="wildcard_medium_minCost", "scenario"] <- "Wildcard case (medium)"
ena[ena$scenario=="wildcard_long_minCost", "scenario"] <- "Wildcard case (long)"

names(ena) <- c("Scenario", "Direct", "Utility")

tab.ena.tex <- xtable(ena,
			  caption="Results of ENA for SPC scenarios. \\label{tab:SPC-ENA}",
			  align="llll")

print(tab.ena.tex,
##      size='\\small',
      table.placement='htbp!',
      include.rownames=FALSE,
      sanitize.text.function=identity,
      comment = FALSE)
```

```{r ena-matrices, fig.height=7, fig.cap="fig:ena", results="asis"}

ena_matrices <- read.csv("06_case-study/ena-matrices.csv")


ena_matrices <- transform(ena_matrices,
		       Sign=factor(Sign, levels=c(-1,0,1),
				    labels=c("-","0","+")))

## Presentation scenario names
ena_matrices$Scenario <- as.character(ena_matrices$Scenario)
ena_matrices[ena_matrices$Scenario=="designCase_minCost", "Scenario"] <- "Design case (min. cost)"
ena_matrices[ena_matrices$Scenario=="designCase_minEmissions", "Scenario"] <- "Design case (min. emissions)"
ena_matrices[ena_matrices$Scenario=="designCase_minWaste", "Scenario"] <- "Design case (min. waste)"
ena_matrices[ena_matrices$Scenario=="designCase_minWater", "Scenario"] <- "Design case (min. water)"
ena_matrices[ena_matrices$Scenario=="wildcard_current_minCost", "Scenario"] <- "Wildcard case (current)"
ena_matrices[ena_matrices$Scenario=="wildcard_medium_minCost", "Scenario"] <- "Wildcard case (medium)"
ena_matrices[ena_matrices$Scenario=="wildcard_long_minCost", "Scenario"] <- "Wildcard case (long)"

plot_ENA <- ggplot(ena_matrices, aes(From, To)) +
  geom_tile(fill=NA, color="black", na.value=NA) +
  geom_text(aes(label=Sign), size=3) +
  facet_grid(Scenario~Matrix) +
  theme_bw() +
  theme(axis.text.x = element_text(angle=30, hjust=1))
plot_ENA
```

### Summary

However, the synergies that we look for will not necessarily occur if the objective is to minimise cost.

The preference of the model, as shown by the wildcard scenarios, is to choose a large number of of varied processes, and also make use of the available transport connections, to decentralise resource management. Note however that the model is nevertheless discerning: given 300 [TODO: accurate number] processes to choose from, it selects only [TODO: number] for the wildcard scenarios. Similarly, out of N possible transport options [TODO: footnote giving calculations: available connections  transport types for each]. Thus the PRaQ model successfully and intelligently optimizes the process mix.

We also know however, from the design scenarios, that the optimal mix of processes is sensitive to the objective chosen. [TODO: check this -- Try testing the wildcard options with different objectives and demands, and see how different the process mixes are. I.e. can similar systems manage meet different set of demands and/or objectives?]

The exergy analysis and ENA analysis has demonstrated that -- as far as metabolically efficient can be defined -- that proposed systems are metabolically efficient.

## Discussion and conclusions
<!--
Paragraph ideas from JK's MILP paper
# Conclusions

- "There have been many models developed...however..."
- "In this paper we..."
- "Another feature of the model..."
- "The model was illustrated using..."
- "There are a number of future directions for the model..."
-->

The results of the modelling show that the PRaQ model is helpful to the SPC planners, showing that they are right to propose an integrated system of resource management to meet planning objectives. The model validates their proposed plans for the integrated resource planning, with the energy island and water reuse project, but also challenges the planners to consider a more sophisticated, varied and decentralised network of processes, alongside a varied schedule of resource imports.

This complex result of the wildcard model is itself a demonstration of the power of modelling: such a system design is far too complex to be designed by hand. [TODO: continue thought]

Even if the proposed wildcard designs are too complex, it is still the case, that the more processes involved, the greater the level optimisation that can be achieved, thus the SPC planners may wish to consider at least a subset of resources,

In this chapter we have 
demonstrating how one might go from a site about which some information is known, to develop 
in doing so, we have also provided a rule-of-thumb method to estimate the costs of processes which do not yet exist, and to consider economies of scale in system design.

- Broad comments
- Comments about the high prevalence of energy: is this accounted for by the quantities produced by water?
- Consider that water/waste management processes may not be as prevelent in the database (and hence in reality anyway)
- Hidden savings: don't forget that (unlike energy optimisation models), the water and waste flows for energy processes are considered!
- Need to look further at household level water and waste management.
- Not all the sectors are strictly defined for processes
- General comments about more processes = better
- Exergy analysis and ENA to confirm the intuitive findings.
- Decentralisation seems to be the way! Especially with energy. Decentralisation may be the way to a better energy system
- More processes may also give more flexibility to respond to adapt operation upon changing consumer demands.
The overall contribution to this thesis is to [TODO:]. To the field as a whole [TODO:] 

[TODO: Other ideas and content]

TODO IDEAS:

- Shannon Index
- Degree of capacity (e.g. depth of colour of node in network plot) to show redundancy which can fill in for unexpected rises in demand (or drops in resource availability)


### Further work

- Sensitivity analysis
- Operational study

There are limitations to what the results show. We have already noted the approximate nature of process costs. Furthermore [TODO: comment on part-load operation], for the sake of simplicity, our model has aggregated yearly demand to a single per-second value (rather than considering peak and average demand). Thus, we are unable to quantify the degree to which conversion processes within our systems are oversized, without running models with a finer temporal resolution which accounts for variations within a single day.

- Cost function
	- Selling/exporting products (which would change the exergy calculations)
	- Fines (e.g. on CO2)

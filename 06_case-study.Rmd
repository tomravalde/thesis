# Case study: a Chinese urban development {#sec:case-study}


\epigraph{``I don't like novels that end happily. They depress me so much''}{Cecily Cardew in \emph{The importance of Being Earnest} by Oscar Wilde}

\begin{tcolorbox}

An early version of the work in this chapter was published as: 
Tom Ravalde, James Keirstead, Integrated Resource Planning for a Chinese Urban Development, \emph{International Symposium for Next Generation Infrastructure Conference Proceedings}, doi: \url{http://discovery.ucl.ac.uk/1469209/}.

\end{tcolorbox}

```{r Setup, include=FALSE, results="hide", warning=FALSE}
library(knitr)
opts_chunk$set(fig.path = "figures/", dev=c("cairo_pdf"), fig.pos='htbp', fig.width=5, fig.height=3.5, dpi=700, fig.show='hold', fig.lp="fig:", cache=FALSE, par=TRUE, echo=FALSE, results="hide", message=FALSE, warning=FALSE)

library(extrafont)
font_import(pattern="LinBiolinum")

library(ggplot2)
```
<!--
Sections in JK's MILP paper

# Case study

- proposed eco-town development (ambitions)
- site characteristics
- zonal demands
- timings
- figrues with data

## Resources and technologies
## Objective function
## Results
-->


This thesis has argued for the need for an optimisation model which can help plan urban energy, water and waste infrastructure, with a view to improving the urban metabolism of an area. To that end, the previous chapter introduced the PRaQ model -- a MILP formulation that is generic enough to incorporate multiple resource types, user-friendly to construct, and can be solved without excessive computational effort. This chapter now applies this model to a case study, using the library of resource management processes assembled in Chapter \ref{sec:database}, and using some of the principles of Chapter \ref{sec:metrics} to assess the systems designed by the model.

This chapter first introduces the case study (Section \ref{sec:case-study-intro}), before outlining the site's spacial layout and resource demands, as well as processes available to manage its resources (Section \ref{sec:SPC-data}). Following this, Section \ref{sec:SPC-scenarios} introduces several scenarios to which PRaQ is applied. These scenarios will all use the same patterns of resource demand, but vary in their objectives and/or the set of available resource-management processes. This will allow investigation of both currently proposed system designs, as well as other more speculative ideas. This section will then present and discuss the results for each scenario. In summary, this chapter's aim is to use a case study to show how the PRaQ model can improve an area's metabolism, to fulfill aim 3 of the research question (Section \ref{sec:research-qn}).

## The case study {#sec:case-study-intro}

The case study is an ongoing Chinese urban development led by the Xi'an Shann Gu Power Company (hereafter, 'SPC'), who historically have provided turbo-machinery services (such as steam turbines, fans and energy recovery units) for the chemical industry, power generation, construction, and other sectors requiring heavy machinery [@SPC2014]. The SPC are implementing plans to redevelop one of their industrial sites and its surrounding region. The site is in the Xi'an province of China with an area of 51.03 km$^2$; the focus of this case study, however is a region of 7 km$^2$. This area has residential, commercial, industrial and recreational functions (roughly represented by Figure \ref{fig:site})[^confidential] which each have their own energy, water and waste management needs.

[^confidential]:There are six documents which provide background and data to the SPC redevelopment plans. However, the documentation is confidential and thus certain information (such as the precise site location) cannot be given here.

\begin{figure}
	\centering
	\begin{spacing}{1.0}
	\sffamily
	\resizebox{0.5\columnwidth}{!}{\input{06_case-study/site.pdf_tex}}
	\end{spacing}
	\caption{A schematic of the SPC redevelopment site, adapted from figures in the SPC documentation. The outer dashed rectangle encloses the full 7 km$^2$ site; the solid rectangles with \textbf{bold} labels represent broad regions within the site (e.g. the \textbf{residential} region; the unbolded text labels denote specific zones (e.g. a hospital within the residential region).}
	\label{fig:site}
\end{figure}

A stated ambition of the SPC site redevelopment is to integrate the energy, water and waste management services in order to maximise energy efficiency, minimise the discharge of waste, and minimise economic costs. Proposals to that end include using heat stored within wastewater to feed a water source heat pump, and generating biogas from wastewater fermentation. The recreational area is to include an artificial lake, which the planners hope to source via a water reuse project [@SPC_water]. These, and other possible intersectoral synergies are summarised in Figure \ref{fig:shanngu-network}, which shows part of the resource management infrastructure proposed by the SPC for the site's redevelopment.

\begin{figure}
	\centering
%	\begin{spacing}{1.0}
%	\sffamily
	\includegraphics[width=\textwidth]{06_case-study/shanngu-network.pdf}
%	\end{spacing}
	\caption{SPC's proposed interactions between energy, water and waste management. Resources with \textbf{bold} labels represent those resources either demanded or produced by the end-users in the zone of Figure \ref{fig:site}; and * indicates a resource can be imported from outside the system boundary (represented by the dashed line). In the modelling that follows, these processes will be split between the zones of the site. The zones themselves can be connected by transport infrastructure.}
	\label{fig:shanngu-network}
\end{figure}

\begin{figure}
	\centering
	\begin{spacing}{1.0}
	\sffamily
	\resizebox{0.5\columnwidth}{!}{\input{06_case-study/site-dimensions.pdf_tex}}
	\end{spacing}
	\caption{A re-representation of the SPC redevelopment site, with arrows indicating how zones can be connected (defined in set $nb(z,z')$). All distances are in kilometers. Each region centre connects to the other zones in the region (e.g. \textbf{Factory (south)} $\leftrightarrow$ Assembly) with a connection that is assumed to be 0.5 km in length.}
	\label{fig:site-connections}
\end{figure}

Previous work has looked at the energy management for the site's industrial and residential areas [@Zheng2017]. This modelled the thermal properties of the buildings to derive the site's energy requirements as they fluctuate over a time horizon, and used a MINLP modelling framework to choose the network of energy supply technologies with minimum system cost under different scenarios of energy prices and limits on emissions. This work is less detailed -- it does not attempt to model the demands or consider go into detailed sensitivity analysis. However it takes a higher-level view by incorporating water and waste systems alongside the energy system, and considers not just the current proposals for a system design, but also those made possible when the full database of Chapter \ref{sec:database} is considered. In other words, this case study is concerned less with the detailed design of the SPC's energy system, but more with optimising the site's metabolism.
<!--
Slide 20
--->

<!--
- [SPC-4, slide 17: water, waste and energy jigsawed together]
- [SPC-4, slide 19: Energy island with CHP, CCHP and sewage source heatpump 
- [SPC-4, slide 21: Energy island]
- [SPC-4, slide 22: Energy provision via CHP, CCHP and sewage source heatpump, (as well as traditional and renewable approaches)]
- [SPC-4, slide 25: "Increase energy supply efficiency", "decrease discharge cost" and influence "by cycle reuse", in order to save energy, give social benefits, and economic efficiency]
- [SPC-4, slide 26: Energy island logic diagram, incorporating sewage treatment, water reuse, solid waste treatment, cooling/heating, and solar-PV power]
- [SPC-4, slide 27: Within that, the "Combined water supply and treatment system" has WSHP, rainwater collection, fermentation to produce biogas, sewage plant, water treatment, and water reclamation]
-->

## Model data {#sec:SPC-data}
<!--
- Data
  	- resources
  		- generic
  		- specific, due to the site, e.g. exergy of heat
  	- processes
  		- generic, from the database
	  	- specfic, due to the site, e.g. rain, leachate = f(rain, evaporation, landfill area)
		- real processes, heat exchangers (and associated water flows)
		- dummy processes (e.g. MSW splitting, waste generalising)
-->

When applying the model to a case study, the first step is to specify the zones and time periods used in the model, defined by sets $z \in Z$ and $t \in T$, respectively. With the zones determined, another set specifies whether any pair of zones $(z,z')$ are neighbours, by defining them as belonging to the set, $nb(z,z')$. Following this, the sets of processes and resources available to the model can be listed ($p \in P$ and $r \in R$, respectively). At this point, there is enough information to define the two final sets: first, the qualities to be attributed to resources ($q \in Q$), and second, the transport technologies, $\tau \in \mathcal{T}$ which transfer the resources between zones.

With the sets in place, the parameters can be defined. First the distance between between two any two neighbouring zones defines the interzonal distances, $l_{zz'}$ (kilometers), while $\mathbb{S}_t$ defines the length of time of each time period, $t$ (days). Resource management needs can then be assigned to each time and location with $D^{(qty)}_{rzt}$ and $D^{(qual)}_{qzt}$. Other parameters to define include the limits on imports and exporting resources to particular zones, and the costs of resources and processes.

The following subsections outline how the sets and parameters above are defined from the SPC documentation (with further details provided in Appendix \ref{sec:app-spc}). The explanations are deliberately comprehensive, reflecting on why certain choices and assumptions regarding data are made, to justify the modelling decisions taken here -- recall that Section \ref{sec:modelling-intro} noted that the value of modelling found not merely in the results, but in making explicit assumptions and methods which would have otherwise been unstated in the decision-making processes. This walks the reader through how one might design a model for a particular case study, and when it would be appropriate to take different decisions. The details are given in the recommended order of how a user might construct a particular case study model.

```{r resource-demands, fig.height=5, fig.width = 7, fig.cap="Resource management demands for the SPC site's zones (with the broader regions indicated by \\textbf{bold} axis labels). Positive values indicate the resource is consumed by the end-users; negative values (i.e., for wastes and wastewater) indicate the resource is produced by the end-users.\\label{fig:site-demands}"}
demands <- read.csv("06_case-study/resource-demands.csv")
demands <- demands[complete.cases(demands$value.conv), ]

demands$headings <- "placeholder"

demands[demands$resource=="heat", "headings"] <- "Heating [MW]"
demands[demands$resource=="cool", "headings"] <- "Cooling [MW]"
demands[demands$resource=="elec", "headings"] <- "Electricity [MW]"
demands[demands$resource=="waterPotable", "headings"] <- "Potable water [kg/s]"
demands[demands$resource=="wastewater", "headings"] <- "Wastewater [kg/s]"
demands[demands$resource=="waste", "headings"] <- "Waste [kg/s]"
demands[demands$resource=="waste_organic", "headings"] <- "Organic waste [kg/s]"
demands[demands$resource=="water_reclaimed", "headings"] <- "Reclaimed water [kg/s]"

demands$zoneLabels <- "placeholder"
demands[demands$zone=="general", "zoneLabels"] <- "General"
demands[demands$zone=="factory", "zoneLabels"] <- "Factory (south)"
demands[demands$zone=="factory_assembly", "zoneLabels"] <- "Factory (assembly)"
demands[demands$zone=="northDistrict", "zoneLabels"] <- "Factory (north)"
demands[demands$zone=="multifunction", "zoneLabels"] <- "Factory (multi-function facility)"
demands[demands$zone=="factory_blades", "zoneLabels"] <- "Factory (blade production)"
demands[demands$zone=="tech", "zoneLabels"] <- "Factory (technology building)"
demands[demands$zone=="quality", "zoneLabels"] <- "Factory (quality control)"
demands[demands$zone=="dormitories", "zoneLabels"] <- "Factory (dormitories)"
demands[demands$zone=="residential", "zoneLabels"] <- "Residential"
demands[demands$zone=="hospital", "zoneLabels"] <- "Hospital"
demands[demands$zone=="school", "zoneLabels"] <- "School"
demands[demands$zone=="energyIsland", "zoneLabels"] <- "Energy Island"
demands[demands$zone=="reserved", "zoneLabels"] <- "Reserved"

demands$seasonLabels <- "placeholder"
demands[demands$season=="sum", "seasonLabels"] <- "Summer"
demands[demands$season=="wint", "seasonLabels"] <- "Winter"
demands[demands$season=="shoulder", "seasonLabels"] <- "Shoulder"

demands_alt <- filter(demands, season=="sum")

demands$zoneLabels <- factor(demands$zoneLabels, levels=c("General",
							  "Factory (south)",
							  "Factory (assembly)",
							  "Factory (north)",
							  "Factory (multi-function facility)",
							  "Factory (blade production)",
							  "Factory (technology building)",
							  "Factory (quality control)",
							  "Factory (dormitories)",
							  "Residential",
							  "Hospital",
							  "School",
							  "Energy Island",
							  "Reserved"))

demands$zone<- factor(demands$zone, levels=c("general",
							  "factory",
							  "factory_assembly",
							  "northDistrict",
							  "multifunction",
							  "factory_blades",
							  "tech",
							  "quality",
							  "dormitories",
							  "residential",
							  "hospital",
							  "school",
							  "energyIsland",
							  "reserved"))

plot_demand <- ggplot(demands, aes(zoneLabels, value.conv)) +
  geom_point(aes(colour=seasonLabels), binaxis="y", position=position_dodge(width=0.6)) +
  facet_wrap(~headings, scales="free_y", ncol=2) +
  labs(colour="Season") +
  theme_bw() +
  theme(axis.text.x = element_text(hjust=1,
				   angle=30,
				   size=6.5,
				   face=ifelse(levels(demands$zone) %in% c("factory", "northDistrict", "residential"),"bold", "plain")
				   ),
	axis.title.x = element_blank(),
	axis.title.y = element_blank())
plot_demand

```

### Site layout {#sec:case-study-site}

Each of the twelve zones shown in Figure \ref{fig:site} will be represented in the model, and thus each belongs to the set of zones $z \in Z$, where $|Z|=12$. It is assumed that the three regions will be linked via a connection running north-south through the site, and also that the functions within a region are equidistant from the region's centre (with the exception of the energy island which does not belong to a region). This makes the size of set $nb_{z,z'}$ as $|nb|=12$. The connection distances have been estimated from the site's dimensions. Assuming that the region-to-region connections join the regional centroids, distances can be estimated by scaling distances from the site plans in the SPC documentation. The region-to-function distances will be assumed as 0.5 km. In total, there are twelve two-way connections defined, which are given in Table \ref{tab:zonal-connections}. The transport processes used for these connections are detailed in Section \ref{sec:case-study-transport-processes}, but briefly, roads are assumed to exist along any connection. Additionally, the model will have the option to run underground pipes and overhead cables along their length[^road-cost]. Further details are given in Appendix \ref{sec:app-spc-site}.

[^road-cost]: As discussed in Section \ref{sec:case-study-transport-processes}, this means that roads have no financial cost in the model, whereas pipes and cables will.

\begin{table}[]
\centering
\caption{The zonal connections defined for set $nb(z,z')$ (with \textbf{bold} text denoting a broader region), and their corresponding lengths $l_{zz'}$ used in the SPC case study.}
\label{tab:zonal-connections}

\begin{tabular}{@{}llll@{}}
\toprule
$z$                      & $z'$                     & Dimension on plan {[}cm{]} & Site dimension, $l_{zz'}$ {[}km{]} \\ \midrule
\textbf{Factory (south)} & \textbf{Factory (north)} & 3.4                        & 0.9                     \\
\textbf{Factory (south)} & Assembly                 &                          & 0.5                     \\
\textbf{Factory (south)} & Multifunction district   &                          & 0.5                     \\
\textbf{Factory (south)} & Dormitories              &                          & 0.5                     \\
\textbf{Factory (south)} & Turbines                 &                          & 0.5                     \\
\textbf{Factory (north)} & Technology building      &                          & 0.5                     \\
\textbf{Factory (north)} & Quality control          &                          & 0.5                     \\
\textbf{Factory (north)} & Energy island            & $4.8+1.3=6.1$              & $1.3+0.4=1.7$           \\
\textbf{Factory (north)} & \textbf{Residential}     & $4.8+3.4=8.2$              & 2.2                     \\
\textbf{Residential}     & School                   &                          & 0.5                     \\
\textbf{Residential}     & Hospital                 &                          & 0.5                     \\
\textbf{Residential}     & Reserved                 &                      & Assume to be 1                       \\ \bottomrule
\end{tabular}
\end{table}


<!--
Assembly,Factory (south)
Factory (north),Factory
Multifunction district,Factory (north)
Technology building,Factory (north)
Dormitories,Factory (north)
Energy island,Multifunction district
Technology building,Turbines
Quality,factory_blades
school,Residential
school,hospital
school,energyIsland
school,reserved
-->

### Times {#sec:case-study-times}

The SPC documentation provides energy demands for winter, summer and year round [@SPC_demand]. This model therefore uses three timesteps, specified by $t \in T$, where $|T|=3$, representing the winter, summer, and shoulder seasons, having spans, $\mathbb{S}_t$, of 90 days, 90 days, and 180 days respectively. This means that the infrastructure selected by the model would be in place all year round, but could operate differently in each season. Consider the provision of domestic heating provided by district heating as an example. In the winter, the district heating could deliver heat to homes, and this govern the operation of heat-generating processes upstream of the district heating network. However, these upstream operations would not be required in the summer, when the district heating does not run. As this phenomenon is applied in relation to all the resource demands, the network of processes emerging from the system interactions could operate differently in each season, in order to optimise the site's metabolism.

Of course, in reality operation might not just vary by season, but could vary for smaller time slices. For example each season could have alternative weekday and weekend resource demand (thus $|T|=3 \mbox{ seasons} \times 2 \mbox{ day types}= 6$), which could be further divided into hourly demands (thus $|T|=3 \mbox{ seasons} \times 2 \mbox{ day types} \times 24 \mbox{ hours} = 144$). The temporal resolution could become finer still, using demands at a minute-by-minute or second-by-second level. Thus the decision here to use seasonal timesteps is not as coarse as it could be (i.e. yearly), but neither is it as granular as it could be. Greater resolution would require additional assumptions by downscaling the data from the SPC documentation (which is given at a seasonal level), and would come at  greater computational expense[^finer-time].

[^finer-time]:Section \ref{sec:formulation-developments} discussed possible modelling approaches which use more time steps without proportionately increasing the computational costs.)

In summary, seasonal timesteps are appropriate to the exploratory early-stage planning purposes of this model. Further along the planning process when detailed designs are being examined, it would be justifiable to expend more effort, thus a finer temporal resolution may be warranted. Furthermore, at the more detailed design stages, some decisions will have been made (for example, the location of a particular conversion process), thus reducing the number of variables in the model, and thereby speeding up computation.

### Resource demands {#sec:demand-parameters}

Having determined the seasons and the time steps in the model, it is now possible to define the resource demand parameter $D^{(qty)}_{rzt}$ for each resource, $r$. (As mentioned in Section \ref{sec:implementation}, the code which assembles the model is designed such that $D^{(qual)}_{rqzt}$ can be defined automatically once $D^{(qty)}_{rzt}$ is known.) The SPC documentation provides values which can be used in the modelling. However, these values do not necessarily cover all resources $r$, and may not be disaggregated to each zone, $z$ and season, $t$. Thus, sometimes, assumptions and calculations need to be applied in order to translate a documented value into a set of values which can be used in the modelling. The details of these adjustments are provided in Appendix \ref{sec:app-spc-demands}.

The resource demands used here are summarised in Figure \ref{fig:site-demands}, which shows the seasonal demand for energy (electricity, heating, and cooling), water (potable, and reclaimed), and waste management (wastewater, non-organic solid waste, and organic solid waste). Resource demands are defined as rates, i.e. on a per-second basis (kg/s or MW). This is a common way to express energy quantities, which makes sense given that energy is most commonly demanded on such a basis, i.e. as a power[^energy-rate]. This makes the demand parameter definitions consistent with PRaQ's definition of process behaviour, because process rates are also defined on a per-second basis.

[^energy-rate]: This is in contrast to waste management services (to give one example) in which waste may be collected at regular intervals (e.g. weekly), and set to a particular processing unit once a certain threshold (e.g. tons) has been met. Nevertheless, for the sake of model usability, there should be consistency between the definition of energy and other resource demand definitions. 

### Other resource parameters

The resource demands discussed above will define some of the $r$ items in set $R$, but to complete this set requires the other resources which the available conversion processes can consume and produce. In total, there are 68 resources, including everything from algae to wood. Each resource has at least one associated quality $q$, which is attributed to the resource using the $X_{rq}$ and $\delta^R_{rq}$ parameters. The qualities used in this case study are *mass* and *energy*. Most resources are only attributed with one of these (e.g. algae possesses mass, and heat possesses energy), though some resources are attributed with both (e.g. ground water has both a mass and an energy head). With the resources, zones and times determined, the remaining resource-related parameters can be defined, namely: limits on how many zones can import and export particular resources ($N^I_r$, $N^E_r$), the maximum allowable imports of a resource in a season ($I^{max}_{rt}$, $E^{max}_{rt}$), and the cost and emissions factors of resources ($c^R_r$ and $\epsilon^R_r$). Further details are given in Appendix \ref{sec:app-spc-res-params}.

### Conversion processes {#sec:conversion-processes}

The contents of the process set $P$ will vary for each scenario, and will draw from both technologies proposed by the SPC, and the database of urban metabolism processes outlined in Chapter 4. The information needed to define the processes are the coefficients which define the input and output resource quantities ($k^P_{prq}$), and maximum process rates ($F^{P,max}_p$). For the database processes this information already exists, but for the SPC proposals, this information needs to be derived from the SPC documentation.

In addition to these parameters, each process needs a cost, $c^P_p$, for use in the objective function. Estimating these is not without its difficulties. First, there is the shear number of processes in the database (202 in total). Second, the process database includes processes which have not yet penetrated into the market or are still to be developed (i.e. those with a technology readiness level marked as 'long-term', p.\pageref{list:process-def}), thus there are no values which can be easily lifted from the literature. Third, currency exchange rates and purchasing power parities around the world make it difficult to attribute a cost to a process with any degree of certainty. For these reasons, costing is approximate.

The broad approach to estimating process costs is to assemble a number of 'process categories' ($\mbox{PC}$), to which processes from the database -- 'database processes' ($\mbox{DP}$) -- are assigned. As an example, *'biogas-fuelled CHP'* is defined as a $\mbox{PC}$, which includes four types of biogas-fuelled CHP conversion processes in the database. Costs are assigned to the $\mbox{PCs}$, in terms of a process's capacity (i.e. USD/MW or USD/kg/s). These costs are obtained from the literature -- this may require some assumptions and adjustments to the numbers -- details are given in Appendix \ref{sec:app-spc-conversion}). A guiding principle of these estimations is that process costs exhibit economies of scale [^scale-economy]. For this to be captured in the model, each $\mbox{PC}$ is assigned both a lowerbound and an upperbound unit cost, $\mbox{Cost}^{\mbox{LB}}$ and $\mbox{Cost}^{\mbox{UB}}$ respectively. Thus, the total cost of any particular $\mbox{DP}$ with a given capacity (unit = MW or kgs/s) can be calculated from:

[^scale-economy]: For example, if a system demand requires 10 MW, then it should be cheaper to meet that demand with two 5 MW power plants than ten 1 MW power plants.

$$
\begin{align}
\mbox{DP Total Cost [USD]} = \mbox{PC Unit Cost [USD/unit]}^* \times \mbox{DP capacity [unit]},
\end{align}
$$

where $^*$ can indicate either $\mbox{LB}$ or $\mbox{UB}$. The lowerbound costs are applied to larger instances of a process, and upperbound costs are applied to smaller instances, and thus $\mbox{DPs}$ become cheaper as they get larger.

For the conversion processes which do not yet exist in the market, costs are based on existing processes which have the same main resource[^main]. This is a conservative approach because it assumes that new processes will not penetrate the market unless they deliver a particular service (i.e. to manage a main resource) at lower cost than a more traditional method of conversion[^cost-estimation].

[^main]: Recall from Chapter \ref{sec:process-mapping} the idea of a 'main' resource being the (e.g. electricity output for a power plant, or wastewater input to a treatment facility), and always has a value of $k_{pr}=\pm 1$.

[^cost-estimation]: Though one may argue against this principle on the basis that a novel process may be more expensive than older methods due to other benefits (e.g environmental benefits). However, this thesis can only hope to be approximate with the cost of conversion processes, and indeed, such estimations warrant their own separate research focus [@EdwardW.Merrow1979, @Roy2005].

In summary, the conversion processes in this case study are drawn from both the SPC documentation (18 in total), and the database assembled in Chapter 4 (202 unique process types, which increases to 363 when including processes of different capacities). Each modelled scenario is given a subset of these processes it is allowed to choose from (as outlined in Section \ref{sec:SPC-scenarios}). Cost estimates have been provided for these processes, which enable PRaQ to take into account economies of scale, and the cost of processes which do not yet exist in the market. In summary, the SPC case study modelling can choose from up to 381 conversion processes from which to design an integrated resource management system, for which a rough overall system cost can be computed.

### Transport processes {#sec:case-study-transport-processes}

Many of the resources (with some exceptions such as heat[^heat-transport]) can be transported between zones, via three types of transport infrastucuture: roads, along which vehicles can transport everything from municipal solid waste, to gases and liquids carried by tankers; pipes, which transport water and gases; and cables, to carry electricity. As noted in Section \ref{sec:case-study-site}, the roads are assumed to already exist to connect neighbouring zones of set $nb_{zz'}$, whilst underground pipes and overhead cables can be optionally added by PRaQ, if and where necessary.

[^heat-transport]: Though whilst heat itself cannot be transported, it can be carried by water, e.g. in a district heating pipe network.

Transport processes are defined by the origin-to-destination resource input and output coefficients, $k^{*}_{\tau rq}$ (where $*$ stands for $\alpha$, $\beta}$, $\alpha'$, and $\beta'$), and define quantities for the resource carried (e.g. water through a pipe); the energy resources required to carry that resource along the length of a connection (e.g. electrical energy to pump water along a pipe); and any by-products, wastes, and emissions from the process. The main resource typically leaves the origin zone and arrives in the destination (perhaps minus some losses, such as power along a cable), the energy resources and by-products should be appropriately shared shared between the origin and destination. The specifics of transport process coefficients are outlined below, for the three main types of transport technologies, with example values of $k^*_{\tau rq}$ given in Table \ref{tab:transp-coeffs}. 

\begin{description}

\item[Cables] This is the simplest transport process type, with only a single resource value is necessary:  ($r=\mbox{electricity}$). Electricity transported via cables do incurr losses at rates of between 3--7 per cent over 1,000 km distances \citep{IEA2016}, however, given the whole site is only 7 km\textsuperscript{2}, these losses are considered negligable here. Thus cables can be defined simply with $k^{\alpha}_{\tau rq}=1$, $k^{\alpha'}_{\tau rq}=-1$, and $k^{\beta}_{\tau rq} = k^{\beta'}_{\tau rq}=0$ when $\tau=\mbox{cable}$, $r=\mbox{electricity}$, and $q=\mbox{energy}$. 

\item[Pipes] These can transport $r=\mbox{water}$ or $r=\mbox{gas}$, and require electricity to provide pumping energy. Hydraulic calculations given in Appendix \ref{sec:app-spc-pipes} derive the amount of energy required to overcome friction between the water and the pipe in a pipde of zero slope\footnote{This assumes the nonlinearities in the relationship between transport mass and volume can be ignored.}. The modelling assumes that all this electricity is provided in the zone of the water's origin. For gases it is assumed that friction is low enough so as to make the energy requirements negligable for the distances in the SPC site.

\item[Vehicles] Other resources are carried by vehicles. As well as the carried resource (e.g. $r=\mbox{biomass}$), vehicles require gasoline. It is assumed this is provided entirely by the source zone. As well as this, \COtwo emissions are emitted, with these being shared equally between the origin and destination zones. The $k_{\tau rq}^*$ values are derived in Appendix \ref{sec:app-spc-vehicles}.

\end{description}


\input{06_case-study/tab-transp-coeffs.tex}

As with the conversion processes, transport processes each need to have an associated cost, $c^T_{\tau}$. As the roads already exist, these are not costed in the model, as their total cost would be the same, whatever the system designed by the model. The cost of cables and pipes are defined per kilometer, and the values and sources for these calculations are linked to in Appendix \ref{sec:app-spc-transp}.

## Application to model scenarios {#sec:SPC-scenarios}

Having detailed the data sources, assumptions, and calculations used to determine the model's parameters, PRaQ is now applied to seven scenarios (\ref{itm:base}--\ref{itm:wild-long}, below) to give insights on how to satisfy SPC demand using different sets of available processes and objective functions:

1. *Base case.* \label{itm:base} This assumes that the required quantities of electricity, fuels and water are imported directly from the grid (with wastewater treated on site). Thus, in this case, there is no attempt to take advantage of synergies. As such, this scenario provides baseline results to which other results can be compared.

2. *Design case.* \label{itm:design} The site developers intend to take advantage of intersectoral synergies to minimise resource consumption. This scenario considers the processes suggested in the SPC documentation, including combined heat and power (CHP), a wastewater source heat pump, and a district heating network. This scenario has three sub-scenarios to test how the process mix changes, with different objectives:
	a. \label{itm:design-cost} Design case -- minimum cost
	b. \label{itm:design-emissions} Design case -- Minimum emissions
	c. \label{itm:design-waste} Design case -- minimum waste
	<!--
	d. \label{itm:design-water} Minimise freshwater consumption
	-->
3. *Wildcard case.* \label{itm:wild} This scenario finds the minimum-cost process mix, when the processes of the database from Chapter \ref{sec:database} are made available, using three time horizons of process-availability:
   	a. \label{itm:wild-short} Wildcard -- current (using currently available processes)
   	b. \label{itm:wild-medium} Wildcard -- medium-term (using technologies available in the current- to medium-term)
   	c. \label{itm:wild-long} Wildcard -- long-term (using technologies available in the current- to long-term, such as the solar electrolysis of water to produce hydrogen)

Scenario \ref{itm:wild-long} forms the largest programme, and thus indicates the computational effort required to solve the problems, having 1,220,809 single variables, 7,670 discrete variables, and 1,248,035 equations.

These scenarios enable testing of a network's sensitivity to fairly broad design considerations (such as technology availability and objective functions). More detailed design problems should be more narrowly focussed, by applying sensitivity analysis to understand how a system design responds to other factors such as changing demand, resource and technology prices, and other factors (see @Saltelli2008, @Keirstead2012 and @Zheng2017, for examples). These detailed considerations are beyond the scope of this study due to the nature of the model itself, and -- more importantly -- the aims of this thesis, namely to understand the possible benefits of intersectoral synergies in improving urban metabolism (\ref{sec:tat-discussion}).
<!--
OTHER SCENARIO VARIATIONS
- DSM
- min-cost
- min emissions
- cost/emissions pareto
- export revenue (e.g. hydrogen economy)
- Exergy verses other objectives (cost, carbon footprint, water footprint, waste output)
- min cost -- DSM
- min cost -- phased planning
- min water
- min landfill
- min cost/targets of individual sectors (energy, water, waste), or differently weight them?
-->

When GAMS runs a scenario[^case-study-runs], it outputs the results into a set of CSV files, which are passed into an R script for processing so the output data can easily be used to describe the system designs (namely the resource flows and network of processes), and compute quantities such as cost, emissions, water footprint, exergy efficiency, as well as perform ENA. The following subsections visualise and describe the results, and discusses their implications for optimising an area's metabolism. Appendix \ref{sec:app-spc} provides links to all results in CSV format.

[^case-study-runs]: As with the benchmark study (Chapter 5), the project architecture separates the data and formulation, to facilitate running, reproducibility, modification, and development of the scenario models. Also to that end, the data and formulation are available at \url{https://github.com/tomravalde/shann-gu-case-study}, along with the results of the modelling.

```{r headlines, fig.height=5, fig.cap="fig:headlines", results="asis"}

headlines <- read.csv("06_case-study/headlines.csv")

## Presentation scenario names
headlines$scenario <- as.character(headlines$scenario)
headlines[headlines$scenario=="gridCase_minCost", "scenario"] <- "Grid case (min. cost)"
headlines[headlines$scenario=="designCase_minCost", "scenario"] <- "Design case (min. cost)"
headlines[headlines$scenario=="designCase_minEmissions", "scenario"] <- "Design case (min. emissions)"
headlines[headlines$scenario=="designCase_minWaste", "scenario"] <- "Design case (min. waste)"
headlines[headlines$scenario=="designCase_minWater", "scenario"] <- "Design case (min. water)"
headlines[headlines$scenario=="wildcard_current_minCost", "scenario"] <- "Wildcard case (current)"
headlines[headlines$scenario=="wildcard_medium_minCost", "scenario"] <- "Wildcard case (medium)"
headlines[headlines$scenario=="wildcard_long_minCost", "scenario"] <- "Wildcard case (long)"

## Order the scenario names
headlines <- transform(headlines,
		 scenario=factor(scenario,
		   levels=c("Grid case (min. cost)",
			    "Design case (min. cost)", 
			    "Design case (min. emissions)", 
			    "Design case (min. waste)", 
			    "Design case (min. water)", 
			    "Wildcard case (current)", 
			    "Wildcard case (medium)", 
			    "Wildcard case (long)"),
		    ordered=TRUE))

```

### System designs and metabolic flows

A key premise of this thesis is that the aggregate metabolic flows into and out of a city are governed by the middle of the system, i.e. a network of resource management processes. This observed in Figure \ref{fig:metabolic-flows}, which shows how aggregate metabolic flows differ for each scenario and Figure \ref{fig:metabolism_summary} which shows that making more processes available to PRaQ tends to design networks made up of a larger number of processes and resource types.



<!--
{r metabolic_flows, fig.height=5.5, fig.width=9.5, fig.cap="Metabolic flows into and out of the SPC site.\\label{fig:metabolic-flows}"}
-->

```{r metabolic_flows_calcs}

## Metabolic flows

# Load data (copied from the GAMS output from the cluster)
metabolic_flows <- read.csv("06_case-study/metabolic_flows_thesis.csv")

## Reshape imports and exports into the same column
metabolic_flows <- melt(metabolic_flows, variable.name="Flow")

## Remove the non-real outflows
					      
metabolic_flows[metabolic_flows$scenario=="Design case (min. water)" & metabolic_flows$Flow=="exports" & metabolic_flows$resource=="elec", "value"] <- 0

metabolic_flows[metabolic_flows$scenario=="Design case (min. waste)" & metabolic_flows$Flow=="exports" & metabolic_flows$resource=="elec", "value"] <- 0

metabolic_flows[metabolic_flows$scenario=="Design case (min. water)" & metabolic_flows$Flow=="exports" & metabolic_flows$resource=="heat", "value"] <- 0

metabolic_flows[metabolic_flows$scenario=="Design case (min. waste)" & metabolic_flows$Flow=="exports" & metabolic_flows$resource=="heat", "value"] <- 0

metabolic_flows[metabolic_flows$scenario=="Design case (min. water)" & metabolic_flows$Flow=="exports" & metabolic_flows$resource=="gasNatural", "value"] <- 0

metabolic_flows[metabolic_flows$scenario=="Design case (min. emissions)" & metabolic_flows$Flow=="exports" & metabolic_flows$resource=="gasNatural", "value"] <- 0

metabolic_flows[metabolic_flows$scenario=="Wildcard case (short)" & metabolic_flows$Flow=="exports" & metabolic_flows$resource=="waterNonPotable", "value"] <- 0

metabolic_flows[metabolic_flows$scenario=="Wildcard case (medium)" & metabolic_flows$Flow=="exports" & metabolic_flows$resource=="waterNonPotable", "value"] <- 0

metabolic_flows[metabolic_flows$scenario=="Wildcard case (long)" & metabolic_flows$Flow=="exports" & metabolic_flows$resource=="waterNonPotable", "value"] <- 0

metabolic_flows[metabolic_flows$scenario=="Design case (min. emissions)" & metabolic_flows$Flow=="exports" & metabolic_flows$resource=="water", "value"] <- 0

## Remove zero-valued entries
metabolic_flows <- filter(metabolic_flows, value!=0)

## Order the scenario names
metabolic_flows <- transform(metabolic_flows,
		 scenario=factor(scenario,
		   levels=c("Grid case (min. cost)",
			    "Design case (min. cost)", 
			    "Design case (min. emissions)", 
			    "Design case (min. waste)", 
			    "Design case (min. water)", 
			    "Wildcard case (current)", 
			    "Wildcard case (medium)", 
			    "Wildcard case (long)"),
		    ordered=TRUE))


## Rename the aggregate flows
metabolic_flows$Flow <- as.character(metabolic_flows$Flow)
metabolic_flows[metabolic_flows$Flow=="imports", "Flow"] <- "Aggregate metabolic inputs to the SPC site"
metabolic_flows[metabolic_flows$Flow=="exports", "Flow"] <- "Aggregate metabolic outputs from the SPC site"

## Rename the resources
metabolic_flows$resource <- as.character(metabolic_flows$resource)
metabolic_flows[metabolic_flows$resource=="algaeDry", "resource"] <- "Algae [kg/s]"
metabolic_flows[metabolic_flows$resource=="ash", "resource"] <- "Ash [kg/s]"
metabolic_flows[metabolic_flows$resource=="biomass", "resource"] <- "Biomass [kg/s]"
metabolic_flows[metabolic_flows$resource=="CO2", "resource"] <- "CO2 [kg/s]"
metabolic_flows[metabolic_flows$resource=="coal", "resource"] <- "Coal [kg/s]"
metabolic_flows[metabolic_flows$resource=="cool", "resource"] <- "Cooling [MW]"
metabolic_flows[metabolic_flows$resource=="digestate", "resource"] <- "Digestate [kg/s]"
metabolic_flows[metabolic_flows$resource=="elec", "resource"] <- "Electricity [MW]"
metabolic_flows[metabolic_flows$resource=="gasNatural", "resource"] <- "Natural gas [kg/s]"
metabolic_flows[metabolic_flows$resource=="gasoline", "resource"] <- "Gasoline [kg/s]"
metabolic_flows[metabolic_flows$resource=="groundWater", "resource"] <- "Groundwater [kg/s]"
metabolic_flows[metabolic_flows$resource=="heat", "resource"] <- "Heat [MW]"
metabolic_flows[metabolic_flows$resource=="methane", "resource"] <- "Methane [kg/s]"
metabolic_flows[metabolic_flows$resource=="waste", "resource"] <- "Solid waste [kg/s]"
metabolic_flows[metabolic_flows$resource=="wastewater", "resource"] <- "Wastewater [kg/s]"
metabolic_flows[metabolic_flows$resource=="water", "resource"] <- "Water [kg/s]"
metabolic_flows[metabolic_flows$resource=="water_pure", "resource"] <- "Water (purified) [kg/s]"
metabolic_flows[metabolic_flows$resource=="waterNonPotable", "resource"] <- "Water (non-potable) [kg/s]"
metabolic_flows[metabolic_flows$resource=="waterPotable", "resource"] <- "Water (potable) [kg/s]"

## Rename the seasons
metabolic_flows$season <- as.character(metabolic_flows$season)
metabolic_flows[metabolic_flows$season=="sum", "season"] <- "Summer"
metabolic_flows[metabolic_flows$season=="wint", "season"] <- "Winter"
metabolic_flows[metabolic_flows$season=="shoulder", "season"] <- "Shoulder"

## Remove the minimum water scenario
metabolic_flows <- filter(metabolic_flows, scenario!="Design case (min. water)")

#plot_metabolic_flows <- ggplot(metabolic_flows, aes(resource, scenario)) +
#  geom_point(aes(colour=season, size=value), position=position_dodge(width=0.8)) +
#  facet_wrap(~Flow, ncol=1) +
#  labs(colour="Season") +
#  labs(size="Flow rate value") +
#  theme_bw() +
#  theme(axis.text.x=element_text(hjust=1, angle=30, size=6.5),
#  	axis.text.y=element_text(hjust=1, angle=30, size=6.5),
#	axis.title=element_blank(),
#	panel.grid.major.x = element_blank(),
#	axis.ticks.x = element_blank(),
#	panel.grid.minor = element_blank()) +
#  geom_vline(xintercept=seq(1.5, length(unique(metabolic_flows$resource))-0.5, 1), lwd=0.25, colour="grey")
#plot_metabolic_flows

```

\begin{landscape}
\begin{figure}[htbp]
\centering
\includegraphics{figures/metabolic_flows-1.pdf}
\caption{Metabolic flows into and out of the SPC
site.\label{fig:metabolic-flows}}
\end{figure}
\end{landscape}




```{r summarise_metabolisms, fig.height=7, fig.width=5.5, fig.cap="Making more processes available results in the model choosing more management processes and a more diverse mix of aggregate metabolic flows into and out of the SPC site.\\label{fig:metabolism_summary}"}
## Summarise aggregate metabolic flows

flows_summary <- metabolic_flows %>% distinct(scenario, resource) %>% select(scenario, resource) %>% group_by(scenario) %>% summarise(Value = n())
flows_summary$variable <- "Number of resources in aggregate metabolic flows"

## Summarise numbers of processes
process_mix <- read.csv("06_case-study/process_mix.csv")
process_mix <- filter(process_mix, number>0 & rate>0)

process_mix$season <- as.character(process_mix$season)
process_mix[process_mix$season=="sum", "season"] <- "Summer"
process_mix[process_mix$season=="wint", "season"] <- "Winter"
process_mix[process_mix$season=="shoulder", "season"] <- "Shoulder"

processes_by_scenario <- process_mix %>% distinct(scenario, process) %>% select(scenario, process) %>% group_by(scenario) 

process_summary <- processes_by_scenario %>% summarise(Value = n())

process_summary$variable <- "Number of resource management processes used"


## Combine data
count_summary <- rbind(flows_summary, process_summary)

plot_count_summary <- ggplot(count_summary, aes(Value, scenario)) +
  geom_point() +
  facet_wrap(~variable, ncol=1, scales="free") +
  theme_bw() +
  theme(axis.title=element_blank())
plot_count_summary

## Processes common to each wildcard scenario
wildcard_common <- processes_by_scenario %>% group_by(process) %>% summarise(count = n()) %>% filter(count==3)


```

<!--
```{r process_mix, fig.height=7, fig.width=6.5, results="asis"}

process_mix <- read.csv("06_case-study/process_mix.csv")

## Remove zero-valued entries
process_mix <- filter(process_mix, rate!=0)

## Calculate total capacity (rate * number)

process_mix$total_capacity <- process_mix$rate * process_mix$number

## Order the scenario names
process_mix <- transform(process_mix,
		 scenario=factor(scenario,
		   levels=c("Grid case (min. cost)",
			    "Design case (min. cost)", 
			    "Design case (min. emissions)", 
			    "Design case (min. waste)", 
			    "Design case (min. water)", 
			    "Wildcard case (current)", 
			    "Wildcard case (medium)", 
			    "Wildcard case (long)"),
		    ordered=TRUE))



plot_process_mix <- ggplot(process_mix, aes(zone, process)) +
  geom_tile(fill="white", colour="black") +
  geom_text(aes(label=paste("R=", rate, "\n", "N=", number)), size=2) +
  facet_wrap(~scenario, ncol=3) +
  theme_bw() +
  theme(axis.text.x=element_text(hjust=1, angle=30),
	axis.title=element_blank())
plot_process_mix

```
-->

The process networks for each scenario are visualised in Figures \ref{fig:designCase_minCost} to \ref{fig:wildcard_long} as SNA-style node-link graphs (undirected). Processes that transfer resources from one to another are connected by lines; the proximity of any pair of linked processes is proportional to the quantities of resources transferred. From this, it follows that the more central a process is to the plot, the more integral it is to the network because it is linked to more processes. Conversely, the closer a process is to the plot's fringe, the less that other processes depend on it. The processes have been coloured according to the management sector to which they belong[^sna-process-type] to help visualise the intersectoral interactions and synergies. Inputs, outputs and demands are also represented to show which processes import and export resources. In each scenario, the system middle differs according to the design objective and/or available processes. All scenarios are dominated by processes whose main function is to produce energy, but the networks nevertheless exhibit intersectoral interactions (such as the energy demands of water and wastewater treatment), and synergies (such as heat generated by the water-source heat pump) in the design Case scenarios (Figures \ref{fig:designCase_minCost}--\ref{fig:designCase_minWaste}). 

[^sna-process-type]: This is determined by the 'main' output of each process.


\begin{figure}[h!]
	\centering
	\includegraphics[width=0.75\textwidth]{06_case-study/SNA_designCase_minCost_tidy.pdf} 
	\caption{Process network for the design case (minimum cost) scenario. Colours indicate the management sector to which the processes belong (red = energy, blue = water, black = waste, and orange = imports or exports).} \label{fig:designCase_minCost}
\end{figure}

\begin{figure}[h!]
	\centering
	\includegraphics[width=0.75\textwidth]{06_case-study/SNA_designCase_minEmissions_tidy.pdf} 
	\caption{Process network for the design case (minimum emissions) scenario. Colours as for Figure \ref{fig:designCase_minCost}.} \label{fig:designCase_minEmissions}
\end{figure}

\begin{figure}[h!]
	\centering
	\includegraphics[width=0.75\textwidth]{06_case-study/SNA_designCase_minWaste_tidy.pdf} 
	\caption{Process network for the design case (minimum waste) scenario. Colours as for Figure \ref{fig:designCase_minCost}.} \label{fig:designCase_minWaste}
\end{figure}

<!--
\begin{figure}[h!]
	\centering
	\includegraphics[width=0.75\textwidth]{06_case-study/SNA_designCase_minWater.pdf} 
	\caption{Process network for the Design case (minimum water) scenario.} \label{fig:designCase_minWater}
\end{figure}
-->

\begin{figure}[h!]
	\centering
	\includegraphics[width=\textwidth]{06_case-study/SNA_wildcard_current_minCost_tidy.pdf} 
	\caption{Process network for the wildcard case (current) scenario.} \label{fig:wildcard_current}
\end{figure}

\begin{figure}[h!]
	\centering
	\includegraphics[width=\textwidth]{06_case-study/SNA_wildcard_medium_minCost_tidy.pdf} 
	\caption{Process network for the wildcard case (medium) scenario.} \label{fig:wildcard_medium}
\end{figure}

\begin{figure}[h!]
	\centering
	\includegraphics[width=\textwidth]{06_case-study/SNA_wildcard_long_minCost_tidy.pdf} 
	\caption{Process network for the wildcard case (long) scenario.} \label{fig:wildcard_long}
\end{figure}

#### Design Case scenarios
<!--
Relative to the Grid Case, the import requirements of the design scenarios are generally lower (slightly lower electricity and gas in general, and much lower summer electricity because of the use of absorption cooling rather than electrically-powered HVAC systems). There is also a different set of water imports, i.e. water for treatment on site, rather than water to arrive on site pretreated.
-->
 
The design case scenarios have up to twelve unique processes available to use, with each using a common set of seven processes: (1) water treatment plants, (2) wastewater treatment plants, (3) an anaerobic digestion facility (which generates gas from the organic fraction of waste), (4) ground-source heat pumps, (5) water-source heatpumps, and (6) absorption chillers, (7) heat exchangers (to deliver hot and cold water through a district heating network), and (8) electrically-powered HVAC systems (to provide cooling). In addition to these processes in common, the different objectives cause the selection of processes unique to each scenario. These differences are summarised in Table \ref{tab:design-case-differences}, and further explained below.

\begin{table}[]
\centering
\caption{The conversion processes unique to each design case scenario. A checkmark indicates that the technology was picked for a scenario.}
\label{tab:design-case-differences}
\begin{tabular}{lccccp{4cm}}
\toprule
Scenario & CHP & Boiler & HVAC (cooling) & Absorption heating & Comment                        \\
%\multirow{2}{*}{Scenario} & \multicolumn{4}{c}{Conversion processes not common to all Design Case scenarios}                        & \multirow{2}{*}{Comment on site's \\ aggregate metabolic flows}                       \\
%\cmidrule{2-5}
\midrule
Minimum cost              & \checkmark &            & \checkmark     & \checkmark         & Removes need for electricity imports, lowers gas imports, and lowers water imports \\
Minimum emissions         &            &            &                &                    & Greater electricity imports than the minimum cost scenario                         \\
Minimum waste             & \checkmark & \checkmark & \checkmark     & \checkmark         & No output of organic waste or wastewater                                          \\
\bottomrule
\end{tabular}
\end{table}

The minimum cost scenario keeps costs down by importing less electricity, natural gas and water than the other scenarios. Importing no electricity forces the site to generate its own with the CHP plant. Importing less gas means that PRaQ avoids choosing gas-fuelled boilers -- this means that heating is provided by electrically-powered HVAC systems, rather than district heating networks. The knock-on effect of this is that water imports are reduced, because water is not required to run the district heating network.

For the minimum emissions scenario, PRaQ avoids using CHP to meet electricity demand, or gas-fuelled boilers to meet demand for heating (both of these technologies burn fossil fuels). Instead, the system meets electricity demand by importing it directly from the grid, and meets heating demand by using electrically-powered heat pumps.

The minimum waste scenario minimises the site's waste output by sending organic waste to feed anaerobic fermentation. This generates natural gas which supplies the both CHP and boiler (which does not happen in the previous two scenarios). In addition, all the wastewater generated by the site is treated (which actually means the site produces more potable water than it needs). The site's heating and cooling needs are met via a district heating network and HVAC systems, which are fed by heat and electricity respectively. CHP produces both heat and electricity, though in summer and winter, the CHP's electricity output needs to be supplemented by imports -- note that this leads the minimum waste scenario's aggregate metabolic flows to exhibit seasonal variation (i.e. there are no electricity imports in shoulder season).
<!--
Thus, in summer, the additional use of anaerobic fermentation compared to the other Design case scenarios produces enough electricity to meet cooling demand.
-->

In summary, the results of the design case scenarios demonstrate that PRaQ meets design objectives by changing the network of processes in the middle of a system. These network engage in intersectoral interactions and synergies which in turn, affects the aggregate metabolic flows into and out of an area.
<!--
This confirms that optimisation modelling serves a purpose in providing insights on how to manage an area's metabolism.
-->

<!--
Note also that minimum waste and minimum water design the same system, though they operate slightly differently, for example, AD plays a greater role in the former case (resulting in exports of natural gas from the site). It also exports greater amounts of treated water, because it has not had constraints on how much untreated water can be imported.
-->


#### Wildcard scenarios

The wildcard scenarios each have the same objective of cost minimisation, and their optimised networks share 11 processes types in common[^wildcard-common] as well as processes unique to each scenario. The resulting networks exhibit intersectoral interactions and synergies, for example: waste gasification (a synergy between the waste and energy sectors), wastewater reuse (a synergy between the waste and water sectors), and groundwater pumping (an interaction between the energy and water sectors). As with the different process mixes drive variations in the overall metabolic flows -- in particular, these scenarios are less reliant on imports of electricity and natural gas than the design-case scenarios. The systems are more complicated than the design cases, so not all the differences can be explained here; the following examples, however, show how the middle of the system affects site's aggregate metabolic flows.

[^wildcard-common]: This 11 partly depends on how processes are categorised into types. The types in common are: central heating, CHP (gas-, biomass- and hydrogen-fuelled), air conditioning, evaporative cooling, absorption cooling, hydrogen generation waste gasification, groundwater pumping, heat exchanger networks, water treatment, and wastewater reuse treatment.

Aggregate inflows of coal and gasoline are a notable variation between the wildcard scenarios: the current scenario imports them in all three seasons, whereas the medium-term scenario imports them in the winter only, and the longterm scenario imports them in winter and summer. This is due to the presence of additional energy-generating processes in the medium- and long-term scenarios, which include heat pumps, fuel cells, anaerobic digestion and biodiesel generation, which make these scenarios less reliant on fossil fuels.
<!--
Non-potable water imports are greater in the medium-term scenario than for the current and long-term scenarios. The medium-term scenario has selected more processes which can treat water for recreational use, so can meet this demand via greater import quantities of non-potable water. This results in lower imports of recreational water in the current scenario, when compared to the medium-term scenario. However, the quantities of recreational water the long-term scenario imports compared to the medium is about the same. This is because the long-term scenario needs to import more water to feed the hydrogen-generating process (mentioned above).
-->

Other differences include the long-term scenario's inflow of algae (to feed a biodiesel generation process), the long-term scenario's outflow of ash (due to the presence of a coal-fuelled power plant) and methane (which is a by-product from the biodiesel generation mentioned above). Finally, solid waste outputs are lower in the medium-term scenario, and lower still in the long-term scenerio, due to the presence of digestion processes which are fed by the organic fraction of solid waste.
<!--
To summarise, the wildcard scenarios take advantage of the availability of more conversion processes in order to meet the objective of cost minimisation and result in systems -- which while complex -- still shows the that aggregate metabolic flows into and out of an area are sensitive to the process mix in the middle of a system, where there are all sorts of knock-on effects, between resource management sectors.
-->

In summary, the results of the wildcard-case scenarios support the findings of the design-case scenarios, by showing that PRaQ selects a network of processes which interact in such a way as to affect an area's aggregate metabolic flows.

<!--
and digestate (medium and longterm), and electricity (current only). [TODO: explain these differences with reference to the networks.] 
-->


<!--
### Other measures

It follows from this that an area's optimal networks are sensitive to the objective, seen also when different objectives are applied to the same process mix (e.g. 2a and 2b [TODO: update if necessary]). However, what is the effect of PRaQ's optimisation on other metrics?

[TODO: comment on the mix of technology sizes in various scenarios.]

[TODO: comment on which technogies are most relied upon in each system.]

[TODO: comment on transportation reliance (e.g. central import + distribution, or central import and conversion, etc.?]

[TODO: comment on coversion/transportation mix effect on (capital) costs?]

#### System costs

System cost is calculated as the sum of the processes (conversion and transport) and resource imports. These costs are calculated on an annual basis, assuming infrastructure has a ten year lifespan. This can be done using Equation \ref{eq:objective_cost}, $C = \gamma^R C^R + \gamma^P C^P + \gamma^{\tau} C^{\tau}$ with $\gamma^*$ taking values of 1, 0.1, and 0.1, respectively. Figure \ref{fig:system-costs} displays the system cost for those scenarios whose objective is to minimise cost (1, 2a, and 3a-c).

```{r costs, fig.height=5, fig.cap="fig:costs", results="asis"}

## Presentation costs
headlines$metrics <- as.character(headlines$metrics)
headlines[headlines$metrics=="headline_cost", "metrics"] <- "Cost [USD/year]"
headlines[headlines$metrics=="headline_emissions", "metrics"] <- "Emissions [million tons/year]"
headlines[headlines$metrics=="headline_waste", "metrics"] <- "Waste [million tons/year]"
headlines[headlines$metrics=="headline_water", "metrics"] <- "Water [million tons/year]"
system_costs <- filter(headlines, scenario %in% c("Grid case (min. cost)",
						  "Design case (min. cost)",
						  "Wildcard case (current)",
						  "Wildcard case (medium)",
						  "Wildcard case (long)"))

system_costs <- filter(system_costs, metrics=="Cost [USD/year]")

system_costs <- mutate(system_costs, values=values/1e6)

#plot_system_costs <- ggplot(system_costs, aes(scenario, values)) +
#  geom_point() +
#  xlab("Scenario") +
#  ylab("Annualised cost [millions USD]") +
#  theme_bw() +
#  theme(axis.text.x = element_text(hjust=1, angle=30))
#plot_system_costs
```

```{r component-costs, fig.height=5, fig.cap="System costs for scenarios where the objective function was to minimise cost.\\label{fig:system-costs}", results="asis"}
component_costs <- read.csv("06_case-study/component-costs.csv")
component_costs <- melt(component_costs, variable.name="Component")

## Presentation system component names
component_costs$"Component" <- as.character(component_costs$"Component")
component_costs[component_costs$"Component"=="Conversion.processes", "Component"] <- "Conversion processes"
component_costs[component_costs$"Component"=="Transport.processes", "Component"] <- "Transport processes"

## Presentation scenario names
component_costs$Scenario <- as.character(component_costs$Scenario)
component_costs[component_costs$Scenario=="gridCase_minCost", "Scenario"] <- "Grid case (min. cost)"
component_costs[component_costs$Scenario=="designCase_minCost", "Scenario"] <- "Design case (min. cost)"
component_costs[component_costs$Scenario=="designCase_minEmissions", "Scenario"] <- "Design case (min. emissions)"
component_costs[component_costs$Scenario=="designCase_minWaste", "Scenario"] <- "Design case (min. waste)"
component_costs[component_costs$Scenario=="designCase_minWater", "Scenario"] <- "Design case (min. water)"
component_costs[component_costs$Scenario=="wildcard_current_minCost", "Scenario"] <- "Wildcard case (current)"
component_costs[component_costs$Scenario=="wildcard_medium_minCost", "Scenario"] <- "Wildcard case (medium)"
component_costs[component_costs$Scenario=="wildcard_long_minCost", "Scenario"] <- "Wildcard case (long)"

## Order the scenario names
component_costs <- transform(component_costs,
		 Scenario=factor(Scenario,
		   levels=c("Grid case (min. cost)",
			    "Design case (min. cost)", 
			    "Design case (min. emissions)", 
			    "Design case (min. waste)", 
			    "Design case (min. water)", 
			    "Wildcard case (current)", 
			    "Wildcard case (medium)", 
			    "Wildcard case (long)"),
		    ordered=TRUE),
		Component=factor(Component,
				levels=c("Conversion processes",
					"Transport processes",
				       "Resources"),
			 ordered=TRUE))	 
			     
component_costs <- filter(component_costs, Scenario %in% c("Grid case (min. cost)",
						  "Design case (min. cost)",
						  "Wildcard case (current)",
						  "Wildcard case (medium)",
						  "Wildcard case (long)"))

component_costs_outlierRemoved <- filter(component_costs, Scenario!="Grid case (min. cost)")
component_costs$chart <- "System costs"
component_costs_outlierRemoved$chart <- "System costs (Grid case removed)"
component_costs <- rbind(component_costs, component_costs_outlierRemoved)

plot_component_costs <- ggplot(component_costs, aes(Scenario, value/1e6, fill=Component, order=Component)) +
  geom_bar(stat="identity") +
  facet_wrap(~ chart, scales="free") +
  labs(fill = "System component") +
  xlab("Scenario") +
  ylab("Annualised cost [millions USD]") +
  theme_bw() +
  theme(axis.text.x = element_text(hjust=1, angle=30))
plot_component_costs
```

The grid case is fixed such that its costs consist entirely of resources, and is very expensive because of the premium for importing a resource. However, the design case and wildcard case show much lower costs, with the wildcard cases coming out the cheapest, because of having a larger set of conversion process to choose from.

<!--
#### Other headline results

Emissions, water footprint and waste output are calculated on an annual basis, using the general equation [TODO: write and reference an emissions equation], with the following conditions:

- $r = \mbox{\CO2}$
- $r \in S^{water}$
- $r \in S^{waste}$

(Provide footnotes to define the water and waste sets.)

The headline results are given in Figure \ref{fig:headlines}. The results show:

- That when cost is the minimum objective -- the case for all scenarios with the exception of three of the design cases -- that low costs can indeed be achieved.
- Looking at each of the design cases, they each successfully minimise the quantity of interest to zero, and in fact manage to do while other quantities go to zero.
- However there is an exception to this, which reveals a clear tradeoff: for example, that minimum waste design case results in a large water consumption.
- The wildcard cases improve performance the longer the more processes they consider.
- Second, we consider each system's emissions from the processes (though it is beyond the scope of this study to trace emissions up the supply chain) (Figure [TODO: cross-ref]).
-->

<!--
($\sum_{pz} C^P_p N^P_p + \sum{\tau zz'} C^{\tau}_{\tau} \delta_{\tau zz'} l_zz'$, emissions, waste output and water footprint.
-->

<!--
```{r other-headlines, fig.height=5, fig.cap="fig:costs", results="asis"}
headlines <- filter(headlines, metrics!="Cost [USD/year]")

## Just for the design case

headlines <- filter(headlines, scenario %in% c("Design case (min. cost)",
					       "Design case (min. emissions)",
					       "Design case (min. water)",
					       "Design case (min. waste)"))

plot_headlines <- ggplot(headlines, aes(scenario, values/1e9)) +
  geom_point() +
  facet_wrap(~metrics, ncol=1, scales="free_y") +
  theme_bw() +
  theme(axis.text.x = element_text(hjust=1, angle=30))
plot_headlines
```
-->

### System designs and grey-box metrics {#sec:spc-grey}

The aggregate metabolic flows and costs considered above are black-box metrics \ref{sec:black-grey-box}. The results show how these metrics or metabolic flows are affected by the mix of management processes (as hypothesised throughout this thesis). However, Chapter \ref{sec:metrics} showed that the so-called grey-box metrics of exergy analysis and ENA can further understanding an area's use of resources, by delving into the details of process mixes and their governance.

#### Exergy analysis

Chapter \ref{sec:metrics} showed exergy analysis to be useful because it did not disqualify any type of resource from it's study, and made therefore made it possible to quantify the efficiency of any type of processes, and hence a system as a whole (Section\ref{sec:app-grey-box-metrics}). Here, exergy analysis is carried out for each scenario, using a simplified version of the method described in Section \ref{sec:methods-grey-box} in which system exergy efficiency is calculated as $\eta_{ex}=\alpha^{prod}_{ex}/\alpha^{in}_{ex}$ (Equation \eqref{eq:ex-eff}), where $\alpha^{prod}_{ex}$ are the system demands, and $\alpha^{in}_{ex}$ are the site's aggregate metabolic inflows. The results of exergy analysis for each minimum-cost scenario are given in Table \ref{tab:SPC-exergy} -- this has been limited to the minimum-cost scenarios because these all have the same objective functions, which means they can be fairly compared according to the same metric. Further details are provided in Appendix \ref{sec:spc-app-exergy}.


```{r exergy, fig.height=5, fig.cap="fig:exergy", results="asis"}

## Exergy efficiency analysis

library(xtable)
exergy <- read.csv("06_case-study/exergy.csv")
exergy <- exergy[-c(3,4) ,-2]
exergy[, 3] <- round(exergy[, 3], 0)

#ex_prod <- exergy$prod[1]
#
### Presentation scenario names
#exergy$scenario <- as.character(exergy$scenario)
#exergy[exergy$scenario=="gridCase_minCost", "scenario"] <- "Grid case (min. cost)"
#exergy[exergy$scenario=="designCase_minCost", "scenario"] <- "Design case (min. cost)"
#exergy[exergy$scenario=="designCase_minEmissions", "scenario"] <- "Design case (min. emissions)"
#exergy[exergy$scenario=="designCase_minWaste", "scenario"] <- "Design case (min. waste)"
#exergy[exergy$scenario=="designCase_minWater", "scenario"] <- "Design case (min. water)"
#exergy[exergy$scenario=="wildcard_current_minCost", "scenario"] <- "Wildcard case (current)"
#exergy[exergy$scenario=="wildcard_medium_minCost", "scenario"] <- "Wildcard case (medium)"
#exergy[exergy$scenario=="wildcard_long_minCost", "scenario"] <- "Wildcard case (long)"

#exergy <- select(exergy, scenario, in., waste, irrev, eff)
names(exergy) <- c("Scenario", "$\\alpha^{in}_{ex}$ [MW]", "$\\eta_{ex}$ [per cent]")

tab.exergy.tex <- xtable(exergy,
			  caption="Results of exergy analysis for each of the minimum cost scenarios; $\\alpha^{prod}_{ex} = 47$ MW for each scenario.\\label{tab:SPC-exergy}", digits=c(0,0,0,0),
			  align="llll")

print(tab.exergy.tex,
##      size='\\small',
      table.placement='htbp!',
      include.rownames=FALSE,
      sanitize.text.function=identity,
      comment = FALSE)
```


The results show that exergy efficiency is sensitive to the designed network. The baseline case, has the lowest efficiency, which is mainly driven by the high electricity imports required to meet demand for electricity (both for end-use, and to power HVAC systems). The grid case does not allow these demands to be met by the by-products of other processes, and hence the system's exergy efficiency is low. The design case and wildcard cases benefit from synergies (such as CHP, which allows both electricity and heating to be derived from coal imports, and gasification, which generates energy from waste). This enables these cases to achieve higher exergy efficiencies.

#### Ecological network analysis

Section \ref{sec:app-grey-box-metrics} showed how ecological network analysis (ENA) reveals how city's resource-management sectors work together. The results of ENA will quantify the extent to which a system exhibits intersectoral synergies and interactions by computing the degree of network mutualism. The results of this analysis is given in Table \ref{tab:SPC-ENA} the minimum cost scenarios (with the exception of the baseline scenario, which, by design, has no network mutualism). This shows that network mutualism exists in all cases, but is higher in the wildcard cases -- networks with more processes tend to have more intersectoral interactions. This result is in line with this thesis' hypothesis -- namely that intersectoral synergies bring metabolic efficiency. However, it also shows the need for the agents who manage each sector to work together, and also highlights the risk of system vulnerability -- if one sub-system (e.g. the energy sector) fails, then the rest of the system may go down with it.

<!--
(). Using the method outlined in Section \ref{sec:methods-grey-box},give an overall mutualism index can be computed which quantifies the overall degree of network mutualism [@Zhang2009b]\footnote{$\mbox{Network mutualism} = \frac{\sum \max(\sign(u_{ij}), 0)}{\sum \min(- \sign (u_{ij}), 0)}$} -- 

 computations on the integral utility matrix (whose elements quantify the combined direct and indirect exergy contributions between any pair of compartments) 

The results of this type of analysis are important, because they indicate to planners the extent to which the different management parties rely on one another, and hence where they need to cooperate, and where there are risks/vulnerabilities if there is no high-level understanding of intersectoral dependency 
-->


```{r ena, fig.height=5, fig.cap="fig:ena", results="asis"}

ena <- read.csv("06_case-study/ENA.csv")

## Presentation scenario names
ena$scenario <- as.character(ena$scenario)
ena[ena$scenario=="gridCase_minCost", "scenario"] <- "Grid case (min. cost)"
ena[ena$scenario=="designCase_minCost", "scenario"] <- "Design case (min. cost)"
ena[ena$scenario=="designCase_minEmissions", "scenario"] <- "Design case (min. emissions)"
ena[ena$scenario=="designCase_minWaste", "scenario"] <- "Design case (min. waste)"
ena[ena$scenario=="designCase_minWater", "scenario"] <- "Design case (min. water)"
ena[ena$scenario=="wildcard_current_minCost", "scenario"] <- "Wildcard case (current)"
ena[ena$scenario=="wildcard_medium_minCost", "scenario"] <- "Wildcard case (medium)"
ena[ena$scenario=="wildcard_long_minCost", "scenario"] <- "Wildcard case (long)"

names(ena) <- c("Scenario", "Direct network mutualism", "Network mutualism")

ena <- filter(ena, Scenario!="Design case (min. water)")
ena <- ena[-c(3,4), -2]

tab.ena.tex <- xtable(ena,
			  caption="Network mutualism for SPC scenarios calculated from the Indirect utility matrix. \\label{tab:SPC-ENA}",
			  align="lll")

print(tab.ena.tex,
##      size='\\small',
      table.placement='htbp!',
      include.rownames=FALSE,
      sanitize.text.function=identity,
      comment = FALSE)
```

```{r ena-matrices, fig.height=7, fig.cap="fig:ena", results="asis"}

ena_matrices <- read.csv("06_case-study/ena-matrices.csv")


ena_matrices <- transform(ena_matrices,
		       Sign=factor(Sign, levels=c(-1,0,1),
				    labels=c("-","0","+")))

## Presentation scenario names
ena_matrices$Scenario <- as.character(ena_matrices$Scenario)
ena_matrices[ena_matrices$Scenario=="designCase_minCost", "Scenario"] <- "Design case (min. cost)"
ena_matrices[ena_matrices$Scenario=="designCase_minEmissions", "Scenario"] <- "Design case (min. emissions)"
ena_matrices[ena_matrices$Scenario=="designCase_minWaste", "Scenario"] <- "Design case (min. waste)"
ena_matrices[ena_matrices$Scenario=="designCase_minWater", "Scenario"] <- "Design case (min. water)"
ena_matrices[ena_matrices$Scenario=="wildcard_current_minCost", "Scenario"] <- "Wildcard case (current)"
ena_matrices[ena_matrices$Scenario=="wildcard_medium_minCost", "Scenario"] <- "Wildcard case (medium)"
ena_matrices[ena_matrices$Scenario=="wildcard_long_minCost", "Scenario"] <- "Wildcard case (long)"

plot_ENA <- ggplot(ena_matrices, aes(From, To)) +
  geom_tile(fill=NA, color="black", na.value=NA) +
  geom_text(aes(label=Sign), size=3) +
  facet_grid(Scenario~Matrix) +
  theme_bw() +
  theme(axis.text.x = element_text(angle=30, hjust=1))
#plot_ENA
```

## Summary and conclusions

This chapter has demonstrated how to apply the PRaQ model to the SPC site using its seasonally and spatially disaggregated demands to design highly integrated urban resource management systems. The analysis of the results uses the principles of Chapter \ref{sec:metrics} to quantify the ways in which a mix of resource-management processes affects the site's metabolism. Alongside the PRaQ modelling itself, this chapter has described and applied a rule-of-thumb method to estimate the costs of processes, taking into account economies of scale, even for conversion process which are still only in a research-and-development stage.

For the SPC site specifically, the PRaQ modelling justifies the planners' decision to integrate resource management systems. The modelling of the design-case scenarios show the SPC's proposals to use integrated energy management and a water-reuse project (Figure \ref{fig:shanngu-network}) are an improvement over direct imports of resources and exports of wastes of the baseline case. The wildcard scenarios challenge the planners to consider a more complicated network of processes which is less reliant on imports electricity and natural gas, and has a greater exergy efficiency and network mutualism.

More generally, this chapter contributes to fulfilling aim 3 of this thesis' research question (Section \ref{sec:research-qn}), by showing that an area's metabolic flows (at the top of a system) are indeed affected by the mix of processes (in the middle of the system), whether this process mix varies due to design objectives (as in the design cases), or process availability (as in the wildcard cases). The case study shows that the synergies which drive high exergy efficiency and network mutualism can be achieved through larger and more varied networks of processes (as in the wildcard cases). This demonstrates the power of PRaQ's, which can propose networks too complicated to design without such a model, and enables consideration of ever-increasing number of resource-management technologies.

## Further work for the SPC case study {#sec:case-study-further-work}

Section \ref{sec:formulation-developments} suggested developments to the PRaQ formulation, all of which could have implications for the SPC study (for example, the inclusion of storage processes). However, even without making changes to the formulation, there are several areas of further work, which could provided further useful insights for the SPC site:

- *Parameters.* Currently, the system costs are very rough -- these could be refined, for example, taking into account local prices, exchanges rates, and purchasing power parities.
- *Processes.* It may be possible to rule out some processes as not available or feasible for the SPC. On the other hand, the SPC decision makers may know of processes not currently in Chapter 4's database which could be included. 
- *Temporal resolution.* It is possible the networks designed in this chapter are incorrectly sizing processes. For the sake of exploratory early-stage planning, this case study has disaggregated seasonal demands to a single per-second value, however, in reality demands will vary throughout the day, which means the process operation rates will also vary. It would therefore be useful to run PRaQ at finer temporal resolutions (as briefly discussed in Section \ref{sec:case-study-times}). The simplest way to consider operation is to split demand into two periods, average and peak (though finer resolutions could also be chosen). By taking into account demand variation within a day, it will be possible to more appropriately size the system's conversion processes, and thereby investigate networks which are plausible at an operational level (and not just for exploratory planning). This would require more detailed resource demand management data. Increasing temporal resolution would have a computational cost (Section \ref{sec:tat-results}), so this might happen after a technology mix has been chosen, so the technology choice variables can be fixed. 
- *Objectives.* Another area of further work is to alter the objective function. Examples include incorporating revenue from the selling of exports (this would increase exergy efficiency as waste exergies are re-defined as useful products, $Ex_p^{prod}$). Other alterations to the objective could be to include environmental taxes on carbon dioxide emissions.
- *Sensitivity analysis.* This case study has shown how a system's middle and its metabolic flows responds to different objectives and the available set of conversion processes. However, further sensitivity analysis could show how a system responds to changing demands (for example, to investigate the effect of population growth, changing consumer behaviour, etc.), the cost of resources, and the cost of processes. It would be particularly interesting to study a system's resiliance; i.e. how much change it can bear before it becomes over-reliant on importing resources, no longer achieving the metabolic efficiency objectives intended.

<!--
Note however that the model is nevertheless discerning: given 300 [TODO: accurate number] processes to choose from, it selects only [TODO: number] for the wildcard scenarios. Thus the PRaQ model successfully and intelligently optimizes the process mix.
-->

<!--
Paragraph ideas from JK's MILP paper
# Conclusions

- "There have been many models developed...however..."
- "In this paper we..."
- "Another feature of the model..."
- "The model was illustrated using..."
- "There are a number of future directions for the model..."
-->
